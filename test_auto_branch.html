<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åˆ†æ”¯èŠ‚ç‚¹åˆ›å»ºæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .choice-item { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 3px; }
        .node-preview { background: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .branch-node { background: #fff3cd; border-left-color: #ffc107; }
        .json-preview { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸŒ³ è‡ªåŠ¨åˆ†æ”¯èŠ‚ç‚¹åˆ›å»ºæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“ æ­¥éª¤1: ç™»å½•è´¦æˆ·</h2>
        <p>å¯ä»¥ä½¿ç”¨æµ‹è¯•è´¦æˆ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä½ è‡ªå·±çš„è´¦æˆ·</p>
        <input type="email" id="loginEmail" placeholder="é‚®ç®±" value="">
        <input type="password" id="loginPassword" placeholder="å¯†ç " value="">
        <button onclick="login()">ç™»å½•</button>
        <button onclick="checkExistingLogin()">æ£€æŸ¥ç°æœ‰ç™»å½•çŠ¶æ€</button>
        <div id="loginResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“š æ­¥éª¤2: åˆ›å»ºæµ‹è¯•æ•…äº‹</h2>
        <input type="text" id="storyTitle" placeholder="æ•…äº‹æ ‡é¢˜" value="è‡ªåŠ¨åˆ†æ”¯æµ‹è¯•æ•…äº‹">
        <button onclick="createStory()">åˆ›å»ºæ•…äº‹</button>
        <div id="storyResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ æ­¥éª¤3: é…ç½®èŠ‚ç‚¹å’Œè‡ªåŠ¨åˆ†æ”¯</h2>
        <div>
            <h3>ä¸»èŠ‚ç‚¹é…ç½®</h3>
            <input type="text" id="mainNodeTitle" placeholder="ä¸»èŠ‚ç‚¹æ ‡é¢˜" value="å…³é”®å†³ç­–ç‚¹">
            <textarea id="mainNodeContent" placeholder="ä¸»èŠ‚ç‚¹å†…å®¹" rows="3">ä½ æ¥åˆ°äº†ä¸€ä¸ªé‡è¦çš„åå­—è·¯å£...</textarea>
        </div>
        
        <div>
            <h3>åˆ†æ”¯é€‰é¡¹é…ç½®</h3>
            <div id="choicesContainer">
                <div class="choice-item">
                    <input type="checkbox" id="autoCreate1" checked> è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯èŠ‚ç‚¹
                    <input type="text" id="choice1" placeholder="é€‰é¡¹1" value="å‘å·¦æ¢ç´¢">
                </div>
                <div class="choice-item">
                    <input type="checkbox" id="autoCreate2" checked> è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯èŠ‚ç‚¹
                    <input type="text" id="choice2" placeholder="é€‰é¡¹2" value="å‘å³å‰è¿›">
                </div>
                <div class="choice-item">
                    <input type="checkbox" id="autoCreate3"> è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯èŠ‚ç‚¹
                    <input type="text" id="choice3" placeholder="é€‰é¡¹3" value="åŸåœ°ç­‰å¾…">
                </div>
            </div>
        </div>
        
        <button onclick="saveWithAutoBranches()">ä¿å­˜èŠ‚ç‚¹å¹¶è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯</button>
        <div id="saveResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æ­¥éª¤4: æŸ¥çœ‹åˆ›å»ºç»“æœ</h2>
        <button onclick="viewStoryTree()">æŸ¥çœ‹å®Œæ•´æ•…äº‹æ ‘</button>
        <div id="treeResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ” æ­¥éª¤5: èŠ‚ç‚¹æ•°æ®é¢„è§ˆ</h2>
        <button onclick="previewNodeData()">é¢„è§ˆå°†è¦ä¿å­˜çš„æ•°æ®</button>
        <div id="previewResult" class="result"></div>
    </div>

    <script>
        let authToken = null;
        let currentStoryId = null;

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        // è·å–token
        function getToken() {
            return authToken || localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        // æ£€æŸ¥ç°æœ‰ç™»å½•çŠ¶æ€
        async function checkExistingLogin() {
            const token = getToken();
            if (token) {
                try {
                    const response = await fetch('/api/v1/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        authToken = token;
                        showResult('loginResult', `âœ… å·²ç™»å½•ï¼ç”¨æˆ·: ${result.data.username} (${result.data.email})`);
                        return true;
                    } else {
                        localStorage.removeItem('token');
                        sessionStorage.removeItem('token');
                        showResult('loginResult', 'âŒ ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', false);
                        return false;
                    }
                } catch (error) {
                    showResult('loginResult', 'âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥', false);
                    return false;
                }
            } else {
                showResult('loginResult', 'âŒ æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•', false);
                return false;
            }
        }

        // ç™»å½•
        async function login() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                if (response.ok) {
                    authToken = result.data.token;
                    localStorage.setItem('token', authToken);
                    showResult('loginResult', `âœ… ç™»å½•æˆåŠŸï¼ç”¨æˆ·: ${result.data.user.username}`);
                } else {
                    showResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${result.message}`, false);
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // åˆ›å»ºæ•…äº‹
        async function createStory() {
            try {
                const title = document.getElementById('storyTitle').value;
                const response = await fetch('/api/v1/stories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        description: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ†æ”¯åŠŸèƒ½æµ‹è¯•æ•…äº‹'
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    currentStoryId = result.data._id;
                    showResult('storyResult', `âœ… æ•…äº‹åˆ›å»ºæˆåŠŸï¼ID: ${currentStoryId}`);
                } else {
                    showResult('storyResult', `âŒ åˆ›å»ºå¤±è´¥: ${result.message}`, false);
                }
            } catch (error) {
                showResult('storyResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // ç”Ÿæˆä¸´æ—¶ID
        function generateTempId() {
            return 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // é¢„è§ˆèŠ‚ç‚¹æ•°æ®
        function previewNodeData() {
            const mainNodeTitle = document.getElementById('mainNodeTitle').value;
            const mainNodeContent = document.getElementById('mainNodeContent').value;
            
            const choices = [];
            for (let i = 1; i <= 3; i++) {
                const choiceText = document.getElementById(`choice${i}`).value;
                const autoCreate = document.getElementById(`autoCreate${i}`).checked;
                
                if (choiceText) {
                    choices.push({
                        id: generateTempId(),
                        text: choiceText,
                        autoCreate: autoCreate
                    });
                }
            }

            const nodeData = {
                tempId: generateTempId(),
                title: mainNodeTitle,
                content: mainNodeContent,
                type: 'choice',
                choices: choices,
                position: { x: 100, y: 100 }
            };

            const preview = `
                <div class="node-preview">
                    <strong>ä¸»èŠ‚ç‚¹ï¼š</strong><br>
                    æ ‡é¢˜: ${nodeData.title}<br>
                    ç±»å‹: ${nodeData.type}<br>
                    é€‰é¡¹æ•°é‡: ${nodeData.choices.length}
                </div>
                
                <div class="json-preview">
${JSON.stringify(nodeData, null, 2)}
                </div>
            `;

            showResult('previewResult', preview);
        }

        // ä¿å­˜èŠ‚ç‚¹å¹¶è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯
        async function saveWithAutoBranches() {
            if (!currentStoryId) {
                showResult('saveResult', 'âŒ è¯·å…ˆåˆ›å»ºæ•…äº‹', false);
                return;
            }

            try {
                const mainNodeTitle = document.getElementById('mainNodeTitle').value;
                const mainNodeContent = document.getElementById('mainNodeContent').value;
                
                const choices = [];
                for (let i = 1; i <= 3; i++) {
                    const choiceText = document.getElementById(`choice${i}`).value;
                    const autoCreate = document.getElementById(`autoCreate${i}`).checked;
                    
                    if (choiceText) {
                        choices.push({
                            id: generateTempId(),
                            text: choiceText,
                            autoCreate: autoCreate
                        });
                    }
                }

                const nodeData = {
                    tempId: generateTempId(),
                    title: mainNodeTitle,
                    content: mainNodeContent,
                    type: 'choice',
                    choices: choices,
                    position: { x: 100, y: 100 }
                };

                const response = await fetch(`/api/v1/stories/${currentStoryId}/nodes/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        nodes: [nodeData]
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    let resultHtml = '<div class="success">âœ… èŠ‚ç‚¹ä¿å­˜æˆåŠŸï¼</div>';
                    
                    // åˆ†æåˆ›å»ºçš„èŠ‚ç‚¹
                    const createdNodes = result.data;
                    const mainNode = createdNodes.find(n => n.type === 'choice');
                    const branchNodes = createdNodes.filter(n => n.type === 'branch');
                    
                    if (mainNode) {
                        resultHtml += `
                            <div class="node-preview">
                                <strong>ä¸»èŠ‚ç‚¹åˆ›å»ºæˆåŠŸï¼š</strong><br>
                                ID: ${mainNode._id}<br>
                                æ ‡é¢˜: ${mainNode.title}<br>
                                é€‰é¡¹æ•°é‡: ${mainNode.choices.length}
                            </div>
                        `;
                    }
                    
                    if (branchNodes.length > 0) {
                        resultHtml += `
                            <div class="node-preview branch-node">
                                <strong>è‡ªåŠ¨åˆ›å»ºçš„åˆ†æ”¯èŠ‚ç‚¹ï¼š</strong><br>
                                æ•°é‡: ${branchNodes.length}<br>
                                ${branchNodes.map(node => `- ${node.title} (ID: ${node._id})`).join('<br>')}
                            </div>
                        `;
                    }
                    
                    showResult('saveResult', resultHtml);
                } else {
                    showResult('saveResult', `âŒ ä¿å­˜å¤±è´¥: ${result.message}`, false);
                }
            } catch (error) {
                showResult('saveResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // æŸ¥çœ‹æ•…äº‹æ ‘
        async function viewStoryTree() {
            if (!currentStoryId) {
                showResult('treeResult', 'âŒ è¯·å…ˆåˆ›å»ºæ•…äº‹', false);
                return;
            }

            try {
                const response = await fetch(`/api/v1/stories/${currentStoryId}/tree`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    showResult('treeResult', `
                        <strong>âœ… å®Œæ•´æ•…äº‹æ ‘ç»“æ„ï¼š</strong><br>
                        <div class="json-preview">${JSON.stringify(result.data, null, 2)}</div>
                    `);
                } else {
                    showResult('treeResult', `âŒ è·å–å¤±è´¥: ${result.message}`, false);
                }
            } catch (error) {
                showResult('treeResult', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            checkExistingLogin();
        };
    </script>
</body>
</html>