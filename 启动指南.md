# Story-Platform 启动指南

## 前置要求

1. **Node.js** (建议 v16 或更高版本)
2. **MongoDB** 数据库（本地安装或使用 MongoDB Atlas 云服务）
3. **npm** 或 **yarn** 包管理器

## 快速启动步骤

### 第一步：安装后端依赖

**重要：必须先执行此步骤，否则无法启动项目！**

```bash
cd backend
npm install
```

**安装时间：** 通常需要 1-3 分钟，取决于网络速度。

**成功标志：** 看到类似以下信息表示安装成功：
```
added 234 packages in 2m
```

**注意：** 如果看到 `node_modules` 文件夹生成，说明依赖安装成功。

### 第二步：配置环境变量

在 `backend` 目录下创建 `.env` 文件，内容如下：

```env
# MongoDB 数据库连接地址
MONGODB_URI=mongodb://localhost:27017/story-platform

# JWT 密钥（请修改为随机字符串）
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-this-in-production

# Token 过期时间
JWT_EXPIRES_IN=1d
JWT_REFRESH_EXPIRES_IN=7d

# 服务器端口（可选，默认 5000）
PORT=5000

# 客户端地址（可选，用于 CORS）
CLIENT_ORIGIN=http://localhost:3000,http://127.0.0.1:5500

# 环境（development/production）
NODE_ENV=development
```

**重要提示：**
- 如果使用本地 MongoDB，确保 MongoDB 服务已启动
- 如果使用 MongoDB Atlas，将连接字符串替换为你的云数据库地址
- JWT_SECRET 和 JWT_REFRESH_SECRET 请修改为安全的随机字符串

### 第三步：启动 MongoDB（如果使用本地数据库）

**Windows:**
```bash
# 方法一：以管理员身份运行命令提示符或 PowerShell
# 1. 按 Win + X，选择"Windows PowerShell (管理员)"或"命令提示符 (管理员)"
# 2. 然后运行：
net start MongoDB

# 方法二：检查 MongoDB 服务状态
# 1. 按 Win + R，输入 services.msc，回车
# 2. 找到 "MongoDB" 服务
# 3. 右键点击，选择"启动"

# 注意：如果显示"系统错误 5 - 拒绝访问"，说明需要管理员权限
```

**macOS/Linux:**
```bash
# 使用 Homebrew 安装的 MongoDB
brew services start mongodb-community

# 或使用 systemd
sudo systemctl start mongod
```

### 第四步：启动后端服务器

在 `backend` 目录下运行：

```bash
# 开发模式（自动重启）
npm run dev

# 或生产模式
npm start
```

看到以下信息表示启动成功：
```
🚀 服务运行在 http://localhost:5000/api/v1
```

### 第五步：打开前端页面

前端是纯 HTML 文件，有两种方式打开：

#### 方式一：直接打开（简单但不推荐）
- 直接用浏览器打开 `front/index.html`
- ⚠️ 注意：这种方式可能无法正常调用 API（CORS 问题）

#### 方式二：使用本地服务器（推荐）

**使用 VS Code Live Server：**
1. 在 VS Code 中安装 "Live Server" 扩展
2. 右键点击 `front/index.html`
3. 选择 "Open with Live Server"
4. 浏览器会自动打开，地址通常是 `http://127.0.0.1:5500/front/index.html`

**使用 Python 简单服务器：**
```bash
cd front
# Python 3
python -m http.server 8000
# 或 Python 2
python -m SimpleHTTPServer 8000
```
然后访问：`http://localhost:8000/index.html`

**使用 Node.js http-server：**
```bash
# 全局安装
npm install -g http-server

# 在 front 目录运行
cd front
http-server -p 8000
```
然后访问：`http://localhost:8000/index.html`

## 访问地址

- **前端首页：** `http://localhost:8000/index.html`（根据你使用的服务器端口）
- **后端 API：** `http://localhost:5000/api/v1`
- **API 健康检查：** `http://localhost:5000/healthz`

## 测试 API 是否正常

在浏览器中访问：
```
http://localhost:5000/api/v1
```

应该看到 API 信息 JSON 响应。

## 常见问题

### 1. MongoDB 连接失败

**错误信息：** `Missing required environment variable: MONGODB_URI`

**解决方法：**
- 检查 `.env` 文件是否存在
- 检查 `MONGODB_URI` 是否正确
- 确保 MongoDB 服务已启动

### 1.1 MongoDB 启动权限错误（Windows）

**错误信息：** `发生系统错误 5。拒绝访问。`

**解决方法：**
- **方法一（推荐）：** 以管理员身份运行命令提示符
  1. 按 `Win + X`，选择"Windows PowerShell (管理员)"或"命令提示符 (管理员)"
  2. 在管理员命令提示符中运行：`net start MongoDB`
  
- **方法二：** 通过服务管理器启动
  1. 按 `Win + R`，输入 `services.msc`，回车
  2. 找到 "MongoDB" 服务
  3. 右键点击，选择"启动"
  
- **方法三：** 检查 MongoDB 是否已安装为服务
  - 运行 `sc query MongoDB` 查看服务状态
  - 如果服务不存在，可能需要重新安装 MongoDB 服务
  
- **方法四：** 如果无法启动服务，可以使用 MongoDB Atlas 云数据库
  - 在 `.env` 文件中将 `MONGODB_URI` 设置为云数据库连接字符串
  - 无需本地安装 MongoDB

### 2. nodemon 命令未找到

**错误信息：** `'nodemon' 不是内部或外部命令，也不是可运行的程序或批处理文件。`

**原因：** 依赖包未安装

**解决方法：**
1. 确保在 `backend` 目录下
2. 运行 `npm install` 安装所有依赖
3. 安装完成后，再次运行 `npm run dev`

**验证安装：** 检查 `backend` 目录下是否有 `node_modules` 文件夹

**替代方案：** 如果不想使用 nodemon，可以直接运行：
```bash
npm start
```
（但这样不会自动重启，需要手动重启服务器才能看到代码更改）

### 3. 端口被占用

**错误信息：** `Port 5000 is already in use`

**解决方法：**
- 修改 `.env` 文件中的 `PORT` 为其他端口（如 5001）
- 或关闭占用 5000 端口的程序

### 4. CORS 跨域问题

**错误信息：** 浏览器控制台显示 CORS 错误

**解决方法：**
- 在 `.env` 文件中添加 `CLIENT_ORIGIN`，设置为前端地址
- 或使用本地服务器打开前端（不要直接用 file:// 协议）

### 5. 前端无法调用 API

**解决方法：**
- 确保后端服务已启动
- 检查 `front/assets/js/auth.js` 中的 `BACKEND_BASE_URL` 是否正确
- 使用本地服务器打开前端，不要直接双击 HTML 文件

### 6. npm install 安装失败

**常见错误：**
- 网络超时
- 权限错误
- 版本不兼容

**解决方法：**
- **网络问题：** 使用国内镜像源
  ```bash
  npm config set registry https://registry.npmmirror.com
  npm install
  ```
  
- **权限错误：** 不要使用管理员权限运行（可能导致权限问题）
  
- **清理缓存：** 如果安装异常，尝试清理后重新安装
  ```bash
  npm cache clean --force
  rm -rf node_modules package-lock.json
  npm install
  ```
  
- **检查 Node.js 版本：** 确保 Node.js 版本 >= 16
  ```bash
  node --version
  ```

## 开发建议

1. **使用两个终端窗口：**
   - 一个运行后端服务器（`npm run dev`）
   - 一个用于其他命令

2. **安装 VS Code 扩展：**
   - Live Server（用于前端开发）
   - ESLint（代码检查）
   - MongoDB for VS Code（数据库管理）

3. **数据库管理工具：**
   - MongoDB Compass（官方 GUI 工具）
   - Studio 3T（第三方工具）

## 下一步

启动成功后，你可以：
1. 访问 `index.html` 查看首页
2. 注册新账号（`register.html`）
3. 登录账号（`login.html`）
4. 开始创建故事（`create.html`）

## 需要帮助？

如果遇到问题，请检查：
1. Node.js 版本是否符合要求
2. MongoDB 是否正常运行
3. `.env` 文件配置是否正确
4. 后端服务器是否成功启动
5. 浏览器控制台是否有错误信息

