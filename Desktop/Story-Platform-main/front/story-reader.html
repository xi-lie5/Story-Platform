<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">æ•…äº‹é˜…è¯»å™¨ - StoryForge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#ec4899',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            display: ['Playfair Display', 'serif'],
            serif: ['Georgia', 'Cambria', 'serif']
          },
        },
      }
    }
  </script>
  <style type="tailwindcss">
    @layer utilities {
      .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .animate-fade-in { animation: fadeIn 0.6s ease-in-out; }
      .animate-slide-up { animation: slideUp 0.4s ease-out; }
      .choice-card { transition: all 0.3s ease; }
      .choice-card:hover { transform: translateY(-2px); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar-modern sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-xl flex items-center justify-center shadow-lg">
            <i class="fa fa-book text-white text-lg"></i>
          </div>
          <h1 class="text-xl md:text-2xl font-display font-bold text-gray-900">StoryForge</h1>
        </div>
        
        <nav class="hidden md:flex items-center space-x-8">
          <a href="index.html" class="navbar-link font-medium transition-colors">é¦–é¡µ</a>
          <a href="browse.html" class="navbar-link font-medium transition-colors">æ•…äº‹é˜…è§ˆ</a>
          <a href="create.html" class="navbar-link font-medium transition-colors">åˆ›å»ºæ•…äº‹</a>
          <a href="my_stories.html" class="navbar-link font-medium transition-colors">æˆ‘çš„ä½œå“</a>
          <a href="profile.html" class="navbar-link font-medium transition-colors">ä¸ªäººä¸­å¿ƒ</a>
        </nav>
        
        <!-- è®¤è¯åŒºåŸŸ -->
        <div id="auth-area-desktop" class="flex items-center space-x-3"></div>
        
        <!-- é˜…è¯»å™¨æ§åˆ¶æŒ‰é’® -->
        <div class="flex items-center space-x-3">
          <button id="back-btn" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-arrow-left"></i>
          </button>
          <button id="font-size-btn" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-font"></i>
          </button>
          <button id="theme-btn" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-adjust"></i>
          </button>
          
          <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
          <button id="mobile-menu-button" class="lg:hidden p-2 rounded-lg hover:bg-slate-100 transition-colors">
              <i class="fa fa-bars text-slate-600 text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯èœå• -->
    <div class="md:hidden hidden bg-white/95 backdrop-blur-md border-t border-slate-200" id="mobile-menu">
      <div class="container mx-auto px-4 py-4 space-y-3">
        <a href="index.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">é¦–é¡µ</a>
        <a href="browse.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">æ•…äº‹é˜…è§ˆ</a>
        <a href="create.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">åˆ›å»ºæ•…äº‹</a>
        <a href="my_stories.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">æˆ‘çš„ä½œå“</a>
        <a href="profile.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">ä¸ªäººä¸­å¿ƒ</a>
        <div class="flex flex-col space-y-3 pt-3 border-t border-slate-200">
          <div id="auth-area-mobile">
            <!-- AuthUIä¼šåŠ¨æ€æ¸²æŸ“ç§»åŠ¨ç«¯ç™»å½•çŠ¶æ€æˆ–ç”¨æˆ·ä¿¡æ¯ -->
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <main class="container mx-auto max-w-4xl px-4 py-8">
    <!-- æ•…äº‹ä¿¡æ¯å¤´éƒ¨ -->
    <header class="bg-white rounded-2xl shadow-sm p-6 mb-8 animate-fade-in">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 id="story-title" class="text-2xl md:text-3xl font-display font-bold mb-2">åŠ è½½ä¸­...</h1>
          <div class="flex items-center gap-4 text-sm text-slate-600">
            <span id="node-info" class="flex items-center gap-1">
              <i class="fa fa-code-fork"></i>
              <span>èŠ‚ç‚¹ 1</span>
            </span>
            <span id="reading-time" class="flex items-center gap-1">
              <i class="fa fa-clock-o"></i>
              <span>2åˆ†é’Ÿé˜…è¯»</span>
            </span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="bookmark-btn" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-bookmark-o"></i>
          </button>
          <button id="share-btn" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-share-alt"></i>
          </button>
        </div>
      </div>
      
      <!-- è¿›åº¦æ¡ -->
      <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-secondary rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </header>

    <!-- æ•…äº‹å†…å®¹åŒºåŸŸ -->
    <section class="bg-white rounded-2xl shadow-sm p-6 md:p-8 mb-8 animate-slide-up">
      <article id="story-content" class="font-serif text-lg leading-relaxed">
        <div class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
          <span class="ml-3 text-slate-600">æ­£åœ¨åŠ è½½æ•…äº‹å†…å®¹...</span>
        </div>
      </article>
    </section>

    <!-- é€‰æ‹©åŒºåŸŸ -->
    <section id="choices-section" class="bg-white rounded-2xl shadow-sm p-6 md:p-8 mb-8 hidden animate-slide-up">
      <h2 class="text-xl font-bold mb-6 text-center">ä½ ä¼šå¦‚ä½•é€‰æ‹©ï¼Ÿ</h2>
      <div id="choices-container" class="space-y-4">
        <!-- é€‰æ‹©æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </section>

    <!-- å¯¼èˆªåŒºåŸŸ -->
    <nav id="navigation-section" class="bg-white rounded-2xl shadow-sm p-6 mb-8 hidden animate-slide-up">
      <div class="flex justify-between items-center">
        <button id="prev-node-btn" class="flex items-center gap-2 px-4 py-2 border border-slate-200 rounded-lg hover:border-primary hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fa fa-chevron-left"></i>
          <span>è¿”å›ä¸Šä¸€èŠ‚ç‚¹</span>
        </button>
        
        <div class="text-center">
          <p class="text-sm text-slate-600 mb-2">é˜…è¯»è·¯å¾„</p>
          <div id="path-indicator" class="flex items-center justify-center gap-2">
            <!-- è·¯å¾„æŒ‡ç¤ºå™¨å°†åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        
        <button id="restart-btn" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          <i class="fa fa-refresh"></i>
          <span>é‡æ–°å¼€å§‹</span>
        </button>
      </div>
    </nav>
  </main>

  <!-- å­—ä½“å¤§å°é€‰æ‹©å™¨ -->
  <div id="font-size-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4">
      <h3 class="text-lg font-bold mb-4">å­—ä½“å¤§å°</h3>
      <div class="space-y-2">
        <button class="w-full p-3 text-left rounded-lg hover:bg-slate-50 transition-colors" data-size="small">
          <span class="text-sm">å°å·å­—ä½“</span>
        </button>
        <button class="w-full p-3 text-left rounded-lg hover:bg-slate-50 transition-colors border border-primary" data-size="medium">
          <span class="text-base">ä¸­å·å­—ä½“ï¼ˆé»˜è®¤ï¼‰</span>
        </button>
        <button class="w-full p-3 text-left rounded-lg hover:bg-slate-50 transition-colors" data-size="large">
          <span class="text-lg">å¤§å·å­—ä½“</span>
        </button>
      </div>
      <button id="close-font-modal" class="mt-4 w-full p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
        å…³é—­
      </button>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="assets/js/auth.js"></script>
  <script>
    // åˆå§‹åŒ–AuthUI
    AuthUI.init();

    // ç§»åŠ¨ç«¯èœå•åŠŸèƒ½
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // å…¨å±€å˜é‡
    let currentStory = null;
    let currentNode = null;
    let readingHistory = [];
    let fontSize = 'medium';
    let isDarkMode = false;

    // å·¥å…·å‡½æ•°
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        storyId: params.get('id'),
        nodeId: params.get('node') || 'root'
      };
    }

    function updateUrl(storyId, nodeId) {
      const url = new URL(window.location);
      url.searchParams.set('id', storyId);
      url.searchParams.set('node', nodeId);
      window.history.pushState({}, '', url);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center transition-all duration-300 transform translate-y-10 opacity-0`;

      if (type === 'success') {
        notification.classList.add('bg-green-50', 'border', 'border-green-200', 'text-green-700');
        notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
      } else if (type === 'error') {
        notification.classList.add('bg-red-50', 'border', 'border-red-200', 'text-red-700');
        notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
      } else {
        notification.classList.add('bg-blue-50', 'border', 'border-blue-200', 'text-blue-700');
        notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
      }

      document.body.appendChild(notification);
      setTimeout(() => notification.classList.remove('translate-y-10', 'opacity-0'), 10);
      setTimeout(() => {
        notification.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // APIè°ƒç”¨å‡½æ•°
    async function loadStoryData(storyId) {
      try {
        const response = await fetch(`http://localhost:5000/api/v1/stories/${storyId}`);
        if (!response.ok) {
          throw new Error('æ•…äº‹ä¸å­˜åœ¨');
        }
        const data = await response.json();
        return data.data;
      } catch (error) {
        console.error('åŠ è½½æ•…äº‹æ•°æ®å¤±è´¥:', error);
        showNotification('åŠ è½½æ•…äº‹å¤±è´¥', 'error');
        return null;
      }
    }

    async function loadStoryNodes(storyId) {
      try {
        console.log('ğŸ” å¼€å§‹åŠ è½½æ•…äº‹èŠ‚ç‚¹ï¼ŒstoryId:', storyId);
        const url = `http://localhost:5000/api/v1/storyNodes/public/stories/${storyId}/nodes`;
        console.log('ğŸ” è¯·æ±‚URL:', url);
        
        const response = await fetch(url);
        console.log('ğŸ” å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('ğŸ” å“åº”é”™è¯¯:', errorText);
          throw new Error('æ— æ³•åŠ è½½æ•…äº‹èŠ‚ç‚¹');
        }
        
        const result = await response.json();
        console.log('ğŸ” å“åº”æ•°æ®:', result);
        
        if (result.success) {
          return result.data;
        } else {
          throw new Error(result.message || 'åŠ è½½èŠ‚ç‚¹å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½æ•…äº‹èŠ‚ç‚¹å¤±è´¥:', error);
        showNotification('åŠ è½½æ•…äº‹èŠ‚ç‚¹å¤±è´¥', 'error');
        return [];
      }
    }

    // èŠ‚ç‚¹åŠ è½½å’Œæ¸²æŸ“
    async function loadNode(storyId, nodeId) {
      try {
        // åŠ è½½æ‰€æœ‰èŠ‚ç‚¹æ•°æ®
        const nodes = await loadStoryNodes(storyId);
        if (!nodes || nodes.length === 0) {
          throw new Error('æ²¡æœ‰æ‰¾åˆ°æ•…äº‹èŠ‚ç‚¹');
        }

        // æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹
        let targetNode = null;
        if (nodeId === 'root') {
          // æŸ¥æ‰¾æ ¹èŠ‚ç‚¹
          targetNode = nodes.find(node => !node.parentId);
        } else {
          targetNode = nodes.find(node => node._id === nodeId || node.temporaryId === nodeId);
        }

        if (!targetNode) {
          throw new Error('èŠ‚ç‚¹ä¸å­˜åœ¨');
        }

        // æ›´æ–°å½“å‰èŠ‚ç‚¹
        currentNode = targetNode;
        
        // æ·»åŠ åˆ°é˜…è¯»å†å²
        if (!readingHistory.find(h => h.nodeId === targetNode._id)) {
          readingHistory.push({
            nodeId: targetNode._id,
            title: targetNode.title,
            timestamp: new Date()
          });
        }

        // æ›´æ–°URL
        updateUrl(storyId, targetNode._id);
        
        // æ¸²æŸ“èŠ‚ç‚¹å†…å®¹
        renderNode(targetNode);
        
        // æ›´æ–°å¯¼èˆª
        updateNavigation();
        
        // æ›´æ–°è¿›åº¦
        updateProgress();

      } catch (error) {
        console.error('åŠ è½½èŠ‚ç‚¹å¤±è´¥:', error);
        showNotification('åŠ è½½èŠ‚ç‚¹å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ¸²æŸ“èŠ‚ç‚¹å†…å®¹
    function renderNode(node) {
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      document.getElementById('page-title').textContent = `${node.title} - StoryForge`;
      document.getElementById('story-title').textContent = node.title;
      
      // æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯
      document.getElementById('node-info').innerHTML = `
        <i class="fa fa-code-fork"></i>
        <span>èŠ‚ç‚¹ ${node.order || 1}</span>
      `;
      
      // æ›´æ–°å†…å®¹
      const contentEl = document.getElementById('story-content');
      contentEl.innerHTML = `
        <div class="prose prose-lg max-w-none">
          ${node.content ? node.content.split('\n').map(p => `<p class="mb-6">${p}</p>`).join('') : '<p class="text-slate-600">æš‚æ— å†…å®¹</p>'}
        </div>
      `;
      
      // æ¸²æŸ“é€‰æ‹©
      renderChoices(node);
      
      // åº”ç”¨å­—ä½“å¤§å°
      applyFontSize();
    }

    // æ¸²æŸ“é€‰æ‹©æŒ‰é’®
    function renderChoices(node) {
      const choicesSection = document.getElementById('choices-section');
      const choicesContainer = document.getElementById('choices-container');
      
      if (!node.choices || node.choices.length === 0) {
        choicesSection.classList.add('hidden');
        return;
      }
      
      choicesSection.classList.remove('hidden');
      choicesContainer.innerHTML = '';
      
      node.choices.forEach((choice, index) => {
        const choiceCard = document.createElement('div');
        choiceCard.className = 'choice-card p-6 bg-slate-50 rounded-xl border border-slate-200 hover:border-primary hover:bg-primary/5 cursor-pointer';
        choiceCard.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold">
              ${String.fromCharCode(65 + index)}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2">${choice.text}</h3>
              ${choice.description ? `<p class="text-slate-600">${choice.description}</p>` : ''}
            </div>
            <div class="flex-shrink-0">
              <i class="fa fa-chevron-right text-slate-400"></i>
            </div>
          </div>
        `;
        
        choiceCard.addEventListener('click', () => handleChoice(choice));
        choicesContainer.appendChild(choiceCard);
      });
    }

    // å¤„ç†é€‰æ‹©
    async function handleChoice(choice) {
      if (!choice.targetNodeId) {
        showNotification('è¯¥é€‰æ‹©æš‚æ— åç»­å†…å®¹', 'info');
        return;
      }
      
      const params = getUrlParams();
      await loadNode(params.storyId, choice.targetNodeId);
    }

    // æ›´æ–°å¯¼èˆª
    function updateNavigation() {
      const navSection = document.getElementById('navigation-section');
      const prevBtn = document.getElementById('prev-node-btn');
      const pathIndicator = document.getElementById('path-indicator');
      
      navSection.classList.remove('hidden');
      
      // æ›´æ–°è¿”å›æŒ‰é’®çŠ¶æ€
      if (readingHistory.length <= 1) {
        prevBtn.disabled = true;
      } else {
        prevBtn.disabled = false;
        prevBtn.onclick = () => {
          const prevNode = readingHistory[readingHistory.length - 2];
          const params = getUrlParams();
          loadNode(params.storyId, prevNode.nodeId);
        };
      }
      
      // æ›´æ–°è·¯å¾„æŒ‡ç¤ºå™¨
      pathIndicator.innerHTML = readingHistory.map((item, index) => `
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full ${index === readingHistory.length - 1 ? 'bg-primary' : 'bg-slate-300'}"></div>
          ${index < readingHistory.length - 1 ? '<i class="fa fa-chevron-right text-xs text-slate-400"></i>' : ''}
        </div>
      `).join('');
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress() {
      const progressBar = document.getElementById('progress-bar');
      const progress = Math.min((readingHistory.length / 10) * 100, 100); // å‡è®¾10ä¸ªèŠ‚ç‚¹ä¸ºå®Œæ•´æ•…äº‹
      progressBar.style.width = `${progress}%`;
    }

    // å­—ä½“å¤§å°ç®¡ç†
    function applyFontSize() {
      const contentEl = document.getElementById('story-content');
      contentEl.classList.remove('text-base', 'text-lg', 'text-xl');
      
      switch (fontSize) {
        case 'small':
          contentEl.classList.add('text-base');
          break;
        case 'medium':
          contentEl.classList.add('text-lg');
          break;
        case 'large':
          contentEl.classList.add('text-xl');
          break;
      }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–
      const params = getUrlParams();
      if (!params.storyId) {
        showNotification('ç¼ºå°‘æ•…äº‹ID', 'error');
        return;
      }
      
      // åŠ è½½æ•…äº‹
      loadNode(params.storyId, params.nodeId);
      
      // è¿”å›æŒ‰é’®
      document.getElementById('back-btn').addEventListener('click', () => {
        window.history.back();
      });
      
      // å­—ä½“å¤§å°æŒ‰é’®
      document.getElementById('font-size-btn').addEventListener('click', () => {
        document.getElementById('font-size-modal').classList.remove('hidden');
      });
      
      // å­—ä½“å¤§å°é€‰æ‹©
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
          fontSize = btn.dataset.size;
          applyFontSize();
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.querySelectorAll('[data-size]').forEach(b => {
            b.classList.remove('border', 'border-primary');
          });
          btn.classList.add('border', 'border-primary');
          
          document.getElementById('font-size-modal').classList.add('hidden');
        });
      });
      
      // å…³é—­å­—ä½“æ¨¡æ€æ¡†
      document.getElementById('close-font-modal').addEventListener('click', () => {
        document.getElementById('font-size-modal').classList.add('hidden');
      });
      
      // ä¸»é¢˜åˆ‡æ¢
      document.getElementById('theme-btn').addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark');
        showNotification(isDarkMode ? 'å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼', 'info');
      });
      
      // é‡æ–°å¼€å§‹
      document.getElementById('restart-btn').addEventListener('click', () => {
        readingHistory = [];
        const params = getUrlParams();
        loadNode(params.storyId, 'root');
      });
      
      // æ”¶è—æŒ‰é’®
      document.getElementById('bookmark-btn').addEventListener('click', () => {
        const icon = document.querySelector('#bookmark-btn i');
        if (icon.classList.contains('fa-bookmark-o')) {
          icon.classList.remove('fa-bookmark-o');
          icon.classList.add('fa-bookmark');
          showNotification('å·²æ·»åŠ ä¹¦ç­¾', 'success');
        } else {
          icon.classList.remove('fa-bookmark');
          icon.classList.add('fa-bookmark-o');
          showNotification('å·²ç§»é™¤ä¹¦ç­¾', 'info');
        }
      });
      
      // åˆ†äº«æŒ‰é’®
      document.getElementById('share-btn').addEventListener('click', () => {
        const url = window.location.href;
        if (navigator.share) {
          navigator.share({
            title: currentNode.title,
            text: 'æ¥é˜…è¯»è¿™ä¸ªç²¾å½©çš„æ•…äº‹ï¼',
            url: url
          });
        } else {
          navigator.clipboard.writeText(url);
          showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }
      });
      
      // æµè§ˆå™¨åé€€/å‰è¿›
      window.addEventListener('popstate', () => {
        const params = getUrlParams();
        loadNode(params.storyId, params.nodeId);
      });
    });
  </script>
</body>
</html>