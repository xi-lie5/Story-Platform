<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的收藏 - StoryForge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        progress: '#10b981'
                    },
                },
            }
        }
    </script>
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
          .backdrop-blur {
            backdrop-filter: blur(8px);
          }
          .navbar-modern {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
          }
          .navbar-link {
            transition: color 0.2s ease;
          }
          .btn-primary-modern {
            background: #6366f1;
            transition: background-color 0.2s ease;
          }
          .btn-primary-modern:hover {
            background: #5558e3;
          }
          .btn-secondary-modern {
            background: transparent;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            transition: all 0.2s ease;
          }
          .btn-secondary-modern:hover {
            background: #f9fafb;
            border-color: #d1d5db;
          }
        }
      </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="navbar-modern">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fa fa-book text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl md:text-2xl font-display font-bold text-gray-900">StoryForge</h1>
                </div>
                
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="navbar-link font-medium text-gray-600 hover:text-primary transition-colors">首页</a>
                    <a href="explore.html" class="navbar-link font-medium text-gray-600 hover:text-primary transition-colors">探索故事</a>
                    <a href="create.html" class="navbar-link font-medium text-gray-600 hover:text-primary transition-colors">创建故事</a>
                    <a href="my_stories.html" class="navbar-link font-medium text-gray-600 hover:text-primary transition-colors">我的作品</a>
                    <a href="favorites.html" class="navbar-link active font-medium text-primary">我的收藏</a>
                    <a href="profile.html" class="navbar-link font-medium text-gray-600 hover:text-primary transition-colors">个人中心</a>
                    <a href="about.html" class="navbar-link font-medium text-gray-600 hover:text-primary transition-colors">关于</a>
                </div>
                
                <div class="flex items-center space-x-4" id="auth-buttons">
                    <button class="btn-secondary-modern px-4 py-2 rounded-full text-primary font-medium">
                        <a href="login.html" class="block w-full h-full">登录</a>
                    </button>
                    <button class="btn-primary-modern px-4 py-2 rounded-full text-white font-medium">
                        <a href="register.html" class="block w-full h-full">注册</a>
                    </button>
                    <div class="flex items-center space-x-4 md:hidden">
                        <button id="mobile-menu-button" class="text-xl">
                            <i class="fa fa-bars"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 用户信息区域（默认隐藏） -->
                <div class="flex items-center space-x-4 hidden" id="user-info">
                    <div class="flex items-center space-x-3">
                        <img id="user-avatar" src="" alt="用户头像" class="w-8 h-8 rounded-full">
                        <div class="hidden md:block">
                            <p id="user-name" class="text-sm font-medium text-gray-900"></p>
                            <p id="user-email" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <button id="logout-btn" class="btn-secondary-modern px-4 py-2 rounded-full text-primary font-medium">
                        退出
                    </button>
                    <div class="flex items-center space-x-4 md:hidden">
                        <button id="mobile-menu-button" class="text-xl">
                            <i class="fa fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 移动端菜单 -->
        <div class="md:hidden hidden bg-white/95 backdrop-blur border-t border-gray-200" id="mobile-menu">
            <div class="container mx-auto px-4 py-3 space-y-2">
                <a href="index.html" class="navbar-link block py-2 text-gray-600 hover:text-primary transition-colors">首页</a>
                <a href="explore.html" class="navbar-link block py-2 text-gray-600 hover:text-primary transition-colors">探索故事</a>
                <a href="create.html" class="navbar-link block py-2 text-gray-600 hover:text-primary transition-colors">创建故事</a>
                <a href="my_stories.html" class="navbar-link block py-2 text-gray-600 hover:text-primary transition-colors">我的作品</a>
                <a href="favorites.html" class="navbar-link active block py-2 text-primary">我的收藏</a>
                <a href="profile.html" class="navbar-link block py-2 text-gray-600 hover:text-primary transition-colors">个人中心</a>
                <a href="about.html" class="navbar-link block py-2 text-gray-600 hover:text-primary transition-colors">关于</a>
                <div class="flex flex-col space-y-2 pt-2 border-t border-gray-200">
                    <a href="login.html" class="block py-2 hover:text-primary transition-colors">登录</a>
                    <a href="register.html" class="block py-2 hover:text-primary transition-colors">注册</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区 -->
    <section class="pb-20 px-4">
        <div class="container mx-auto max-w-6xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl md:text-3xl font-bold">我的收藏</h2>
                    <p class="text-gray-600 mt-1">您收藏的精彩故事</p>
                </div>
                <a href="explore.html"
                    class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center">
                    <i class="fa fa-search mr-2"></i> 探索更多故事
                </a>
            </div>

            <!-- 收藏统计 -->
            <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-primary" id="total-favorites">0</div>
                        <div class="text-gray-600 text-sm mt-1">总收藏数</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-secondary" id="recent-favorites">0</div>
                        <div class="text-gray-600 text-sm mt-1">本月收藏</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-progress" id="categories-count">0</div>
                        <div class="text-gray-600 text-sm mt-1">涉及分类</div>
                    </div>
                </div>
            </div>

            <!-- 收藏作品列表容器 -->
            <div id="favorites-container">
                <!-- 加载中状态 -->
                <div id="loading-state" class="text-center py-12">
                    <i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                    <p class="text-slate-600">正在加载您的收藏...</p>
                </div>
                
                <!-- 空状态（默认隐藏） -->
                <div id="empty-state" class="text-center py-12 hidden">
                    <i class="fa fa-heart text-6xl text-slate-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">还没有收藏任何故事</h3>
                    <p class="text-slate-500 mb-6">去探索页面发现精彩故事并收藏吧！</p>
                    <a href="explore.html" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-search mr-2"></i> 探索故事
                    </a>
                </div>
                
                <!-- 未登录状态（默认隐藏） -->
                <div id="not-logged-in" class="text-center py-12 hidden">
                    <i class="fa fa-lock text-6xl text-slate-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">请先登录</h3>
                    <p class="text-slate-500 mb-6">登录后即可查看和管理您的收藏</p>
                    <div class="flex justify-center gap-4">
                        <a href="login.html" class="inline-flex items-center px-6 py-3 bg-white text-primary border border-primary rounded-lg hover:bg-primary/5 transition-colors">
                            登录
                        </a>
                        <a href="register.html" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            注册
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- 收藏故事网格 -->
            <div id="favorites-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- 动态生成的收藏故事卡片 -->
            </div>
        </div>
    </section>

    <!-- 引入AuthUI -->
    <script src="assets/js/auth.js"></script>
    
    <script>
        // 全局变量
        let favorites = [];
        let currentPage = 1;
        const itemsPerPage = 12;
        let isLoading = false;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化AuthUI
            if (window.AuthUI) {
                window.AuthUI.init();
            }
            
            // 检查登录状态并加载收藏
            checkLoginAndLoadFavorites();
            
            // 绑定移动端菜单按钮
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            
            // 绑定退出登录按钮
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (window.AuthUI) {
                        window.AuthUI.clearAuthStorage();
                    }
                    window.location.href = 'index.html';
                });
            }
        });

        // 检查登录状态并加载收藏
        async function checkLoginAndLoadFavorites() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            
            if (!token) {
                showNotLoggedIn();
                return;
            }
            
            // 加载用户信息
            if (window.AuthUI) {
                const authState = window.AuthUI.getAuthState();
                if (authState) {
                    updateUserInfo(authState.userInfo);
                }
            }
            
            // 加载收藏列表
            await loadFavorites();
        }

        // 更新用户信息显示
        function updateUserInfo(userInfo) {
            const authButtons = document.getElementById('auth-buttons');
            const userInfoDiv = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            const userAvatar = document.getElementById('user-avatar');
            
            if (authButtons) authButtons.classList.add('hidden');
            if (userInfoDiv) userInfoDiv.classList.remove('hidden');
            if (userName) userName.textContent = userInfo.username || '--';
            if (userEmail) userEmail.textContent = userInfo.email || '--';
            if (userAvatar && userInfo.avatar) {
                userAvatar.src = userInfo.avatar.startsWith('http') ? userInfo.avatar : `/avatar/${userInfo.avatar}`;
            }
        }

        // 显示未登录状态
        function showNotLoggedIn() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('not-logged-in').classList.remove('hidden');
            document.getElementById('favorites-grid').classList.add('hidden');
            
            // 隐藏用户信息，显示登录按钮
            const authButtons = document.getElementById('auth-buttons');
            const userInfoDiv = document.getElementById('user-info');
            if (authButtons) authButtons.classList.remove('hidden');
            if (userInfoDiv) userInfoDiv.classList.add('hidden');
        }

        // 加载收藏列表
        async function loadFavorites() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            
            if (!token) {
                showNotLoggedIn();
                return;
            }
            
            try {
                isLoading = true;
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('favorites-grid').classList.add('hidden');
                
                const response = await fetch('/api/v1/interactions/user/favorites', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    favorites = data.data.favorites || [];
                    
                    document.getElementById('loading-state').classList.add('hidden');
                    
                    if (favorites.length === 0) {
                        document.getElementById('empty-state').classList.remove('hidden');
                        updateStatistics(0);
                    } else {
                        document.getElementById('favorites-grid').classList.remove('hidden');
                        renderFavorites();
                        updateStatistics(favorites.length);
                    }
                } else if (response.status === 404 || response.status === 500) {
                    // 服务器错误或接口不存在时，显示空状态而不是错误
                    document.getElementById('loading-state').classList.add('hidden');
                    favorites = [];
                    document.getElementById('empty-state').classList.remove('hidden');
                    updateStatistics(0);
                } else {
                    throw new Error('获取收藏列表失败');
                }
            } catch (error) {
                console.error('加载收藏失败:', error);
                // 只有在真正的网络错误时才显示错误信息
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    document.getElementById('loading-state').classList.add('hidden');
                    showError('网络连接失败，请检查网络后重试');
                } else {
                    // 其他错误都显示为空状态
                    document.getElementById('loading-state').classList.add('hidden');
                    favorites = [];
                    document.getElementById('empty-state').classList.remove('hidden');
                    updateStatistics(0);
                }
            } finally {
                isLoading = false;
            }
        }

        // 渲染收藏列表
        function renderFavorites() {
            const grid = document.getElementById('favorites-grid');
            grid.innerHTML = '';
            
            favorites.forEach(favorite => {
                const story = favorite.story;
                const card = createFavoriteCard(story, favorite.collectedAt);
                grid.appendChild(card);
            });
        }

        // 创建收藏卡片
        function createFavoriteCard(story, collectedAt) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1';
            
            const coverImage = story.coverImage || '/coverImage/1.png';
            const rating = story.averageRating || 0;
            const favoriteCount = story.favoriteCount || 0;
            const viewCount = story.view || 0;
            const authorName = story.author?.username || '未知作者';
            const categoryName = story.category?.name || '未分类';
            const collectedDate = new Date(collectedAt).toLocaleDateString('zh-CN');
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${coverImage}" alt="${story.title}" class="w-full h-48 object-cover">
                    <div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs flex items-center">
                        <i class="fa fa-heart mr-1"></i> 已收藏
                    </div>
                    <div class="absolute bottom-2 left-2 bg-black/50 text-white px-2 py-1 rounded text-xs">
                        ${categoryName}
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-lg mb-2 line-clamp-2">${story.title}</h3>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">${story.description || '暂无简介'}</p>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                        <span><i class="fa fa-user mr-1"></i> ${authorName}</span>
                        <span><i class="fa fa-calendar mr-1"></i> ${collectedDate}</span>
                    </div>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-4">
                        <div class="flex items-center space-x-3">
                            <span><i class="fa fa-star text-yellow-400"></i> ${rating.toFixed(1)}</span>
                            <span><i class="fa fa-heart text-red-400"></i> ${favoriteCount}</span>
                            <span><i class="fa fa-eye text-blue-400"></i> ${viewCount}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <a href="story_context.html?id=${story._id}" 
                           class="flex-1 bg-primary text-white text-center py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors text-sm">
                            <i class="fa fa-book mr-1"></i> 阅读
                        </a>
                        <button onclick="toggleFavorite('${story._id}', this)" 
                                class="px-4 py-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors text-sm">
                            <i class="fa fa-heart"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // 切换收藏状态
        async function toggleFavorite(storyId, button) {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            
            if (!token) {
                showNotification('请先登录', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/interactions/stories/${storyId}/favorite`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const isFavorited = data.data.isFavorited;
                    
                    if (!isFavorited) {
                        // 取消收藏成功，移除卡片
                        const card = button.closest('.bg-white');
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            card.remove();
                            // 更新收藏列表
                            favorites = favorites.filter(fav => fav.story._id !== storyId);
                            updateStatistics(favorites.length);
                            
                            if (favorites.length === 0) {
                                document.getElementById('favorites-grid').classList.add('hidden');
                                document.getElementById('empty-state').classList.remove('hidden');
                            }
                        }, 300);
                        
                        showNotification('已取消收藏', 'success');
                    }
                } else {
                    throw new Error('操作失败');
                }
            } catch (error) {
                console.error('切换收藏状态失败:', error);
                showNotification('操作失败，请重试', 'error');
            }
        }

        // 更新统计信息
        function updateStatistics(totalCount) {
            document.getElementById('total-favorites').textContent = totalCount;
            
            // 计算本月收藏数（这里简化处理，实际应该根据收藏时间计算）
            const thisMonth = new Date();
            thisMonth.setMonth(thisMonth.getMonth() - 1);
            const recentCount = favorites.filter(fav => 
                new Date(fav.collectedAt) >= thisMonth
            ).length;
            document.getElementById('recent-favorites').textContent = recentCount;
            
            // 计算涉及分类数
            const categories = new Set(favorites.map(fav => fav.story.category?.name).filter(Boolean));
            document.getElementById('categories-count').textContent = categories.size;
        }

        // 显示错误信息
        function showError(message) {
            const container = document.getElementById('favorites-container');
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fa fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">加载失败</h3>
                    <p class="text-slate-500 mb-6">${message}</p>
                    <button onclick="loadFavorites()" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-refresh mr-2"></i> 重新加载
                    </button>
                </div>
            `;
        }

        // 显示通知（简化版本）
        function showNotification(message, type = 'info') {
            // 这里可以实现一个更复杂的通知系统
            console.log(`${type}: ${message}`);
        }
    </script>
</body>
</html>