<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点创建测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>节点创建和保存功能测试</h1>
    
    <div class="section">
        <h2>1. 创建测试故事</h2>
        <input type="text" id="storyTitle" placeholder="故事标题" value="测试故事">
        <button onclick="createStory()">创建故事</button>
        <div id="storyResult" class="result"></div>
    </div>

    <div class="section">
        <h2>2. 创建根节点</h2>
        <input type="text" id="rootNodeTitle" placeholder="根节点标题" value="故事开始">
        <textarea id="rootNodeContent" placeholder="根节点内容">这是故事的开始...</textarea>
        <button onclick="createRootNode()">创建根节点</button>
        <div id="rootNodeResult" class="result"></div>
    </div>

    <div class="section">
        <h2>3. 创建选择节点</h2>
        <input type="text" id="choiceNodeTitle" placeholder="选择节点标题" value="选择你的道路">
        <textarea id="choiceNodeContent" placeholder="选择节点内容">你面临一个重要的选择...</textarea>
        <div>
            <label>选项1: <input type="text" id="choice1" value="选择A"></label><br>
            <label>选项2: <input type="text" id="choice2" value="选择B"></label>
        </div>
        <button onclick="createChoiceNode()">创建选择节点</button>
        <div id="choiceNodeResult" class="result"></div>
    </div>

    <div class="section">
        <h2>4. 创建结局节点</h2>
        <input type="text" id="endingNodeTitle" placeholder="结局节点标题" value="故事结局">
        <textarea id="endingNodeContent" placeholder="结局节点内容">故事到此结束...</textarea>
        <button onclick="createEndingNode()">创建结局节点</button>
        <div id="endingNodeResult" class="result"></div>
    </div>

    <div class="section">
        <h2>5. 测试选项绑定</h2>
        <input type="text" id="choiceId" placeholder="选项ID">
        <input type="text" id="targetNodeId" placeholder="目标节点ID">
        <button onclick="bindChoice()">绑定选项</button>
        <div id="bindResult" class="result"></div>
    </div>

    <div class="section">
        <h2>6. 查看故事树</h2>
        <button onclick="viewStoryTree()">查看故事树</button>
        <div id="treeResult" class="result"></div>
    </div>

    <script>
        let currentStoryId = null;
        let currentRootNodeId = null;
        let currentChoiceNodeId = null;
        let currentEndingNodeId = null;

        // 获取token
        function getToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token') || 'test-token';
        }

        // 显示结果
        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        // 创建故事
        async function createStory() {
            try {
                const title = document.getElementById('storyTitle').value;
                const response = await fetch('/api/v1/stories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        description: '这是一个测试故事'
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    currentStoryId = result.data._id;
                    showResult('storyResult', `故事创建成功！ID: ${currentStoryId}`);
                } else {
                    showResult('storyResult', `创建失败: ${result.message}`, false);
                }
            } catch (error) {
                showResult('storyResult', `网络错误: ${error.message}`, false);
            }
        }

        // 创建根节点
        async function createRootNode() {
            if (!currentStoryId) {
                showResult('rootNodeResult', '请先创建故事', false);
                return;
            }

            try {
                const title = document.getElementById('rootNodeTitle').value;
                const content = document.getElementById('rootNodeContent').value;
                
                const response = await fetch(`/api/v1/stories/${currentStoryId}/nodes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        type: 'normal'
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    currentRootNodeId = result.data._id;
                    showResult('rootNodeResult', `根节点创建成功！ID: ${currentRootNodeId}`);
                } else {
                    showResult('rootNodeResult', `创建失败: ${result.message}`, false);
                }
            } catch (error) {
                showResult('rootNodeResult', `网络错误: ${error.message}`, false);
            }
        }

        // 创建选择节点
        async function createChoiceNode() {
            if (!currentStoryId) {
                showResult('choiceNodeResult', '请先创建故事', false);
                return;
            }

            try {
                const title = document.getElementById('choiceNodeTitle').value;
                const content = document.getElementById('choiceNodeContent').value;
                const choice1 = document.getElementById('choice1').value;
                const choice2 = document.getElementById('choice2').value;
                
                const response = await fetch(`/api/v1/stories/${currentStoryId}/nodes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        type: 'choice',
                        parentId: currentRootNodeId,
                        choices: [
                            { text: choice1 },
                            { text: choice2 }
                        ]
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    currentChoiceNodeId = result.data._id;
                    showResult('choiceNodeResult', `选择节点创建成功！ID: ${currentChoiceNodeId}<br>选项ID: ${result.data.choices.map(c => c.id).join(', ')}`);
                } else {
                    showResult('choiceNodeResult', `创建失败: ${result.message}`, false);
                }
            } catch (error) {
                showResult('choiceNodeResult', `网络错误: ${error.message}`, false);
            }
        }

        // 创建结局节点
        async function createEndingNode() {
            if (!currentStoryId) {
                showResult('endingNodeResult', '请先创建故事', false);
                return;
            }

            try {
                const title = document.getElementById('endingNodeTitle').value;
                const content = document.getElementById('endingNodeContent').value;
                
                const response = await fetch(`/api/v1/stories/${currentStoryId}/nodes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        type: 'ending',
                        parentId: currentChoiceNodeId
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    currentEndingNodeId = result.data._id;
                    showResult('endingNodeResult', `结局节点创建成功！ID: ${currentEndingNodeId}`);
                } else {
                    showResult('endingNodeResult', `创建失败: ${result.message}`, false);
                }
            } catch (error) {
                showResult('endingNodeResult', `网络错误: ${error.message}`, false);
            }
        }

        // 绑定选项
        async function bindChoice() {
            if (!currentChoiceNodeId) {
                showResult('bindResult', '请先创建选择节点', false);
                return;
            }

            try {
                const choiceId = document.getElementById('choiceId').value;
                const targetNodeId = document.getElementById('targetNodeId').value;
                
                const response = await fetch(`/api/v1/nodes/${currentChoiceNodeId}/choices/${choiceId}/bind`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ targetNodeId })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showResult('bindResult', `选项绑定成功！`);
                } else {
                    showResult('bindResult', `绑定失败: ${result.message}`, false);
                }
            } catch (error) {
                showResult('bindResult', `网络错误: ${error.message}`, false);
            }
        }

        // 查看故事树
        async function viewStoryTree() {
            if (!currentStoryId) {
                showResult('treeResult', '请先创建故事', false);
                return;
            }

            try {
                const response = await fetch(`/api/v1/stories/${currentStoryId}/tree`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showResult('treeResult', `<pre>${JSON.stringify(result.data, null, 2)}</pre>`);
                } else {
                    showResult('treeResult', `获取失败: ${result.message}`, false);
                }
            } catch (error) {
                showResult('treeResult', `网络错误: ${error.message}`, false);
            }
        }
    </script>
</body>
</html>