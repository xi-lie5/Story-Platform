<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>故事编辑器 - StoryForge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
  <style>
    .choice-item {
      transition: all 0.3s ease;
    }
    .choice-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .node-type-badge {
      transition: all 0.2s ease;
    }
    .node-type-badge:hover {
      transform: scale(1.05);
    }
    .branch-node {
      border-left: 4px solid #f59e0b;
      background-color: #fef3c7;
    }
    
    .branch-node .node-type-badge {
      background-color: #f59e0b;
    }
    .rich-editor {
      min-height: 300px;
    }
    .preview-mode .rich-editor {
      background: #f8fafc;
      border-color: #e2e8f0;
    }
    .breadcrumb-item {
      transition: color 0.2s ease;
    }
    .breadcrumb-item:hover {
      color: #3b82f6;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
  <!-- 导航栏 -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur shadow-sm">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-book text-primary text-2xl"></i>
        <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">StoryForge</h1>
      </div>
      
      <nav class="hidden md:flex items-center space-x-8">
        <a href="index.html" class="font-medium hover:text-primary transition-colors">首页</a>
        <a href="explore.html" class="font-medium hover:text-primary transition-colors">探索故事</a>
        <a href="create.html" class="font-medium hover:text-primary transition-colors">创建故事</a>
        <a href="my_stories.html" class="font-medium hover:text-primary transition-colors">我的作品</a>
        <a href="about.html" class="font-medium hover:text-primary transition-colors">关于</a>
      </nav>
      
      <div class="flex items-center space-x-4" id="auth-area-desktop"></div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <section class="pt-20 pb-20 px-4">
    <div class="container mx-auto max-w-5xl">
      <!-- 面包屑导航 -->
      <div class="flex items-center space-x-2 text-sm text-slate-600 mb-6">
        <a href="my_stories.html" class="breadcrumb-item hover:text-primary">
          <i class="fa fa-arrow-left mr-1"></i> 我的作品
        </a>
        <span class="text-slate-400">/</span>
        <a href="story_tree_new.html?story=<span id="breadcrumb-story-id"></span>" class="breadcrumb-item hover:text-primary" id="breadcrumb-story">
          故事节点图谱
        </a>
        <span class="text-slate-400">/</span>
        <span class="font-medium">节点编辑</span>
      </div>

      <!-- 节点信息卡片 -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <div class="flex items-center space-x-3 mb-2">
              <h2 class="text-2xl font-bold" id="node-title">加载中...</h2>
              <span id="node-type-badge" class="node-type-badge px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                普通节点
              </span>
            </div>
          </div>
          <div class="flex space-x-2">
            <button id="preview-toggle" class="px-4 py-2 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
              <i class="fa fa-eye mr-2"></i> 预览
            </button>
            <button id="save-node" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
              <i class="fa fa-save mr-2"></i> 保存
            </button>
          </div>
        </div>
      </div>

      <!-- 编辑表单 -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <form id="node-form">
          <!-- 基本信息 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-2">节点标题</label>
            <input type="text" id="title-input" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="输入节点标题...">
          </div>

          <!-- 节点类型 -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-2">节点类型</label>
            <div class="flex space-x-4">
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="node-type" value="normal" class="mr-2">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">普通节点</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="node-type" value="choice" class="mr-2">
                <span class="px-3 py-1 bg-amber-100 text-amber-800 rounded-full text-sm">选择节点</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="node-type" value="ending" class="mr-2">
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">结局节点</span>
              </label>
            </div>
          </div>

          <!-- 节点内容 -->
          <div class="mb-6" id="content-section">
            <label class="block text-sm font-medium text-slate-700 mb-2">节点内容</label>
            <div id="content-editor" class="rich-editor border border-slate-200 rounded-lg overflow-hidden"></div>
          </div>

          <!-- 选项说明（仅选择节点显示） -->
          <div class="mb-6" id="choice-description-section" style="display: none;">
            <label class="block text-sm font-medium text-slate-700 mb-2">选项说明</label>
            <textarea id="choice-description-input" rows="3" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入选择此选项的说明或提示..."></textarea>
            <p class="text-xs text-slate-500 mt-1">这个说明会显示在选项旁边，帮助玩家理解选择的意义</p>
          </div>

          <!-- 选项管理 -->
          <div class="mb-6" id="choices-section">
            <div class="flex items-center justify-between mb-4">
              <label class="block text-sm font-medium text-slate-700">分支选项</label>
              <button type="button" id="add-choice" class="px-3 py-1 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors text-sm">
                <i class="fa fa-plus mr-1"></i> 添加选项
              </button>
            </div>
            <div id="choices-list" class="space-y-3">
              <!-- 选项将动态添加到这里 -->
            </div>
          </div>

          <!-- 高级设置 -->
          <div class="border-t pt-6">
            <h3 class="text-lg font-semibold mb-4">高级设置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">节点顺序</label>
                <input type="number" id="order-input" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="自动排序">
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script src="assets/js/auth.js"></script>
  <script src="assets/js/api-config.js"></script>
  <script>
    // 全局变量
    let currentNodeId = null;
    let currentStoryId = null;
    let currentNode = null;
    let tinyEditor = null;
    let isPreviewMode = false;

    AuthUI.init();

    // 页面加载时初始化
    window.addEventListener('DOMContentLoaded', function() {
      // 从URL获取参数
      const params = new URLSearchParams(window.location.search);
      currentNodeId = params.get('node');
      currentStoryId = params.get('story');
      
      if (currentNodeId && currentStoryId) {
        // 更新面包屑
        document.getElementById('breadcrumb-story-id').textContent = currentStoryId;
        document.getElementById('breadcrumb-story').href = `story_tree_new.html?story=${currentStoryId}`;
        
        // 初始化编辑器
        initTinyMCE();
        
        // 加载节点数据
        loadNodeData();
        
        // 绑定事件
        bindEvents();
      } else {
        showNotification('缺少必要参数', 'error');
        setTimeout(() => {
          window.location.href = 'my_stories.html';
        }, 2000);
      }
    });

    // 初始化TinyMCE编辑器
    function initTinyMCE() {
      tinymce.init({
        selector: '#content-editor',
        height: 400,
        plugins: [
          'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
          'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
          'insertdatetime', 'media', 'table', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | ' +
          'bold italic forecolor | alignleft aligncenter ' +
          'alignright alignjustify | bullist numlist outdent indent | ' +
          'removeformat | help',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
        setup: function(editor) {
          tinyEditor = editor;
        }
      });
    }

    // 加载节点数据
    async function loadNodeData() {
      try {
        const response = await fetch(API_CONFIG.NODES.getNode(currentNodeId), {
          headers: API_CONFIG.getAuthHeaders()
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            currentNode = result.data;
            populateForm();
            updateNodeInfo();
          }
        } else {
          showNotification('加载节点数据失败', 'error');
        }
      } catch (error) {
        console.error('加载节点数据失败:', error);
        showNotification('网络错误，请重试', 'error');
      }
    }

    // 填充表单
      function populateForm() {
        if (!currentNode) return;
        
        // 基本信息
        document.getElementById('title-input').value = currentNode.title || '';
        document.getElementById('order-input').value = currentNode.order || '';
        
        // 节点类型
        const typeRadio = document.querySelector(`input[name="node-type"][value="${currentNode.type || 'normal'}"]`);
        if (typeRadio) typeRadio.checked = true;
        
        // 内容
        if (tinyEditor && currentNode.content) {
          tinyEditor.setContent(currentNode.content);
        }
        
        // 选项说明（选择节点）- 移除旧数据模型的choiceDescription字段
        if (currentNode.type === 'choice' && currentNode.description) {
          document.getElementById('choice-description-input').value = currentNode.description;
        }
        
        // 选项
        if (currentNode.choices && currentNode.choices.length > 0) {
          currentNode.choices.forEach(choice => {
            addChoiceItem(choice);
          });
        }
        
        updateTypeVisibility();
      }

    // 更新节点信息显示
    function updateNodeInfo() {
      if (!currentNode) return;
      
      document.getElementById('node-title').textContent = currentNode.title || '未命名节点';
      
      // 更新类型标签
      const typeBadge = document.getElementById('node-type-badge');
      const type = currentNode.type || 'normal';
      switch (type) {
        case 'choice':
          typeBadge.className = 'node-type-badge px-3 py-1 text-xs rounded-full bg-amber-100 text-amber-800';
          typeBadge.textContent = '选择节点';
          break;
        case 'ending':
          typeBadge.className = 'node-type-badge px-3 py-1 text-xs rounded-full bg-green-100 text-green-800';
          typeBadge.textContent = '结局节点';
          break;
        default:
          typeBadge.className = 'node-type-badge px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800';
          typeBadge.textContent = '普通节点';
      }
    }

    // 添加选项项
      function addChoiceItem(choice = null) {
        const container = document.getElementById('choices-list');
        const choiceId = choice ? choice.id : 'choice_' + Date.now();
        
        const choiceItem = document.createElement('div');
        choiceItem.className = 'choice-item';
        choiceItem.dataset.choiceId = choiceId;
        
        choiceItem.innerHTML = `
          <div class="flex items-center space-x-2">
            <input type="text" placeholder="选项文本" value="${choice ? choice.text : ''}" class="flex-1 px-3 py-2 border rounded-lg">
            <input type="text" placeholder="目标节点ID（可选）" value="${choice ? choice.targetNodeId : ''}" 
                   class="w-32 px-3 py-2 border rounded-lg target-node-input">
            <label class="flex items-center space-x-1">
              <input type="checkbox" ${choice && choice.autoCreate ? 'checked' : ''} onchange="toggleAutoCreate(this)">
              <span class="text-sm">自动创建分支节点</span>
            </label>
            <button type="button" onclick="removeChoiceItem(this)" class="text-red-500 hover:text-red-700">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        container.appendChild(choiceItem);
      }

    // 切换自动创建选项
    function toggleAutoCreate(checkbox) {
      const choiceItem = checkbox.closest('.choice-item');
      const targetInput = choiceItem.querySelector('input[placeholder*="目标节点ID"]');
      
      if (checkbox.checked) {
        targetInput.value = ''; // 清空目标节点ID
        targetInput.placeholder = '将自动创建分支节点';
        targetInput.disabled = true;
        targetInput.classList.add('bg-slate-50', 'text-slate-500');
      } else {
        targetInput.disabled = false;
        targetInput.placeholder = '目标节点ID (可选，留空则自动创建)';
        targetInput.classList.remove('bg-slate-50', 'text-slate-500');
      }
    }

    // 移除选项项
    function removeChoiceItem(button) {
      button.closest('.choice-item').remove();
    }

    // 更新类型可见性
    function updateTypeVisibility() {
      const nodeType = document.querySelector('input[name="node-type"]:checked').value;
      const contentSection = document.getElementById('content-section');
      const choicesSection = document.getElementById('choices-section');
      const choiceDescriptionSection = document.getElementById('choice-description-section');
      
      if (nodeType === 'choice') {
        // 选择节点需要内容和选项说明，选项通过右键菜单管理
        contentSection.style.display = 'block';
        choicesSection.style.display = 'none';
        choiceDescriptionSection.style.display = 'block';
      } else {
        // 普通节点和结局节点只需要内容
        contentSection.style.display = 'block';
        choicesSection.style.display = 'none';
        choiceDescriptionSection.style.display = 'none';
      }
    }

    // 保存节点
    async function saveNode() {
      try {
        // 收集表单数据
        const formData = {
          title: document.getElementById('title-input').value,
          type: document.querySelector('input[name="node-type"]:checked').value,
          content: tinyEditor ? tinyEditor.getContent() : '',
          order: parseInt(document.getElementById('order-input').value) || 0,
          choices: []
        };
        
        // 如果是选择节点，添加选项说明 - 使用新的description字段
        if (formData.type === 'choice') {
          formData.description = document.getElementById('choice-description-input').value;
        }
        
        // 收集选项数据（仅对选择节点）
        if (formData.type === 'choice') {
          const choiceItems = document.querySelectorAll('.choice-item');
          choiceItems.forEach(item => {
            const textInput = item.querySelector('input[placeholder*="选项文本"]');
            const targetInput = item.querySelector('input[placeholder*="目标节点ID"]');
            const autoCreateCheckbox = item.querySelector('input[type="checkbox"]');
            
            const text = textInput.value.trim();
            const targetNodeId = targetInput.value.trim();
            const autoCreate = autoCreateCheckbox.checked;
            
            if (text) {
              const choice = {
                id: item.dataset.choiceId || 'choice_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                text: text,
                autoCreate: autoCreate
              };
              
              // 如果不是自动创建，设置目标节点ID
              if (!autoCreate && targetNodeId) {
                choice.targetNodeId = targetNodeId;
              } else if (autoCreate) {
                // 自动创建时生成临时ID
                choice.tempTargetNodeId = 'temp_branch_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              }
              
              formData.choices.push(choice);
            }
          });
        }
        
        // 使用普通更新API而不是批量保存，因为我们要保存完整的节点数据包括选项
        const response = await fetch(API_CONFIG.NODES.updateNode(currentNodeId), {
          method: 'PUT',
          headers: API_CONFIG.getAuthHeaders(),
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            showNotification('节点保存成功！', 'success');
            
            // 如果有自动创建的选项，创建对应的节点
            if (formData.choices && formData.choices.length > 0) {
              await createChoiceNodesIfNeeded(formData.choices);
            }
            
            // 更新当前节点数据
            currentNode = result.data;
            updateNodeInfo();
            
            // 通知树状视图更新
            notifyTreeUpdate('node_updated', { nodeId: currentNodeId });
          }
        } else {
          const error = await response.json();
          showNotification(`保存失败: ${error.message}`, 'error');
        }
      } catch (error) {
        console.error('保存节点失败:', error);
        showNotification('网络错误', 'error');
      }
    }

    // 为新选项创建对应的选择节点
    async function createChoiceNodesIfNeeded(choices) {
      for (const choice of choices) {
        // 如果选项没有目标节点，自动创建一个
        if (!choice.targetNodeId) {
          try {
            const response = await fetch(API_CONFIG.NODES.createNode(currentStoryId), {
              method: 'POST',
              headers: API_CONFIG.getAuthHeaders(),
              body: JSON.stringify({
                parentId: currentNodeId,
                title: choice.text,
                content: `这是"${choice.text}"选项对应的内容...`,
                type: 'normal'
              })
            });
            
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                // 更新选项的targetNodeId
                await updateChoiceTargetNodeId(choice.id, result.data._id);
                showNotification(`已为选项"${choice.text}"创建对应节点`, 'success');
              }
            }
          } catch (error) {
            console.error('创建选择节点失败:', error);
          }
        }
      }
    }

    // 更新选项的目标节点ID
    async function updateChoiceTargetNodeId(choiceId, targetNodeId) {
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        await fetch(API_CONFIG.NODES.bindChoice(currentNodeId, choiceId), {
          method: 'PUT',
          headers: API_CONFIG.getAuthHeaders(),
          body: JSON.stringify({ targetNodeId })
        });
      } catch (error) {
        console.error('更新选项目标节点失败:', error);
      }
    }

    // 通知树状视图更新
    function notifyTreeUpdate(action, data) {
      const notification = {
        type: 'story_data_change',
        action: action,
        data: data,
        storyId: currentStoryId,
        timestamp: Date.now()
      };
      
      localStorage.setItem('story_data_notification', JSON.stringify(notification));
      
      // 清理旧通知
      setTimeout(() => {
        localStorage.removeItem('story_data_notification');
      }, 1000);
    }

    // 切换预览模式
    function togglePreview() {
      isPreviewMode = !isPreviewMode;
      const form = document.getElementById('node-form');
      const previewBtn = document.getElementById('preview-toggle');
      
      if (isPreviewMode) {
        form.classList.add('preview-mode');
        previewBtn.innerHTML = '<i class="fa fa-edit mr-2"></i> 编辑';
        if (tinyEditor) tinyEditor.mode.set('readonly');
      } else {
        form.classList.remove('preview-mode');
        previewBtn.innerHTML = '<i class="fa fa-eye mr-2"></i> 预览';
        if (tinyEditor) tinyEditor.mode.set('design');
      }
    }

    // 获取类型标签
    function getTypeLabel(type) {
      switch (type) {
        case 'choice': return '选择节点';
        case 'ending': return '结局节点';
        default: return '普通节点';
      }
    }

    // 绑定事件
    function bindEvents() {
      // 保存按钮
      document.getElementById('save-node').addEventListener('click', saveNode);
      
      // 预览切换
      document.getElementById('preview-toggle').addEventListener('click', togglePreview);
      
      // 添加选项
      document.getElementById('add-choice').addEventListener('click', () => addChoiceItem());
      
      // 节点类型切换
      document.querySelectorAll('input[name="node-type"]').forEach(radio => {
        radio.addEventListener('change', updateTypeVisibility);
      });
      
      // 表单快捷键
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          if (e.key === 's') {
            e.preventDefault();
            saveNode();
          }
        }
      });
    }

    // 通知功能
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center transition-all duration-300 transform translate-y-10 opacity-0`;
      
      if (type === 'success') {
        notification.classList.add('bg-green-50', 'border', 'border-green-200', 'text-green-700');
        notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
      } else if (type === 'error') {
        notification.classList.add('bg-red-50', 'border', 'border-red-200', 'text-red-700');
        notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
      } else {
        notification.classList.add('bg-blue-50', 'border', 'border-blue-200', 'text-blue-700');
        notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
      }
      
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.remove('translate-y-10', 'opacity-0'), 10);
      setTimeout(() => {
        notification.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>