<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- 自动登录检查 -->
    <div id="autoLogin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">正在检查登录状态...</h3>
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>
    </div>

    <div class="min-h-screen">
        <!-- 头部 -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">管理员控制台</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">欢迎，<span id="adminName">管理员</span></span>
                        <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">退出登录</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 导航标签 -->
        <div class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button onclick="showTab('dashboard')" class="nav-tab py-4 px-1 border-b-2 font-medium text-sm active">
                        <i class="fas fa-tachometer-alt mr-2"></i>仪表板
                    </button>
                    <button onclick="showTab('stories')" class="nav-tab py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-book mr-2"></i>作品管理
                    </button>
                    <button onclick="showTab('categories')" class="nav-tab py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-tags mr-2"></i>分类管理
                    </button>
                    <button onclick="showTab('users')" class="nav-tab py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-users mr-2"></i>用户管理
                    </button>
                </nav>
            </div>
        </div>

        <!-- 内容区域 -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 仪表板 -->
            <div id="dashboard" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <i class="fas fa-book text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-semibold text-gray-900">总作品数</h3>
                                <p class="text-2xl font-bold text-blue-600" id="totalStories">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <i class="fas fa-clock text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-semibold text-gray-900">待审核</h3>
                                <p class="text-2xl font-bold text-yellow-600" id="pendingStories">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <i class="fas fa-users text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-semibold text-gray-900">用户总数</h3>
                                <p class="text-2xl font-bold text-green-600" id="totalUsers">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-full">
                                <i class="fas fa-tags text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-semibold text-gray-900">分类总数</h3>
                                <p class="text-2xl font-bold text-purple-600" id="totalCategories">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 作品管理 -->
            <div id="stories" class="tab-content">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">作品管理</h2>
                            <select id="storyFilter" onchange="loadStories()" class="border rounded px-3 py-1">
                                <option value="all">全部</option>
                                <option value="pending">待审核</option>
                                <option value="published">已发布</option>
                                <option value="draft">草稿</option>
                            </select>
                        </div>
                    </div>
                    <div id="storiesContent" class="p-6">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- 分类管理 -->
            <div id="categories" class="tab-content">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">分类管理</h2>
                        <button onclick="openCategoryModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-plus mr-2"></i>添加分类
                        </button>
                    </div>
                    <div id="categoriesContent" class="p-6">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- 用户管理 -->
            <div id="users" class="tab-content">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">用户管理</h2>
                    </div>
                    <div id="usersContent" class="p-6">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 分类模态框 -->
    <div id="categoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">添加分类</h3>
                <form id="categoryForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">分类名称</label>
                        <input type="text" id="categoryName" required class="mt-1 block w-full border rounded-md px-3 py-2" readonly>
                        <p class="text-xs text-gray-500 mt-1" id="categoryNameHint">分类名称在编辑模式下不可修改</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">描述</label>
                        <textarea id="categoryDescription" rows="3" class="mt-1 block w-full border rounded-md px-3 py-2"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">颜色</label>
                        <input type="color" id="categoryColor" value="#3B82F6" class="mt-1 block w-full h-10 border rounded-md">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-tab { border-color: transparent; color: #6B7280; }
        .nav-tab.active { border-color: #3B82F6; color: #3B82F6; }
        .nav-tab:hover { color: #3B82F6; }
        .loading { text-align: center; padding: 20px; color: #6B7280; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #E5E7EB; }
        .data-table th { background-color: #F9FAFB; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-published { background-color: #D1FAE5; color: #065F46; }
        .status-pending { background-color: #FEF3C7; color: #92400E; }
        .status-draft { background-color: #E5E7EB; color: #374151; }
        .status-completed { background-color: #DBEAFE; color: #1E40AF; }
        .status-incomplete { background-color: #FEE2E2; color: #991B1B; }
        .actions { display: flex; gap: 8px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-success { background-color: #10B981; color: white; }
        .btn-danger { background-color: #EF4444; color: white; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-info { background-color: #3B82F6; color: white; }
        .btn-secondary { background-color: #6B7280; color: white; }
    </style>

    <script>
        let currentEditingCategory = null;

        // 获取认证令牌
        function getAuthToken() {
            return localStorage.getItem('token');
        }

        // 自动登录
        async function autoLogin() {
            try {
                const token = localStorage.getItem('token');
                if (token) {
                    // 有token，验证是否有效
                    const response = await fetch('http://localhost:5000/api/v1/admin/stats', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        // token有效，直接进入
                        hideAutoLogin();
                        await initializeAdmin();
                        return;
                    }
                }
                
                // 没有token或token无效，自动登录
                const loginResponse = await fetch('http://localhost:5000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'admin123'
                    })
                });
                
                const loginData = await loginResponse.json();
                if (loginData.success) {
                    localStorage.setItem('token', loginData.data.token);
                    localStorage.setItem('userInfo', JSON.stringify({
                        userId: loginData.data.userId,
                        username: loginData.data.username,
                        email: loginData.data.email,
                        role: 'admin'
                    }));
                    
                    hideAutoLogin();
                    await initializeAdmin();
                } else {
                    throw new Error('自动登录失败');
                }
            } catch (error) {
                document.getElementById('autoLogin').innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4 text-red-600">登录失败</h3>
                        <p class="text-gray-600 mb-4">无法自动登录，请检查服务器状态</p>
                        <button onclick="location.reload()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            重试
                        </button>
                    </div>
                `;
            }
        }

        // 隐藏自动登录界面
        function hideAutoLogin() {
            document.getElementById('autoLogin').style.display = 'none';
        }

        // 初始化管理员页面
        async function initializeAdmin() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            document.getElementById('adminName').textContent = userInfo.username || '管理员';
            await loadDashboard();
        }

        // 检查管理员权限（简化版）
        async function checkAdminAuth() {
            const token = getAuthToken();
            if (!token) {
                throw new Error('未找到登录令牌');
            }
            return true;
        }

        // 切换标签页
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'dashboard': loadDashboard(); break;
                case 'stories': loadStories(); break;
                case 'categories': loadCategories(); break;
                case 'users': loadUsers(); break;
            }
        }

        // 加载仪表板数据
        async function loadDashboard() {
            try {
                const response = await fetch('http://localhost:5000/api/v1/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const data = await response.json();
                const stats = data.data;
                
                document.getElementById('totalStories').textContent = stats.stories.total;
                document.getElementById('pendingStories').textContent = stats.stories.pending;
                document.getElementById('totalUsers').textContent = stats.users.total;
                document.getElementById('totalCategories').textContent = stats.categories.total;
            } catch (error) {
                console.error('加载仪表板数据失败:', error);
            }
        }

        // 加载作品列表
        async function loadStories() {
            const filter = document.getElementById('storyFilter').value;
            document.getElementById('storiesContent').innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/stories?status=${filter}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const data = await response.json();
                const stories = data.data.stories || [];
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>作者</th>
                                <th>发布状态</th>
                                <th>完成状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (stories.length === 0) {
                    html += '<tr><td colspan="6" class="text-center py-4 text-gray-500">暂无作品</td></tr>';
                } else {
                    stories.forEach(story => {
                        const statusClass = story.status === 'published' ? 'status-published' : 
                                           story.status === 'pending' ? 'status-pending' : 'status-draft';
                        const statusText = story.status === 'published' ? '已发布' : 
                                          story.status === 'pending' ? '待审核' : '草稿';
                        
                        const completedClass = story.isCompleted ? 'status-completed' : 'status-incomplete';
                        const completedText = story.isCompleted ? '已完成' : '未完成';
                        
                        html += `
                            <tr>
                                <td>${story.title}</td>
                                <td>${story.author?.username || '未知'}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td><span class="status-badge ${completedClass}">${completedText}</span></td>
                                <td>${new Date(story.createdAt).toLocaleDateString()}</td>
                                <td class="actions">
                                    ${story.status === 'pending' ? `
                                        <button class="btn btn-success" onclick="approveStory('${story._id}')">
                                            <i class="fas fa-check"></i> 通过
                                        </button>
                                        <button class="btn btn-danger" onclick="rejectStory('${story._id}')">
                                            <i class="fas fa-times"></i> 拒绝
                                        </button>
                                    ` : ''}
                                    ${story.status === 'published' ? `
                                        <button class="btn btn-warning" onclick="unpublishStory('${story._id}')" title="下架作品">
                                            <i class="fas fa-arrow-down"></i> 下架
                                        </button>
                                    ` : ''}
                                    ${story.status === 'published' && !story.isCompleted ? `
                                        <button class="btn btn-info" onclick="toggleStoryCompletion('${story._id}', true)" title="标记为已完成">
                                            <i class="fas fa-check-circle"></i> 完成
                                        </button>
                                    ` : ''}
                                    ${story.status === 'published' && story.isCompleted ? `
                                        <button class="btn btn-secondary" onclick="toggleStoryCompletion('${story._id}', false)" title="标记为未完成">
                                            <i class="fas fa-undo"></i> 重置
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-danger" onclick="deleteStory('${story._id}')">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += '</tbody></table>';
                document.getElementById('storiesContent').innerHTML = html;
            } catch (error) {
                console.error('加载作品列表失败:', error);
                document.getElementById('storiesContent').innerHTML = '<div class="text-red-500">加载作品列表失败</div>';
            }
        }

        // 加载分类列表
        async function loadCategories() {
            document.getElementById('categoriesContent').innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                const response = await fetch('http://localhost:5000/api/v1/categories', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const data = await response.json();
                const categories = data.data || [];
                
                let html = `
                    <div class="mb-4">
                        <button class="btn btn-danger" onclick="batchDeleteCategories()" id="batchDeleteBtn" style="display: none;">
                            <i class="fas fa-trash"></i> 批量删除选中
                        </button>
                        <button class="btn btn-secondary ml-2" onclick="toggleAllCategories()">
                            <i class="fas fa-check-square"></i> 全选/取消全选
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllCategories" onchange="toggleAllCategories()">
                                </th>
                                <th>分类名称</th>
                                <th>描述</th>
                                <th>故事数量</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (categories.length === 0) {
                    html += '<tr><td colspan="5" class="text-center py-4 text-gray-500">暂无分类</td></tr>';
                } else {
                    categories.forEach(category => {
                        html += `
                            <tr>
                                <td>
                                    <input type="checkbox" class="category-checkbox" value="${category._id}" onchange="updateBatchDeleteButton()">
                                </td>
                                <td>${category.name}</td>
                                <td>${category.description || '-'}</td>
                                <td>${category.storyCount || 0}</td>
                                <td class="actions">
                                    <button class="btn btn-warning" onclick="editCategory('${category._id}')">
                                        <i class="fas fa-edit"></i> 编辑
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteCategory('${category._id}')">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += '</tbody></table>';
                document.getElementById('categoriesContent').innerHTML = html;
            } catch (error) {
                console.error('加载分类列表失败:', error);
                document.getElementById('categoriesContent').innerHTML = '<div class="text-red-500">加载分类列表失败</div>';
            }
        }

        // 加载用户列表
        async function loadUsers() {
            document.getElementById('usersContent').innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                const response = await fetch('http://localhost:5000/api/v1/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const data = await response.json();
                const users = data.data.users || [];
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>状态</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (users.length === 0) {
                    html += '<tr><td colspan="6" class="text-center py-4 text-gray-500">暂无用户</td></tr>';
                } else {
                    users.forEach(user => {
                        const isActiveClass = user.isActive ? 'text-green-600' : 'text-red-600';
                        const isActiveText = user.isActive ? '活跃' : '禁用';
                        
                        html += `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>
                                    <span class="px-2 py-1 text-xs rounded-full ${
                                        user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 
                                        user.role === 'editor' ? 'bg-blue-100 text-blue-800' : 
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${user.role === 'admin' ? '管理员' : user.role === 'editor' ? '编辑' : '普通用户'}
                                    </span>
                                </td>
                                <td class="${isActiveClass}">${isActiveText}</td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td class="actions">
                                    <button class="btn btn-warning" onclick="toggleUserStatus('${user.id}')">
                                        <i class="fas fa-ban"></i> ${user.isActive ? '禁用' : '启用'}
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.username}')">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += '</tbody></table>';
                document.getElementById('usersContent').innerHTML = html;
            } catch (error) {
                console.error('加载用户列表失败:', error);
                document.getElementById('usersContent').innerHTML = '<div class="text-red-500">加载用户列表失败</div>';
            }
        }

        // 分类模态框操作
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.remove('hidden');
            document.getElementById('categoryForm').reset();
            currentEditingCategory = null;
            document.querySelector('#categoryModal h3').textContent = '添加分类';
            document.querySelector('#categoryModal button[type="submit"]').textContent = '保存';
            
            // 添加模式：分类名可编辑
            document.getElementById('categoryName').readOnly = false;
            document.getElementById('categoryName').classList.remove('bg-gray-100');
            document.getElementById('categoryNameHint').style.display = 'none';
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
            currentEditingCategory = null;
        }

        // 编辑分类
        async function editCategory(categoryId) {
            try {
                // 获取分类详情
                const response = await fetch(`http://localhost:5000/api/v1/categories/${categoryId}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取分类信息失败');
                }
                
                const data = await response.json();
                const category = data.data;
                
                // 设置编辑模式
                currentEditingCategory = categoryId;
                document.getElementById('categoryModal').classList.remove('hidden');
                document.querySelector('#categoryModal h3').textContent = '编辑分类';
                document.querySelector('#categoryModal button[type="submit"]').textContent = '更新';
                
                // 编辑模式：分类名只读
                document.getElementById('categoryName').readOnly = true;
                document.getElementById('categoryName').classList.add('bg-gray-100');
                document.getElementById('categoryNameHint').style.display = 'block';
                
                // 填充表单数据
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                
            } catch (error) {
                console.error('编辑分类失败:', error);
                alert('获取分类信息失败');
            }
        }

        document.getElementById('categoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value
            };
            
            try {
                let response;
                if (currentEditingCategory) {
                    // 编辑模式：使用PUT请求
                    response = await fetch(`http://localhost:5000/api/v1/categories/${currentEditingCategory}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(categoryData)
                    });
                } else {
                    // 添加模式：使用POST请求
                    response = await fetch('http://localhost:5000/api/v1/categories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(categoryData)
                    });
                }
                
                if (response.ok) {
                    closeCategoryModal();
                    loadCategories();
                } else {
                    const errorData = await response.json();
                    alert('保存分类失败: ' + (errorData.message || '未知错误'));
                }
            } catch (error) {
                console.error('保存分类失败:', error);
                alert('保存分类失败');
            }
        });

        // 其他功能函数（简化版本）
        async function approveStory(storyId) {
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/stories/${storyId}/review`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ action: 'approve' })
                });
                if (response.ok) {
                    alert('作品审核通过');
                    loadStories();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '审核失败');
                }
            } catch (error) {
                console.error('审核作品失败:', error);
                alert('审核失败，请重试');
            }
        }

        async function rejectStory(storyId) {
            const reason = prompt('请输入拒绝理由（可选）:');
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/stories/${storyId}/review`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ action: 'reject', reason: reason || '' })
                });
                if (response.ok) {
                    alert('作品已拒绝');
                    loadStories();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '拒绝失败');
                }
            } catch (error) {
                console.error('拒绝作品失败:', error);
                alert('拒绝失败，请重试');
            }
        }

        async function deleteStory(storyId) {
            if (!confirm('确定要删除这个作品吗？')) return;
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/stories/${storyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                if (response.ok) {
                    loadStories();
                }
            } catch (error) {
                console.error('删除作品失败:', error);
            }
        }

        // 下架作品
        async function unpublishStory(storyId) {
            if (!confirm('确定要下架这个作品吗？下架后作品将变为草稿状态，用户可以重新编辑提交。')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/stories/${storyId}/unpublish`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    alert('作品下架成功');
                    loadStories(); // 重新加载作品列表
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '下架失败');
                }
            } catch (error) {
                console.error('下架作品失败:', error);
                alert('下架失败，请重试');
            }
        }

        // 切换故事完成状态
        async function toggleStoryCompletion(storyId, isCompleted) {
            const action = isCompleted ? '标记为已完成' : '标记为未完成';
            if (!confirm(`确定要${action}这个作品吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/stories/${storyId}/completion`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ isCompleted })
                });
                
                if (response.ok) {
                    alert(`${action}成功`);
                    loadStories(); // 重新加载作品列表
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || `${action}失败`);
                }
            } catch (error) {
                console.error(`${action}失败:`, error);
                alert(`${action}失败，请重试`);
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('确定要删除这个分类吗？此操作不可撤销！')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/categories/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    alert('分类删除成功');
                    loadCategories();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '删除分类失败');
                }
            } catch (error) {
                console.error('删除分类失败:', error);
                alert('删除分类失败，请重试');
            }
        }

        async function updateUserRole(userId, newRole) {
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                if (response.ok) {
                    loadUsers();
                }
            } catch (error) {
                console.error('更新用户角色失败:', error);
            }
        }

        async function toggleUserStatus(userId) {
            try {
                // 先获取当前用户信息
                const userResponse = await fetch(`http://localhost:5000/api/v1/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const userData = await userResponse.json();
                const users = userData.data.users || [];
                const currentUser = users.find(u => u.id === userId);
                
                if (!currentUser) {
                    alert('用户不存在');
                    return;
                }
                
                const action = currentUser.isActive ? '禁用' : '启用';
                const confirmMessage = currentUser.isActive ? 
                    `确定要禁用用户 "${currentUser.username}" 吗？禁用后用户将无法登录系统。` :
                    `确定要启用用户 "${currentUser.username}" 吗？`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/v1/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ isActive: !currentUser.isActive })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || `用户${action}成功`);
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || `${action}用户失败`);
                }
            } catch (error) {
                console.error('更新用户状态失败:', error);
                alert('更新用户状态失败，请重试');
            }
        }

        async function deleteUser(userId, username) {
            const confirmMessage = `确定要删除用户 "${username}" 吗？此操作不可撤销！\n\n注意：如果该用户还有故事，将无法删除。`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || '用户删除成功');
                    loadUsers(); // 重新加载用户列表
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '删除用户失败');
                }
            } catch (error) {
                console.error('删除用户失败:', error);
                alert('删除用户失败，请重试');
            }
        }

        // 批量删除相关函数
        function toggleAllCategories() {
            const selectAll = document.getElementById('selectAllCategories');
            const checkboxes = document.querySelectorAll('.category-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateBatchDeleteButton();
        }

        function updateBatchDeleteButton() {
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectAll = document.getElementById('selectAllCategories');
            
            if (checkboxes.length > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchDeleteBtn.textContent = `批量删除选中 (${checkboxes.length})`;
            } else {
                batchDeleteBtn.style.display = 'none';
            }
            
            // 更新全选框状态
            const allCheckboxes = document.querySelectorAll('.category-checkbox');
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        async function batchDeleteCategories() {
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('请选择要删除的分类');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${checkboxes.length} 个分类吗？此操作不可撤销！`)) {
                return;
            }
            
            const categoryIds = Array.from(checkboxes).map(cb => cb.value);
            let successCount = 0;
            let failCount = 0;
            
            for (const categoryId of categoryIds) {
                try {
                    const response = await fetch(`http://localhost:5000/api/v1/categories/${categoryId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error('删除分类失败:', error);
                    failCount++;
                }
            }
            
            // 显示结果
            if (successCount > 0 && failCount === 0) {
                alert(`成功删除 ${successCount} 个分类`);
            } else if (successCount > 0 && failCount > 0) {
                alert(`删除完成：成功 ${successCount} 个，失败 ${failCount} 个`);
            } else {
                alert(`删除失败，请重试`);
            }
            
            // 重新加载分类列表
            loadCategories();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userInfo');
            window.location.reload();
        }

        // 页面加载时自动登录
        window.addEventListener('load', function() {
            autoLogin();
            
            // 初始化表单提交事件监听器
            document.getElementById('categoryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('categoryName').value.trim();
                const description = document.getElementById('categoryDescription').value.trim();
                
                if (!name) {
                    alert('请输入分类名称');
                    return;
                }
                
                try {
                    const token = getAuthToken();
                    let url = 'http://localhost:5000/api/v1/categories';
                    let method = 'POST';
                    let requestBody = { name, description };
                    
                    // 如果是编辑模式，使用PUT请求，只发送描述字段
                    if (currentEditingCategory) {
                        url = `http://localhost:5000/api/v1/categories/${currentEditingCategory}`;
                        method = 'PUT';
                        requestBody = { description }; // 编辑模式下只更新描述
                    }
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert(currentEditingCategory ? '编辑添加成功' : '添加成功');
                        closeCategoryModal();
                        loadCategories();
                    } else {
                        alert(data.message || '操作失败');
                    }
                } catch (error) {
                    console.error('保存分类失败:', error);
                    alert('操作失败，请重试');
                }
            });
        });
    </script>
</body>
</html>