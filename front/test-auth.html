<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录状态测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">登录状态测试页面</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">当前存储状态</h2>
            <div id="storage-status"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">AuthUI 检测结果</h2>
            <div id="authui-status"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">操作</h2>
            <div class="space-y-4">
                <button onclick="testLogin()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    模拟登录
                </button>
                <button onclick="clearStorage()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    清除存储
                </button>
                <button onclick="checkAuthUI()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    检查AuthUI
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">AuthUI 渲染测试</h2>
            <div id="auth-area-desktop" class="mb-4"></div>
            <div id="auth-area-mobile" class="mb-4"></div>
        </div>
    </div>

    <script src="assets/js/auth.js"></script>
    <script>
        function updateStorageStatus() {
            const status = document.getElementById('storage-status');
            const storages = [
                { name: 'localStorage', storage: window.localStorage },
                { name: 'sessionStorage', storage: window.sessionStorage }
            ];

            let html = '';
            storages.forEach(({ name, storage }) => {
                html += `<div class="mb-4"><h3 class="font-medium">${name}:</h3>`;
                const keys = ['token', 'refreshToken', 'userInfo'];
                keys.forEach(key => {
                    const value = storage.getItem(key);
                    if (value) {
                        if (key === 'userInfo') {
                            const parsed = JSON.parse(value);
                            html += `<div class="ml-4 text-sm"><strong>${key}:</strong> ${JSON.stringify(parsed, null, 2)}</div>`;
                        } else {
                            html += `<div class="ml-4 text-sm"><strong>${key}:</strong> ${value.substring(0, 20)}...</div>`;
                        }
                    } else {
                        html += `<div class="ml-4 text-sm text-gray-500"><strong>${key}:</strong> (空)</div>`;
                    }
                });
                html += '</div>';
            });
            status.innerHTML = html;
        }

        function checkAuthUI() {
            const status = document.getElementById('authui-status');
            const authState = window.AuthUI.getAuthState();
            
            if (authState) {
                status.innerHTML = `
                    <div class="text-green-600">
                        <p><strong>检测到登录状态</strong></p>
                        <p>用户名: ${authState.userInfo.username}</p>
                        <p>邮箱: ${authState.userInfo.email}</p>
                        <p>头像: ${authState.userInfo.avatar}</p>
                        <p>存储类型: ${authState.storage === window.localStorage ? 'localStorage' : 'sessionStorage'}</p>
                    </div>
                `;
            } else {
                status.innerHTML = '<div class="text-red-600">未检测到登录状态</div>';
            }
        }

        function testLogin() {
            const mockLoginData = {
                userId: '6918b8ef9c2aa5c9bb46407b',
                username: 'admin',
                email: 'admin@example.com',
                avatar: '/avatar/default.png',
                token: 'mock-token-' + Date.now(),
                refreshToken: 'mock-refresh-' + Date.now()
            };

            // 存储到localStorage (模拟真实登录)
            window.localStorage.setItem('token', mockLoginData.token);
            window.localStorage.setItem('refreshToken', mockLoginData.refreshToken);
            window.localStorage.setItem('userInfo', JSON.stringify({
                userId: mockLoginData.userId,
                username: mockLoginData.username,
                email: mockLoginData.email,
                avatar: mockLoginData.avatar
            }));

            updateStorageStatus();
            checkAuthUI();
            
            // 重新初始化AuthUI
            if (window.authUIInstance) {
                window.authUIInstance.render();
            }
        }

        function clearStorage() {
            window.AuthUI.clearAuthStorage();
            updateStorageStatus();
            checkAuthUI();
            if (window.authUIInstance) {
                window.authUIInstance.render();
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStorageStatus();
            checkAuthUI();
            
            // 初始化AuthUI
            window.authUIInstance = window.AuthUI.init();
        });
    </script>
</body>
</html>