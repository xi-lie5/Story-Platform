<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整登录测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/auth.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">完整登录测试流程</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">当前状态</h2>
            <div id="current-status" class="text-sm"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">一键完整测试</h2>
            <button onclick="runFullTest()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                开始完整测试流程
            </button>
            <div id="test-log" class="mt-4 text-sm space-y-2"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">手动操作</h2>
            <div class="space-x-4">
                <button onclick="step1_login()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    1. 登录
                </button>
                <button onclick="step2_check()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                    2. 检查状态
                </button>
                <button onclick="step3_redirect()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    3. 跳转首页
                </button>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const testLog = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            testLog.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            testLog.scrollTop = testLog.scrollHeight;
        }

        function updateCurrentStatus() {
            const authState = window.AuthUI.getAuthState();
            const statusDiv = document.getElementById('current-status');
            
            if (authState) {
                statusDiv.innerHTML = `
                    <div class="text-green-600 font-medium">✓ 已登录</div>
                    <div>用户名: ${authState.userInfo.username}</div>
                    <div>邮箱: ${authState.userInfo.email}</div>
                    <div>头像: ${authState.userInfo.avatar}</div>
                    <div>存储类型: ${authState.storage === window.localStorage ? 'localStorage' : 'sessionStorage'}</div>
                `;
            } else {
                statusDiv.innerHTML = '<div class="text-red-600 font-medium">✗ 未登录</div>';
            }
        }

        async function step1_login() {
            log('步骤1: 开始登录...');
            try {
                const response = await fetch('http://localhost:5000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: 'admin@example.com', 
                        password: 'admin123' 
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || '登录失败');
                }

                // 存储登录信息
                localStorage.setItem('token', result.data.token);
                localStorage.setItem('refreshToken', result.data.refreshToken);
                localStorage.setItem('userInfo', JSON.stringify({
                    userId: result.data.userId,
                    username: result.data.username,
                    email: result.data.email,
                    avatar: result.data.avatar
                }));
                localStorage.setItem('username', result.data.username);

                log(`登录成功！用户: ${result.data.username}`, 'success');
                log(`头像路径: ${result.data.avatar}`, 'info');
                updateCurrentStatus();
                
                return true;
            } catch (error) {
                log(`登录失败: ${error.message}`, 'error');
                return false;
            }
        }

        function step2_check() {
            log('步骤2: 检查认证状态...');
            const authState = window.AuthUI.getAuthState();
            
            if (authState) {
                log(`检测到登录状态: ${authState.userInfo.username}`, 'success');
                
                // 测试头像URL
                const avatarUrl = window.AuthUI.resolveAvatarUrl(authState.userInfo.avatar, authState.userInfo.username);
                log(`头像URL: ${avatarUrl}`, 'info');
                
                // 测试图片加载
                const img = new Image();
                img.onload = () => log('头像图片加载成功！', 'success');
                img.onerror = () => log('头像图片加载失败', 'error');
                img.src = avatarUrl;
                
                return true;
            } else {
                log('未检测到登录状态', 'error');
                return false;
            }
        }

        function step3_redirect() {
            log('步骤3: 准备跳转到首页...');
            const authState = window.AuthUI.getAuthState();
            
            if (authState) {
                log('有登录状态，正在跳转到首页...', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                return true;
            } else {
                log('没有登录状态，无法跳转', 'error');
                return false;
            }
        }

        async function runFullTest() {
            log('=== 开始完整测试流程 ===');
            
            // 步骤1: 登录
            const loginSuccess = await step1_login();
            if (!loginSuccess) {
                log('=== 测试失败：登录步骤失败 ===', 'error');
                return;
            }
            
            // 等待1秒
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 步骤2: 检查状态
            const checkSuccess = step2_check();
            if (!checkSuccess) {
                log('=== 测试失败：状态检查失败 ===', 'error');
                return;
            }
            
            // 等待1秒
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 步骤3: 跳转
            step3_redirect();
            
            log('=== 测试流程执行完成 ===', 'success');
        }

        // 页面加载时更新状态
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentStatus();
            
            // 每3秒更新一次状态
            setInterval(updateCurrentStatus, 3000);
        });
    </script>
</body>
</html>