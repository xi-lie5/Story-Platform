<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>故事编辑器测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-bold mb-6 text-center">故事编辑器功能测试</h1>
            
            <!-- 登录状态检查 -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">1. 登录状态检查</h2>
                <div id="login-status" class="text-sm"></div>
                <button onclick="checkLoginStatus()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    检查登录状态
                </button>
            </div>
            
            <!-- 故事列表 -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">2. 故事列表</h2>
                <div id="stories-list" class="text-sm mb-2"></div>
                <button onclick="loadStories()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    加载故事列表
                </button>
            </div>
            
            <!-- 节点测试 -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">3. 节点测试</h2>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">故事ID:</label>
                    <input type="text" id="test-story-id" class="w-full px-3 py-2 border rounded" placeholder="输入故事ID">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">节点ID:</label>
                    <input type="text" id="test-node-id" class="w-full px-3 py-2 border rounded" placeholder="输入节点ID">
                </div>
                <div class="space-x-2">
                    <button onclick="testGetNode()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        测试获取节点
                    </button>
                    <button onclick="testGetStoryNodes()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        测试获取故事节点
                    </button>
                </div>
                <div id="node-test-result" class="mt-3 text-sm"></div>
            </div>
            
            <!-- 快速链接 -->
            <div class="mb-6 p-4 bg-amber-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">4. 快速访问</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openEditor()" class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600">
                        <i class="fa fa-edit mr-2"></i>打开编辑器
                    </button>
                    <button onclick="openStoryTree()" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">
                        <i class="fa fa-sitemap mr-2"></i>节点图谱
                    </button>
                </div>
            </div>
            
            <!-- 测试结果 -->
            <div class="p-4 bg-gray-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">5. 测试日志</h2>
                <div id="test-log" class="text-xs font-mono bg-gray-900 text-green-400 p-3 rounded h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script src="assets/js/auth.js"></script>
    <script src="assets/js/api-config.js"></script>
    <script>
        let testStories = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-400';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function checkLoginStatus() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo') || sessionStorage.getItem('userInfo');
            const statusDiv = document.getElementById('login-status');
            
            if (token && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    statusDiv.innerHTML = `<span class="text-green-600">✅ 已登录 - ${user.username || user.email}</span>`;
                    log(`用户已登录: ${user.username || user.email}`, 'success');
                } catch (e) {
                    statusDiv.innerHTML = '<span class="text-red-600">❌ 登录数据错误</span>';
                    log('登录数据格式错误', 'error');
                }
            } else {
                statusDiv.innerHTML = '<span class="text-red-600">❌ 未登录</span>';
                log('用户未登录', 'error');
            }
        }
        
        async function loadStories() {
            try {
                log('开始加载故事列表...');
                const response = await fetch(API_CONFIG.STORIES.getStories(), {
                    headers: API_CONFIG.getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.stories) {
                        testStories = result.data.stories;
                        const listDiv = document.getElementById('stories-list');
                        listDiv.innerHTML = `<span class="text-green-600">✅ 找到 ${testStories.length} 个故事</span>`;
                        
                        // 填充第一个故事的ID到测试输入框
                        if (testStories.length > 0) {
                            document.getElementById('test-story-id').value = testStories[0]._id;
                            log(`加载成功，找到 ${testStories.length} 个故事`, 'success');
                        } else {
                            log('没有找到任何故事', 'error');
                        }
                    } else {
                        log('故事列表格式错误', 'error');
                    }
                } else {
                    const error = await response.json();
                    log(`加载失败: ${error.message}`, 'error');
                }
            } catch (error) {
                log(`网络错误: ${error.message}`, 'error');
            }
        }
        
        async function testGetNode() {
            const nodeId = document.getElementById('test-node-id').value;
            if (!nodeId) {
                log('请输入节点ID', 'error');
                return;
            }
            
            try {
                log(`测试获取节点: ${nodeId}`);
                const response = await fetch(API_CONFIG.NODES.getNode(nodeId), {
                    headers: API_CONFIG.getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('node-test-result').innerHTML = 
                            `<span class="text-green-600">✅ 节点获取成功: ${result.data.title}</span>`;
                        log(`节点获取成功: ${result.data.title}`, 'success');
                    } else {
                        log(`节点获取失败: ${result.message}`, 'error');
                    }
                } else {
                    const error = await response.json();
                    log(`节点获取错误: ${error.message}`, 'error');
                }
            } catch (error) {
                log(`网络错误: ${error.message}`, 'error');
            }
        }
        
        async function testGetStoryNodes() {
            const storyId = document.getElementById('test-story-id').value;
            if (!storyId) {
                log('请输入故事ID', 'error');
                return;
            }
            
            try {
                log(`测试获取故事节点: ${storyId}`);
                const response = await fetch(API_CONFIG.NODES.getStoryNodes(storyId), {
                    headers: API_CONFIG.getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const nodeCount = result.data ? result.data.length : 0;
                        document.getElementById('node-test-result').innerHTML = 
                            `<span class="text-green-600">✅ 找到 ${nodeCount} 个节点</span>`;
                        log(`故事节点获取成功，找到 ${nodeCount} 个节点`, 'success');
                        
                        // 如果有节点，填充第一个节点ID
                        if (result.data && result.data.length > 0) {
                            document.getElementById('test-node-id').value = result.data[0]._id;
                        }
                    } else {
                        log(`故事节点获取失败: ${result.message}`, 'error');
                    }
                } else {
                    const error = await response.json();
                    log(`故事节点获取错误: ${error.message}`, 'error');
                }
            } catch (error) {
                log(`网络错误: ${error.message}`, 'error');
            }
        }
        
        function openEditor() {
            const storyId = document.getElementById('test-story-id').value;
            const nodeId = document.getElementById('test-node-id').value;
            
            if (!storyId || !nodeId) {
                log('请先输入故事ID和节点ID', 'error');
                return;
            }
            
            const url = `story_editor_new.html?node=${nodeId}&story=${storyId}`;
            log(`打开编辑器: ${url}`, 'info');
            window.open(url, '_blank');
        }
        
        function openStoryTree() {
            const storyId = document.getElementById('test-story-id').value;
            
            if (!storyId) {
                log('请先输入故事ID', 'error');
                return;
            }
            
            const url = `story_tree_new.html?story=${storyId}`;
            log(`打开节点图谱: ${url}`, 'info');
            window.open(url, '_blank');
        }
        
        // 页面加载时自动检查
        window.addEventListener('DOMContentLoaded', function() {
            AuthUI.init();
            checkLoginStatus();
            log('测试页面加载完成', 'info');
        });
    </script>
</body>
</html>