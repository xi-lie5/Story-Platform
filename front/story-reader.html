<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">æ•…äº‹é˜…è¯»å™¨ - StoryForge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/navbar.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#ec4899',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            display: ['Playfair Display', 'serif'],
            serif: ['Georgia', 'Cambria', 'serif']
          },
        },
      }
    }
  </script>
  <style type="tailwindcss">
    @layer utilities {
      .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .animate-fade-in { animation: fadeIn 0.6s ease-in-out; }
      .animate-slide-up { animation: slideUp 0.4s ease-out; }
      .choice-card { transition: all 0.3s ease; }
      .choice-card:hover { transform: translateY(-2px); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">
  <!-- å¯¼èˆªæ  -->
  <nav class="sticky top-0 z-50 bg-white/98 backdrop-blur-md border-b border-slate-200 shadow-sm">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <a href="index.html" class="flex items-center space-x-2">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-xl flex items-center justify-center shadow-lg">
            <i class="fa fa-book text-white text-lg"></i>
          </div>
          <h1 class="text-xl md:text-2xl font-display font-bold text-gray-900">StoryForge</h1>
          </a>
        </div>
        
        <nav class="hidden md:flex items-center space-x-8" id="main-nav-desktop">
          <a href="index.html" class="text-slate-600 hover:text-primary font-medium transition-colors">é¦–é¡µ</a>
          <a href="browse.html" class="text-slate-600 hover:text-primary font-medium transition-colors">æ•…äº‹é˜…è§ˆ</a>
          <a href="create.html" class="text-slate-600 hover:text-primary font-medium transition-colors user-only" style="display: none;">åˆ›å»ºæ•…äº‹</a>
          <a href="my_stories.html" class="text-slate-600 hover:text-primary font-medium transition-colors user-only" style="display: none;">æˆ‘çš„ä½œå“</a>
          <a href="review.html" class="text-slate-600 hover:text-primary font-medium transition-colors admin-only" style="display: none;">æ•…äº‹å®¡æ ¸</a>
          <a href="profile.html" class="text-slate-600 hover:text-primary font-medium transition-colors">ä¸ªäººä¸­å¿ƒ</a>
        </nav>
        
        <!-- è®¤è¯åŒºåŸŸ -->
        <div id="auth-area-desktop" class="hidden md:flex items-center space-x-3"></div>
        
        <!-- é˜…è¯»å™¨æ§åˆ¶æŒ‰é’® -->
        <div class="flex items-center space-x-2">
          <button id="back-btn" title="è¿”å›" aria-label="è¿”å›" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-arrow-left"></i>
          </button>
          <button id="font-size-btn" title="å­—ä½“å¤§å°" aria-label="å­—ä½“å¤§å°" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-font"></i>
          </button>
          <button id="theme-btn" title="ä¸»é¢˜åˆ‡æ¢" aria-label="ä¸»é¢˜åˆ‡æ¢" class="hidden p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-adjust"></i>
          </button>
          
          <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
          <button id="mobile-menu-button" aria-label="èœå•" class="md:hidden p-2 rounded-lg hover:bg-slate-100 transition-colors">
              <i class="fa fa-bars text-slate-600 text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯èœå• -->
    <div class="md:hidden hidden bg-white/95 backdrop-blur-md border-t border-slate-200" id="mobile-menu">
      <div class="container mx-auto px-4 py-4 space-y-3">
        <a href="index.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">é¦–é¡µ</a>
        <a href="browse.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">æ•…äº‹é˜…è§ˆ</a>
        <a href="create.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary user-only" style="display: none;">åˆ›å»ºæ•…äº‹</a>
        <a href="my_stories.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary user-only" style="display: none;">æˆ‘çš„ä½œå“</a>
        <a href="review.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary admin-only" style="display: none;">æ•…äº‹å®¡æ ¸</a>
        <a href="profile.html" class="block py-3 px-4 rounded-lg font-medium text-slate-600 hover:bg-slate-50 hover:text-primary">ä¸ªäººä¸­å¿ƒ</a>
        <div class="flex flex-col space-y-3 pt-3 border-t border-slate-200">
          <div id="auth-area-mobile">
            <!-- AuthUIä¼šåŠ¨æ€æ¸²æŸ“ç§»åŠ¨ç«¯ç™»å½•çŠ¶æ€æˆ–ç”¨æˆ·ä¿¡æ¯ -->
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <main class="container mx-auto max-w-4xl px-4 py-8">
    <!-- æ•…äº‹ä¿¡æ¯å¤´éƒ¨ -->
    <header class="bg-white rounded-2xl shadow-sm p-6 mb-8 animate-fade-in">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div class="flex-1">
          <h1 id="story-title" class="text-2xl md:text-3xl font-display font-bold mb-3">åŠ è½½ä¸­...</h1>
          
          <!-- æ•…äº‹å…ƒä¿¡æ¯ -->
          <div id="story-meta" class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mb-3">
            <span id="author-info" class="flex items-center gap-2">
              <i class="fa fa-user"></i>
              <span>åŠ è½½ä¸­...</span>
            </span>
            <span id="category-info" class="flex items-center gap-2">
              <i class="fa fa-tag"></i>
              <span>åŠ è½½ä¸­...</span>
            </span>
            <span id="created-time" class="flex items-center gap-2">
              <i class="fa fa-calendar"></i>
              <span>åŠ è½½ä¸­...</span>
            </span>
          </div>
          
          <!-- èŠ‚ç‚¹å’Œé˜…è¯»æ—¶é—´ä¿¡æ¯ -->
          <div class="flex items-center gap-4 text-sm text-slate-500">
            <span id="node-info" class="flex items-center gap-1">
              <i class="fa fa-code-fork"></i>
              <span>èŠ‚ç‚¹ 1</span>
            </span>
            <span id="reading-time" class="flex items-center gap-1">
              <i class="fa fa-clock-o"></i>
              <span>çº¦1åˆ†é’Ÿé˜…è¯»</span>
            </span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="bookmark-btn" title="æ”¶è—" aria-label="æ”¶è—" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-bookmark-o"></i>
          </button>
          <button id="share-btn" title="åˆ†äº«" aria-label="åˆ†äº«" class="p-2 rounded-full border border-slate-200 text-slate-600 hover:border-primary hover:text-primary transition-colors">
            <i class="fa fa-share-alt"></i>
          </button>
        </div>
      </div>
      
      <!-- è¿›åº¦æ¡ -->
      <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-secondary rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </header>

    <!-- æ•…äº‹å†…å®¹åŒºåŸŸ -->
    <section class="bg-white rounded-2xl shadow-sm p-6 md:p-8 mb-8 animate-slide-up">
      <article id="story-content" class="font-serif text-lg leading-relaxed">
        <div class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
          <span class="ml-3 text-slate-600">æ­£åœ¨åŠ è½½æ•…äº‹å†…å®¹...</span>
        </div>
      </article>
    </section>

    <!-- é€‰æ‹©åŒºåŸŸ -->
    <section id="choices-section" class="bg-white rounded-2xl shadow-sm p-6 md:p-8 mb-8 hidden animate-slide-up">
      <h2 class="text-xl font-bold mb-6 text-center">ä½ ä¼šå¦‚ä½•é€‰æ‹©ï¼Ÿ</h2>
      <div id="choices-container" class="space-y-4">
        <!-- é€‰æ‹©æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </section>

    <!-- å¯¼èˆªåŒºåŸŸ -->
    <nav id="navigation-section" class="bg-white rounded-2xl shadow-sm p-6 mb-8 hidden animate-slide-up">
      <div class="flex justify-between items-center">
        <button id="prev-node-btn" class="flex items-center gap-2 px-4 py-2 border border-slate-200 rounded-lg hover:border-primary hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fa fa-chevron-left"></i>
          <span>è¿”å›ä¸Šä¸€èŠ‚ç‚¹</span>
        </button>
        
        <div class="text-center">
          <p class="text-sm text-slate-600 mb-2">é˜…è¯»è·¯å¾„</p>
          <div id="path-indicator" class="flex items-center justify-center gap-2">
            <!-- è·¯å¾„æŒ‡ç¤ºå™¨å°†åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        
        <button id="restart-btn" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          <i class="fa fa-refresh"></i>
          <span>é‡æ–°å¼€å§‹</span>
        </button>
      </div>
    </nav>
  </main>

  <!-- å­—ä½“å¤§å°é€‰æ‹©å™¨ -->
  <div id="font-size-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4">
      <h3 class="text-lg font-bold mb-4">å­—ä½“å¤§å°</h3>
      <div class="space-y-2">
        <button class="w-full p-3 text-left rounded-lg hover:bg-slate-50 transition-colors" data-size="small">
          <span class="text-sm">å°å·å­—ä½“</span>
        </button>
        <button class="w-full p-3 text-left rounded-lg hover:bg-slate-50 transition-colors border border-primary" data-size="medium">
          <span class="text-base">ä¸­å·å­—ä½“ï¼ˆé»˜è®¤ï¼‰</span>
        </button>
        <button class="w-full p-3 text-left rounded-lg hover:bg-slate-50 transition-colors" data-size="large">
          <span class="text-lg">å¤§å·å­—ä½“</span>
        </button>
      </div>
      <button id="close-font-modal" class="mt-4 w-full p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
        å…³é—­
      </button>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="assets/js/auth.js"></script>
  <script>
    // åˆå§‹åŒ–AuthUI
    AuthUI.init();

    // ç§»åŠ¨ç«¯èœå•åŠŸèƒ½
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // å…¨å±€å˜é‡
    let currentStory = null;
    let currentNode = null;
    let readingHistory = [];
    let fontSize = 'medium';
    let isDarkMode = false;

    // å·¥å…·å‡½æ•°
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        storyId: params.get('storyId') || params.get('id'), // æ”¯æŒstoryIdå’Œidä¸¤ç§å‚æ•°
        nodeId: params.get('node') || 'root'
      };
    }

    function updateUrl(storyId, nodeId) {
      const url = new URL(window.location);
      url.searchParams.set('id', storyId);
      url.searchParams.set('node', nodeId);
      window.history.pushState({}, '', url);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center transition-all duration-300 transform translate-y-10 opacity-0`;

      if (type === 'success') {
        notification.classList.add('bg-green-50', 'border', 'border-green-200', 'text-green-700');
        notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
      } else if (type === 'error') {
        notification.classList.add('bg-red-50', 'border', 'border-red-200', 'text-red-700');
        notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
      } else {
        notification.classList.add('bg-blue-50', 'border', 'border-blue-200', 'text-blue-700');
        notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
      }

      document.body.appendChild(notification);
      setTimeout(() => notification.classList.remove('translate-y-10', 'opacity-0'), 10);
      setTimeout(() => {
        notification.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // APIè°ƒç”¨å‡½æ•°
    async function loadStoryData(storyId) {
      try {
        const response = await fetch(`http://localhost:5000/api/v1/stories/${storyId}`);
        if (!response.ok) {
          throw new Error('æ•…äº‹ä¸å­˜åœ¨');
        }
        const data = await response.json();
        if (data.success && data.data) {
          currentStory = data.data;
          
          // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œæ•…äº‹ä¿¡æ¯
          const storyTitle = currentStory.title || 'æ•…äº‹';
          document.getElementById('page-title').textContent = `${storyTitle} - StoryForge`;
          
          // æ›´æ–°æ•…äº‹å¤´éƒ¨ä¿¡æ¯
          updateStoryHeader(currentStory);
          
          // å¦‚æœæœ‰èŠ‚ç‚¹æ•°æ®ï¼Œè®¡ç®—æ€»èŠ‚ç‚¹æ•°
          if (currentStory.nodes && Array.isArray(currentStory.nodes)) {
            currentStory.totalNodes = currentStory.nodes.length;
          }
          
          return currentStory;
        }
        return null;
      } catch (error) {
        console.error('åŠ è½½æ•…äº‹æ•°æ®å¤±è´¥:', error);
        showNotification('åŠ è½½æ•…äº‹å¤±è´¥: ' + error.message, 'error');
        return null;
      }
    }
    
    // æ›´æ–°æ•…äº‹å¤´éƒ¨ä¿¡æ¯
    function updateStoryHeader(story) {
      // æ›´æ–°ä½œè€…ä¿¡æ¯
      const authorInfo = document.getElementById('author-info');
      if (authorInfo) {
        const authorName = story.author?.username || story.author?.name || 'æœªçŸ¥ä½œè€…';
        authorInfo.innerHTML = `
          <i class="fa fa-user"></i>
          <span>${escapeHtml(authorName)}</span>
        `;
      }
      
      // æ›´æ–°åˆ†ç±»ä¿¡æ¯
      const categoryInfo = document.getElementById('category-info');
      if (categoryInfo) {
        const categoryName = story.category?.name || 'æœªåˆ†ç±»';
        categoryInfo.innerHTML = `
          <i class="fa fa-tag"></i>
          <span>${escapeHtml(categoryName)}</span>
        `;
      }
      
      // æ›´æ–°åˆ›ä½œæ—¶é—´
      const createdTime = document.getElementById('created-time');
      if (createdTime && story.createdAt) {
        const date = new Date(story.createdAt);
        const formattedDate = date.toLocaleDateString('zh-CN', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        createdTime.innerHTML = `
          <i class="fa fa-calendar"></i>
          <span>${formattedDate}</span>
        `;
      }
    }

    async function loadStoryNodes(storyId) {
      try {
        console.log('ğŸ” å¼€å§‹åŠ è½½æ•…äº‹èŠ‚ç‚¹ï¼ŒstoryId:', storyId);
        const url = `http://localhost:5000/api/v1/storyNodes/public/stories/${storyId}/nodes`;
        console.log('ğŸ” è¯·æ±‚URL:', url);
        
        // å°è¯•è·å–tokenï¼ˆå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼‰
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = {
          'Content-Type': 'application/json'
        };
        if (token) {
          // ç¡®ä¿tokenä¸åŒ…å«Bearerå‰ç¼€
          const cleanToken = token.startsWith('Bearer ') ? token.substring(7) : token;
          headers['Authorization'] = `Bearer ${cleanToken}`;
        }
        
        const response = await fetch(url, {
          headers: headers
        });
        console.log('ğŸ” å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('ğŸ” å“åº”é”™è¯¯:', errorText);
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            errorData = { message: 'æ— æ³•åŠ è½½æ•…äº‹èŠ‚ç‚¹' };
          }
          throw new Error(errorData.message || 'æ— æ³•åŠ è½½æ•…äº‹èŠ‚ç‚¹');
        }
        
        const result = await response.json();
        console.log('ğŸ” å“åº”æ•°æ®:', result);
        
        if (result.success) {
          return result.data;
        } else {
          throw new Error(result.message || 'åŠ è½½èŠ‚ç‚¹å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½æ•…äº‹èŠ‚ç‚¹å¤±è´¥:', error);
        showNotification('åŠ è½½æ•…äº‹èŠ‚ç‚¹å¤±è´¥', 'error');
        return [];
      }
    }

    // èŠ‚ç‚¹åŠ è½½å’Œæ¸²æŸ“
    async function loadNode(storyId, nodeId) {
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const contentEl = document.getElementById('story-content');
        contentEl.innerHTML = `
          <div class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <span class="ml-3 text-slate-600">æ­£åœ¨åŠ è½½èŠ‚ç‚¹å†…å®¹...</span>
          </div>
        `;
        
        // åŠ è½½æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ï¼ˆåŒ…å«åˆ†æ”¯ä¿¡æ¯ï¼‰
        const nodes = await loadStoryNodes(storyId);
        if (!nodes || nodes.length === 0) {
          throw new Error('æ²¡æœ‰æ‰¾åˆ°æ•…äº‹èŠ‚ç‚¹');
        }

        console.log('åŠ è½½çš„èŠ‚ç‚¹æ•°æ®:', nodes);
        console.log('æŸ¥æ‰¾èŠ‚ç‚¹ID:', nodeId);

        // æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹
        let targetNode = null;
        if (nodeId === 'root' || nodeId === null || nodeId === undefined) {
          // æŸ¥æ‰¾æ ¹èŠ‚ç‚¹ï¼ˆä½¿ç”¨isRootå­—æ®µï¼‰
          targetNode = nodes.find(node => node.isRoot === true || node.isRoot === 1);
          if (!targetNode) {
            // å¦‚æœæ²¡æœ‰isRootå­—æ®µï¼ŒæŸ¥æ‰¾parentIdä¸ºnullçš„èŠ‚ç‚¹
          targetNode = nodes.find(node => !node.parentId);
          }
          if (!targetNode) {
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹
            targetNode = nodes[0];
          }
        } else {
          // æŸ¥æ‰¾æŒ‡å®šIDçš„èŠ‚ç‚¹
          targetNode = nodes.find(node => 
            node.id === nodeId || 
            node._id === nodeId || 
            node.temporaryId === nodeId ||
            String(node.id) === String(nodeId)
          );
        }

        if (!targetNode) {
          throw new Error('èŠ‚ç‚¹ä¸å­˜åœ¨');
        }

        console.log('æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹:', targetNode);

        // æ›´æ–°å½“å‰èŠ‚ç‚¹
        currentNode = targetNode;
        
        // æ·»åŠ åˆ°é˜…è¯»å†å²ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
        const existingHistory = readingHistory.find(h => 
          h.nodeId === targetNode.id || 
          h.nodeId === targetNode._id ||
          h.nodeId === targetNode.temporaryId
        );
        
        if (!existingHistory) {
          readingHistory.push({
            nodeId: targetNode.id || targetNode._id || targetNode.temporaryId,
            title: targetNode.title,
            timestamp: new Date()
          });
        } else {
          // å¦‚æœå·²å­˜åœ¨ï¼Œç§»é™¤ä¹‹åçš„æ‰€æœ‰å†å²è®°å½•ï¼ˆå®ç°è¿”å›åŠŸèƒ½ï¼‰
          const index = readingHistory.findIndex(h => 
            h.nodeId === targetNode.id || 
            h.nodeId === targetNode._id ||
            h.nodeId === targetNode.temporaryId
          );
          if (index !== -1 && index < readingHistory.length - 1) {
            readingHistory = readingHistory.slice(0, index + 1);
          }
        }

        // æ›´æ–°URL
        updateUrl(storyId, targetNode.id || targetNode._id || targetNode.temporaryId);
        
        // æ¸²æŸ“èŠ‚ç‚¹å†…å®¹
        renderNode(targetNode);
        
        // æ›´æ–°å¯¼èˆª
        updateNavigation();
        
        // æ›´æ–°è¿›åº¦
        updateProgress();

      } catch (error) {
        console.error('åŠ è½½èŠ‚ç‚¹å¤±è´¥:', error);
        showNotification('åŠ è½½èŠ‚ç‚¹å¤±è´¥: ' + error.message, 'error');
        const contentEl = document.getElementById('story-content');
        contentEl.innerHTML = `
          <div class="text-center py-12">
            <i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
            <p class="text-red-600 mb-2">åŠ è½½èŠ‚ç‚¹å¤±è´¥</p>
            <p class="text-sm text-slate-500">${error.message}</p>
            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
              é‡æ–°åŠ è½½
            </button>
          </div>
        `;
      }
    }

    // æ¸²æŸ“èŠ‚ç‚¹å†…å®¹
    function renderNode(node) {
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      const nodeTitle = node.title || 'æœªå‘½åèŠ‚ç‚¹';
      document.getElementById('page-title').textContent = `${nodeTitle} - StoryForge`;
      document.getElementById('story-title').textContent = nodeTitle;
      
      // æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯
      document.getElementById('node-info').innerHTML = `
        <i class="fa fa-code-fork"></i>
        <span>èŠ‚ç‚¹ ${node.order || readingHistory.length || 1}</span>
      `;
      
      // è®¡ç®—é˜…è¯»æ—¶é—´ï¼ˆå‡è®¾æ¯åˆ†é’Ÿ200å­—ï¼‰
      const contentLength = node.content ? node.content.length : 0;
      const readingMinutes = Math.max(1, Math.ceil(contentLength / 200));
      document.getElementById('reading-time').innerHTML = `
        <i class="fa fa-clock-o"></i>
        <span>çº¦${readingMinutes}åˆ†é’Ÿé˜…è¯»</span>
      `;
      
      // æ›´æ–°å†…å®¹
      const contentEl = document.getElementById('story-content');
      if (node.content && node.content.trim()) {
        // å¤„ç†å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œå’Œæ®µè½
        const contentHtml = node.content
          .split('\n')
          .filter(line => line.trim())
          .map(line => `<p class="mb-6 leading-relaxed">${escapeHtml(line)}</p>`)
          .join('');
        
      contentEl.innerHTML = `
        <div class="prose prose-lg max-w-none">
            ${contentHtml}
          </div>
        `;
      } else {
        contentEl.innerHTML = `
          <div class="text-center py-12 text-slate-500">
            <i class="fa fa-file-text-o text-4xl mb-4"></i>
            <p>æš‚æ— å†…å®¹</p>
        </div>
      `;
      }
      
      // æ¸²æŸ“é€‰æ‹©ï¼ˆåˆ†æ”¯ï¼‰
      renderChoices(node);
      
      // å¤„ç†ç»“æŸèŠ‚ç‚¹
      if (node.type === 'end' || (!node.choices || node.choices.length === 0)) {
        // å¦‚æœæ˜¯ç»“æŸèŠ‚ç‚¹æˆ–æ²¡æœ‰é€‰æ‹©ï¼Œæ˜¾ç¤ºç»“æŸæç¤º
        const choicesSection = document.getElementById('choices-section');
        choicesSection.classList.add('hidden');
        
        // æ˜¾ç¤ºç»“æŸæç¤º
        if (node.type === 'end') {
          contentEl.innerHTML += `
            <div class="mt-8 p-6 bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl border border-primary/20 text-center">
              <i class="fa fa-flag-checkered text-3xl text-primary mb-3"></i>
              <h3 class="text-xl font-bold text-gray-900 mb-2">æ•…äº‹ç»“æŸ</h3>
              <p class="text-slate-600 mb-4">æ„Ÿè°¢é˜…è¯»è¿™ä¸ªæ•…äº‹ï¼</p>
            </div>
          `;
        }
      }
      
      // åº”ç”¨å­—ä½“å¤§å°
      applyFontSize();
    }
    
    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // æ¸²æŸ“é€‰æ‹©æŒ‰é’®
    function renderChoices(node) {
      const choicesSection = document.getElementById('choices-section');
      const choicesContainer = document.getElementById('choices-container');
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©é¡¹
      const choices = node.choices || [];
      
      if (choices.length === 0 || node.type === 'end') {
        choicesSection.classList.add('hidden');
        return;
      }
      
      choicesSection.classList.remove('hidden');
      choicesContainer.innerHTML = '';
      
      choices.forEach((choice, index) => {
        const choiceCard = document.createElement('div');
        choiceCard.className = 'choice-card p-6 bg-slate-50 rounded-xl border-2 border-slate-200 hover:border-primary hover:bg-primary/5 cursor-pointer transition-all';
        
        const choiceText = choice.text || choice.context || 'ç»§ç»­';
        const targetNodeId = choice.targetNodeId || choice.target_node_id;
        
        choiceCard.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-primary to-secondary text-white rounded-full flex items-center justify-center font-bold text-lg shadow-md">
              ${String.fromCharCode(65 + index)}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg mb-2 text-gray-900">${escapeHtml(choiceText)}</h3>
              ${choice.description ? `<p class="text-slate-600 text-sm">${escapeHtml(choice.description)}</p>` : ''}
              ${choice.targetNode && choice.targetNode.title ? `<p class="text-xs text-slate-500 mt-2">â†’ ${escapeHtml(choice.targetNode.title)}</p>` : ''}
            </div>
            <div class="flex-shrink-0 pt-1">
              <i class="fa fa-chevron-right text-slate-400 text-xl"></i>
            </div>
          </div>
        `;
        
        choiceCard.addEventListener('click', () => {
          if (targetNodeId) {
            choiceCard.classList.add('opacity-75');
            handleChoice(choice, node);
          } else {
            showNotification('è¯¥é€‰æ‹©æš‚æ— åç»­å†…å®¹', 'info');
          }
        });
        
        choicesContainer.appendChild(choiceCard);
      });
    }

    // å¤„ç†é€‰æ‹©
    async function handleChoice(choice, currentNode) {
      const targetNodeId = choice.targetNodeId || choice.target_node_id;
      
      if (!targetNodeId) {
        showNotification('è¯¥é€‰æ‹©æš‚æ— åç»­å†…å®¹', 'info');
        return;
      }
      
      console.log('å¤„ç†é€‰æ‹©:', choice);
      console.log('å½“å‰èŠ‚ç‚¹:', currentNode);
      console.log('ç›®æ ‡èŠ‚ç‚¹ID:', targetNodeId);
      
      const params = getUrlParams();
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      showNotification('æ­£åœ¨åŠ è½½ä¸‹ä¸€ä¸ªèŠ‚ç‚¹...', 'info');
      
      // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // åŠ è½½ç›®æ ‡èŠ‚ç‚¹
      await loadNode(params.storyId, targetNodeId);
    }

    // æ›´æ–°å¯¼èˆª
    function updateNavigation() {
      const navSection = document.getElementById('navigation-section');
      const prevBtn = document.getElementById('prev-node-btn');
      const pathIndicator = document.getElementById('path-indicator');
      
      // åªæœ‰åœ¨ä¸æ˜¯æ ¹èŠ‚ç‚¹æ—¶æ‰æ˜¾ç¤ºå¯¼èˆª
      if (readingHistory.length > 1) {
      navSection.classList.remove('hidden');
      } else {
        navSection.classList.add('hidden');
      }
      
      // æ›´æ–°è¿”å›æŒ‰é’®çŠ¶æ€
      if (readingHistory.length <= 1) {
        prevBtn.disabled = true;
        prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        prevBtn.disabled = false;
        prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        prevBtn.onclick = () => {
          // ä»é˜…è¯»å†å²ä¸­ç§»é™¤å½“å‰èŠ‚ç‚¹ï¼Œè¿”å›åˆ°ä¸Šä¸€ä¸ªèŠ‚ç‚¹
          readingHistory.pop(); // ç§»é™¤å½“å‰èŠ‚ç‚¹
          const prevNode = readingHistory[readingHistory.length - 1];
          if (prevNode) {
          const params = getUrlParams();
          loadNode(params.storyId, prevNode.nodeId);
          }
        };
      }
      
      // æ›´æ–°è·¯å¾„æŒ‡ç¤ºå™¨ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªèŠ‚ç‚¹ï¼‰
      const displayHistory = readingHistory.slice(-5);
      pathIndicator.innerHTML = displayHistory.map((item, index) => {
        const actualIndex = readingHistory.length - displayHistory.length + index;
        const isLast = actualIndex === readingHistory.length - 1;
        const displayTitle = item.title && item.title.length > 10 
          ? item.title.substring(0, 10) + '...' 
          : item.title || 'èŠ‚ç‚¹';
        
        return `
          <div class="flex items-center gap-1" title="${escapeHtml(item.title || 'èŠ‚ç‚¹')}">
            <div class="w-2 h-2 rounded-full ${isLast ? 'bg-primary ring-2 ring-primary/30' : 'bg-slate-300'} transition-all"></div>
            ${index < displayHistory.length - 1 ? '<i class="fa fa-chevron-right text-xs text-slate-400"></i>' : ''}
        </div>
        `;
      }).join('');
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress() {
      const progressBar = document.getElementById('progress-bar');
      
      // å¦‚æœæœ‰å½“å‰æ•…äº‹æ•°æ®ï¼Œä½¿ç”¨æ€»èŠ‚ç‚¹æ•°è®¡ç®—è¿›åº¦
      if (currentStory && currentStory.totalNodes) {
        const progress = Math.min((readingHistory.length / currentStory.totalNodes) * 100, 100);
        progressBar.style.width = `${progress}%`;
      } else {
        // å¦åˆ™æ ¹æ®é˜…è¯»å†å²é•¿åº¦ä¼°ç®—ï¼ˆå‡è®¾å¹³å‡æ•…äº‹æœ‰10ä¸ªèŠ‚ç‚¹ï¼‰
        const estimatedTotalNodes = 10;
        const progress = Math.min((readingHistory.length / estimatedTotalNodes) * 100, 100);
      progressBar.style.width = `${progress}%`;
      }
    }

    // å­—ä½“å¤§å°ç®¡ç†
    function applyFontSize() {
      const contentEl = document.getElementById('story-content');
      contentEl.classList.remove('text-base', 'text-lg', 'text-xl');
      
      switch (fontSize) {
        case 'small':
          contentEl.classList.add('text-base');
          break;
        case 'medium':
          contentEl.classList.add('text-lg');
          break;
        case 'large':
          contentEl.classList.add('text-xl');
          break;
      }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–AuthUI
      if (typeof AuthUI !== 'undefined') {
        AuthUI.init({
          desktopContainer: 'auth-area-desktop',
          mobileContainer: 'auth-area-mobile',
          showAvatar: true,
          showName: true,
          avatarSize: 'medium'
        });
      }
      
      // æ ¹æ®ç”¨æˆ·è§’è‰²æ›´æ–°å¯¼èˆªæ 
      if (typeof updateNavigationByRole === 'function') {
        setTimeout(updateNavigationByRole, 300);
      }
      
      // åˆå§‹åŒ–
      const params = getUrlParams();
      if (!params.storyId) {
        showNotification('ç¼ºå°‘æ•…äº‹ID', 'error');
        const contentEl = document.getElementById('story-content');
        contentEl.innerHTML = `
          <div class="text-center py-12">
            <i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
            <p class="text-red-600 mb-2">ç¼ºå°‘æ•…äº‹ID</p>
            <p class="text-sm text-slate-500 mb-4">è¯·åœ¨URLä¸­åŒ…å«æ•…äº‹IDå‚æ•°</p>
            <a href="browse.html" class="inline-block px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
              è¿”å›æ•…äº‹åˆ—è¡¨
            </a>
          </div>
        `;
        return;
      }
      
      // å…ˆåŠ è½½æ•…äº‹åŸºæœ¬ä¿¡æ¯
      await loadStoryData(params.storyId);
      
      // ç„¶ååŠ è½½èŠ‚ç‚¹
      await loadNode(params.storyId, params.nodeId || 'root');
      
      // è¿”å›æŒ‰é’®
      document.getElementById('back-btn').addEventListener('click', () => {
        window.history.back();
      });
      
      // å­—ä½“å¤§å°æŒ‰é’®
      document.getElementById('font-size-btn').addEventListener('click', () => {
        document.getElementById('font-size-modal').classList.remove('hidden');
      });
      
      // å­—ä½“å¤§å°é€‰æ‹©
      document.querySelectorAll('[data-size]').forEach(btn => {
        btn.addEventListener('click', () => {
          fontSize = btn.dataset.size;
          applyFontSize();
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.querySelectorAll('[data-size]').forEach(b => {
            b.classList.remove('border', 'border-primary');
          });
          btn.classList.add('border', 'border-primary');
          
          document.getElementById('font-size-modal').classList.add('hidden');
        });
      });
      
      // å…³é—­å­—ä½“æ¨¡æ€æ¡†
      document.getElementById('close-font-modal').addEventListener('click', () => {
        document.getElementById('font-size-modal').classList.add('hidden');
      });
      
      // ä¸»é¢˜åˆ‡æ¢
      document.getElementById('theme-btn').addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark');
        showNotification(isDarkMode ? 'å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼', 'info');
      });
      
      // é‡æ–°å¼€å§‹
      document.getElementById('restart-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹é˜…è¯»å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰çš„é˜…è¯»è¿›åº¦ã€‚')) {
        readingHistory = [];
        const params = getUrlParams();
        loadNode(params.storyId, 'root');
          showNotification('å·²é‡æ–°å¼€å§‹', 'info');
        }
      });
      
      // æ”¶è—æŒ‰é’®
      document.getElementById('bookmark-btn').addEventListener('click', () => {
        const icon = document.querySelector('#bookmark-btn i');
        if (icon.classList.contains('fa-bookmark-o')) {
          icon.classList.remove('fa-bookmark-o');
          icon.classList.add('fa-bookmark');
          showNotification('å·²æ·»åŠ ä¹¦ç­¾', 'success');
        } else {
          icon.classList.remove('fa-bookmark');
          icon.classList.add('fa-bookmark-o');
          showNotification('å·²ç§»é™¤ä¹¦ç­¾', 'info');
        }
      });
      
      // åˆ†äº«æŒ‰é’®
      document.getElementById('share-btn').addEventListener('click', () => {
        const url = window.location.href;
        if (navigator.share) {
          navigator.share({
            title: currentNode.title,
            text: 'æ¥é˜…è¯»è¿™ä¸ªç²¾å½©çš„æ•…äº‹ï¼',
            url: url
          });
        } else {
          navigator.clipboard.writeText(url);
          showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }
      });
      
      // æµè§ˆå™¨åé€€/å‰è¿›
      window.addEventListener('popstate', () => {
        const params = getUrlParams();
        loadNode(params.storyId, params.nodeId);
      });
    });
  </script>
</body>
</html>