# 数据库连接池最佳连接数测试

## max连接数为50
PS E:\github\Story-Platform\backend>  autocannon -c 400 -d 40 -I "http://localhost:5000/api/v1/stories"  
Running 40s test @ http://localhost:5000/api/v1/stories
400 connections

running [=====               ] 22%(node:8332) TimeoutNegativeWarning: -4 is a negative number.
Timeout duration was set to 1.
(Use `node --trace-warnings ...` to show where the warning was created)

┌─────────┬───────┬───────┬────────┬────────┬───────────┬───────────┬──────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5%  │ 99%    │ Avg       │ Stdev     │ Max      │
├─────────┼───────┼───────┼────────┼────────┼───────────┼───────────┼──────────┤
│ Latency │ 15 ms │ 95 ms │ 194 ms │ 313 ms │ 101.03 ms │ 281.83 ms │ 10168 ms │
└─────────┴───────┴───────┴────────┴────────┴───────────┴───────────┴──────────┘
┌───────────┬─────┬──────┬─────────┬─────────┬──────────┬──────────┬────────┐
│ Stat      │ 1%  │ 2.5% │ 50%     │ 97.5%   │ Avg      │ Stdev    │ Min    │
├───────────┼─────┼──────┼─────────┼─────────┼──────────┼──────────┼────────┤
│ Req/Sec   │ 0   │ 0    │ 4,315   │ 4,879   │ 3,319.25 │ 1,797.46 │ 240    │
├───────────┼─────┼──────┼─────────┼─────────┼──────────┼──────────┼────────┤
│ Bytes/Sec │ 0 B │ 0 B  │ 8.09 MB │ 9.15 MB │ 6.22 MB  │ 3.37 MB  │ 450 kB │
└───────────┴─────┴──────┴─────────┴─────────┴──────────┴──────────┴────────┘

Req/Bytes counts sampled once per second.

133k requests in 40.68s, 249 MB read
267 errors (267 timeouts)
PS E:\github\Story-Platform\backend> 

## max 连接数为30
这是连接数为30的数据
PS E:\github\Story-Platform\backend> autocannon -c 400 -d 40 -I "http://localhost:5000/api/v1/stories"  
Running 40s test @ http://localhost:5000/api/v1/stories
400 connections


┌─────────┬──────┬────────┬────────┬────────┬───────────┬───────────┬─────────┐
│ Stat    │ 2.5% │ 50%    │ 97.5%  │ 99%    │ Avg       │ Stdev     │ Max     │
├─────────┼──────┼────────┼────────┼────────┼───────────┼───────────┼─────────┤
│ Latency │ 1 ms │ 194 ms │ 718 ms │ 761 ms │ 180.74 ms │ 204.85 ms │ 1060 ms │
└─────────┴──────┴────────┴────────┴────────┴───────────┴───────────┴─────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬──────────┬──────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg      │ Stdev    │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼──────────┼─────────┤
│ Req/Sec   │ 774     │ 774     │ 2,763   │ 3,255   │ 2,190.85 │ 1,036.44 │ 774     │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼──────────┼─────────┤
│ Bytes/Sec │ 1.45 MB │ 1.45 MB │ 5.18 MB │ 6.11 MB │ 4.11 MB  │ 1.94 MB  │ 1.45 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴──────────┴──────────┴─────────┘

Req/Bytes counts sampled once per second.

88k requests in 40.29s, 164 MB read
PS E:\github\Story-Platform\backend> 

## max 连接数为100
这是连接数为100的数据
PS E:\github\Story-Platform\backend>  autocannon -c 400 -d 40 -I "http://localhost:5000/api/v1/stories"  
Running 40s test @ http://localhost:5000/api/v1/stories
400 connections


┌─────────┬───────┬────────┬────────┬────────┬───────────┬──────────┬────────┐
│ Stat    │ 2.5%  │ 50%    │ 97.5%  │ 99%    │ Avg       │ Stdev    │ Max    │
├─────────┼───────┼────────┼────────┼────────┼───────────┼──────────┼────────┤
│ Latency │ 44 ms │ 142 ms │ 438 ms │ 469 ms │ 118.43 ms │ 86.99 ms │ 565 ms │
└─────────┴───────┴────────┴────────┴────────┴───────────┴──────────┴────────┘
┌───────────┬────────┬────────┬─────────┬─────────┬──────────┬──────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg      │ Stdev    │ Min    │
├───────────┼────────┼────────┼─────────┼─────────┼──────────┼──────────┼────────┤
│ Req/Sec   │ 1,228  │ 1,228  │ 3,887   │ 4,041   │ 3,361.15 │ 1,037.82 │ 1,228  │
├───────────┼────────┼────────┼─────────┼─────────┼──────────┼──────────┼────────┤
│ Bytes/Sec │ 2.3 MB │ 2.3 MB │ 7.29 MB │ 7.58 MB │ 6.3 MB   │ 1.95 MB  │ 2.3 MB │
└───────────┴────────┴────────┴─────────┴─────────┴──────────┴──────────┴────────┘

Req/Bytes counts sampled once per second.

135k requests in 40.21s, 252 MB read
PS E:\github\Story-Platform\backend> 



## 简单评估

简单性能评估（连接池对比）
连接池	吞吐 (Req/Sec)	平均延迟	超时错误	综合评价
30	2,191	181 ms	0	❌ 性能不足：吞吐最低，延迟高，仅适合低负载。
60	3,319	101 ms	267 次	⚠️ 高风险高性能：平均延迟最低，但有大量超时和 10 秒卡顿，不适合生产。
100	3,361	118 ms	0	✅ 最佳选择：吞吐最高、零错误、延迟稳定，推荐用于生产环境。
💎 结论
在不使用缓存的情况下，连接池 = 100 是最优配置——它在保持高吞吐的同时，完全避免了超时错误，系统表现最可靠。


# 引入node cache 内存缓存

## max 连接数为60
连接池数量为60的数据

PS E:\github\Story-Platform\backend> autocannon -c 400 -d 40 -I "http://localhost:5000/api/v1/stories"       
Running 40s test @ http://localhost:5000/api/v1/stories
400 connections

running [=====               ] 22%(node:7552) TimeoutNegativeWarning: -4 is a negative number.
Timeout duration was set to 1.
(Use `node --trace-warnings ...` to show where the warning was created)

┌─────────┬──────┬───────┬────────┬────────┬──────────┬───────────┬─────────┐
│ Stat    │ 2.5% │ 50%   │ 97.5%  │ 99%    │ Avg      │ Stdev     │ Max     │
├─────────┼──────┼───────┼────────┼────────┼──────────┼───────────┼─────────┤
│ Latency │ 2 ms │ 26 ms │ 214 ms │ 229 ms │ 76.87 ms │ 157.01 ms │ 9995 ms │
└─────────┴──────┴───────┴────────┴────────┴──────────┴───────────┴─────────┘
┌───────────┬────────┬────────┬────────┬─────────┬─────────┬──────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%    │ 97.5%   │ Avg     │ Stdev    │ Min    │
├───────────┼────────┼────────┼────────┼─────────┼─────────┼──────────┼────────┤
│ Req/Sec   │ 327    │ 327    │ 4,639  │ 5,219   │ 3,987   │ 1,450.55 │ 327    │
├───────────┼────────┼────────┼────────┼─────────┼─────────┼──────────┼────────┤
│ Bytes/Sec │ 613 kB │ 613 kB │ 8.7 MB │ 9.79 MB │ 7.47 MB │ 2.72 MB  │ 613 kB │
└───────────┴────────┴────────┴────────┴─────────┴─────────┴──────────┴────────┘

Req/Bytes counts sampled once per second.

160k requests in 40.21s, 299 MB read
361 errors (361 timeouts)
PS E:\github\Story-Platform\backend> 

## max 连接数为100
下面是连接池数量为100的数据
PS E:\github\Story-Platform\backend> autocannon -c 400 -d 40 -I "http://localhost:5000/api/v1/stories"   
Running 40s test @ http://localhost:5000/api/v1/stories
400 connections


┌─────────┬───────┬────────┬────────┬────────┬───────────┬──────────┬────────┐
│ Stat    │ 2.5%  │ 50%    │ 97.5%  │ 99%    │ Avg       │ Stdev    │ Max    │
├─────────┼───────┼────────┼────────┼────────┼───────────┼──────────┼────────┤
│ Latency │ 85 ms │ 106 ms │ 348 ms │ 395 ms │ 127.35 ms │ 71.23 ms │ 474 ms │
└─────────┴───────┴────────┴────────┴────────┴───────────┴──────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬──────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev    │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┤
│ Req/Sec   │ 1,144   │ 1,144   │ 3,875   │ 4,017   │ 3,127.8 │ 1,140.89 │ 1,144   │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┤
│ Bytes/Sec │ 2.15 MB │ 2.15 MB │ 7.27 MB │ 7.53 MB │ 5.86 MB │ 2.14 MB  │ 2.15 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴──────────┴─────────┘

Req/Bytes counts sampled once per second.


125k requests in 40.19s, 235 MB read
PS E:\github\Story-Platform\backend> 

##  max连接数为30
下面是连接池数量为30
PS E:\github\Story-Platform\backend>  autocannon -c 400 -d 40 -I "http://localhost:5000/api/v1/stories"  
Running 40s test @ http://localhost:5000/api/v1/stories
400 connections


┌─────────┬──────┬────────┬────────┬────────┬───────────┬───────────┬─────────┐
│ Stat    │ 2.5% │ 50%    │ 97.5%  │ 99%    │ Avg       │ Stdev     │ Max     │
├─────────┼──────┼────────┼────────┼────────┼───────────┼───────────┼─────────┤
│ Latency │ 3 ms │ 186 ms │ 444 ms │ 582 ms │ 157.77 ms │ 287.53 ms │ 9983 ms │
└─────────┴──────┴────────┴────────┴────────┴───────────┴───────────┴─────────┘
┌───────────┬─────┬──────┬─────────┬─────────┬──────────┬──────────┬─────────┐
│ Stat      │ 1%  │ 2.5% │ 50%     │ 97.5%   │ Avg      │ Stdev    │ Min     │
├───────────┼─────┼──────┼─────────┼─────────┼──────────┼──────────┼─────────┤
│ Req/Sec   │ 0   │ 0    │ 1,979   │ 4,547   │ 1,882.08 │ 1,247.58 │ 891     │
├───────────┼─────┼──────┼─────────┼─────────┼──────────┼──────────┼─────────┤
│ Bytes/Sec │ 0 B │ 0 B  │ 3.71 MB │ 8.53 MB │ 3.53 MB  │ 2.34 MB  │ 1.67 MB │
└───────────┴─────┴──────┴─────────┴─────────┴──────────┴──────────┴─────────┘

Req/Bytes counts sampled once per second.

76k requests in 40.3s, 141 MB read
345 errors (345 timeouts)
PS E:\github\Story-Platform\backend> 

## 数据对比（有node cache）

有缓存压测结果汇总表
指标	连接池 = 30（有缓存）	连接池 = 60（有缓存）	连接池 = 100（有缓存）
总请求数	76,000	160,000	125,000
平均吞吐 (Req/Sec)	1,882	3,987	3,128
平均延迟	157.77 ms	76.87 ms	127.35 ms
中位数延迟 (50%)	186 ms	26 ms	106 ms
99% 延迟	582 ms	229 ms	395 ms
最大延迟	9,983 ms	9,995 ms	474 ms
超时错误数	345	361	0
稳定性（Stdev）	287.53 ms	157.01 ms	71.23 ms

## 有无缓存的对比

有缓存 vs 无缓存性能对比（按连接池分组）
连接池	指标	无缓存	有缓存	变化
30	吞吐 (Req/Sec)	2,191	1,882	↓ -14%
平均延迟	180.74 ms	157.77 ms	↓ -13%
超时错误数	0	345	❌ 从 0 暴增至 345
最大延迟	1,060 ms	9,983 ms	↑↑ 恶化近 10 倍
60	吞吐 (Req/Sec)	3,319	3,987	↑ +20%
平均延迟	101.03 ms	76.87 ms	↓ -24%
超时错误数	267	361	↑ +35%
最大延迟	10,168 ms	9,995 ms	≈ 持平（仍极差）
100	吞吐 (Req/Sec)	3,361	3,128	↓ -7%
平均延迟	118.43 ms	127.35 ms	↑ +8%
超时错误数	0	0	✅ 稳定
最大延迟	565 ms	474 ms	↓ 改善
延迟标准差	86.99 ms	71.23 ms	✅ 更稳定

## 总结

node cache带来了一定的性能提升，但是远低于预期值

