# 架构文档

## 1. 技术架构概述

StoryForge采用了前后端分离的技术架构，前端使用HTML5、CSS3、JavaScript (ES6+)和Tailwind CSS框架，后端使用Node.js、Express框架和MongoDB数据库。系统架构遵循了MVC设计模式，将业务逻辑、数据模型和视图分离，提高了系统的可维护性和可扩展性。

### 1.1 架构设计原则

- **前后端分离**：前端负责展示和交互，后端负责业务逻辑和数据存储
- **模块化设计**：将系统划分为多个功能模块，提高代码复用性和可维护性
- **松耦合**：模块之间通过接口通信，降低模块间的依赖关系
- **可扩展性**：支持水平扩展，能够应对不断增长的用户量和数据量
- **安全性**：实现完善的安全机制，包括身份验证、授权、数据加密等
- **高性能**：优化系统性能，提高响应速度和并发处理能力

### 1.2 架构分层

StoryForge的架构分为以下几层：

1. **表示层**：前端界面，负责用户交互和数据展示
2. **应用层**：前端应用逻辑，负责处理用户请求和业务逻辑
3. **API层**：前后端交互接口，定义了前后端通信的协议和格式
4. **服务层**：后端业务逻辑，负责处理API请求和业务逻辑
5. **数据访问层**：后端数据访问，负责与数据库交互
6. **数据层**：数据库，负责存储系统数据

## 2. 前端架构

### 2.1 前端框架选型

#### 2.1.1 核心技术栈

- **HTML5**：用于构建页面结构
- **CSS3**：用于页面样式设计
- **JavaScript (ES6+)**：用于实现页面交互和业务逻辑
- **Tailwind CSS (3.x)**：用于快速构建现代化的UI界面
- **Font Awesome (4.7.0)**：用于提供图标支持

#### 2.1.2 选型依据

- **HTML5/CSS3/JavaScript**：作为Web开发的基础技术，具有广泛的支持和丰富的生态系统
- **Tailwind CSS**：采用原子化CSS设计，能够快速构建现代化的UI界面，提高开发效率
- **Font Awesome**：提供了丰富的图标库，能够满足各种场景的图标需求

### 2.2 前端架构模式

StoryForge的前端采用了模块化设计，将功能划分为多个模块，每个模块负责特定的功能。前端架构遵循了以下原则：

- **组件化设计**：将页面拆分为多个可复用的组件
- **单向数据流**：数据从父组件流向子组件，减少数据冲突和调试难度
- **状态管理**：使用localStorage和sessionStorage管理客户端状态
- **路由管理**：实现页面间的导航和跳转

### 2.3 前端模块划分

#### 2.3.1 核心模块

- **认证模块**：负责用户注册、登录、登出等功能
- **故事创作模块**：负责故事创建、编辑、分支管理等功能
- **故事管理模块**：负责故事列表、状态管理、删除等功能
- **故事分享与发现模块**：负责故事搜索、推荐、评价等功能
- **用户管理模块**：负责个人资料管理、密码修改等功能

#### 2.3.2 辅助模块

- **UI组件库**：提供通用的UI组件，如按钮、输入框、卡片等
- **工具函数库**：提供通用的工具函数，如日期处理、字符串处理等
- **API封装**：封装与后端通信的API请求

### 2.4 前端目录结构

```
front/
├── assets/           # 静态资源
│   ├── css/          # 样式文件
│   ├── js/           # JavaScript文件
│   └── img/          # 图片资源
├── index.html        # 首页
├── login.html        # 登录页
├── register.html     # 注册页
├── create.html       # 创建故事页
├── story_tree_new.html # 故事树编辑页
├── story_editor_new.html # 故事编辑器
├── my_stories.html   # 我的作品页
├── explore.html      # 探索故事页
├── profile.html      # 个人中心页
└── about.html        # 关于页
```

### 2.5 前端数据管理

#### 2.5.1 状态管理

- **客户端状态**：使用localStorage和sessionStorage管理客户端状态，如用户登录状态、主题设置等
- **临时状态**：使用JavaScript变量管理组件内部状态，如表单输入、弹窗显示等

#### 2.5.2 数据存储

- **用户数据**：存储在localStorage或sessionStorage中，包括用户信息、认证令牌等
- **故事数据**：在编辑过程中临时存储在localStorage中，定期自动保存到后端

## 3. 后端架构

### 3.1 后端框架选型

#### 3.1.1 核心技术栈

- **Node.js**：JavaScript运行时，用于构建后端服务
- **Express**：Web框架，用于处理HTTP请求和路由
- **MongoDB**：NoSQL数据库，用于存储系统数据
- **Mongoose**：MongoDB ODM，用于简化数据库操作
- **JWT**：用于身份验证和授权
- **bcryptjs**：用于密码加密

#### 3.1.2 选型依据

- **Node.js**：与前端使用相同的编程语言，提高开发效率和团队协作
- **Express**：轻量级Web框架，具有丰富的中间件生态系统
- **MongoDB**：灵活的数据模型，适合存储结构化和非结构化数据
- **Mongoose**：提供了对象建模和验证功能，简化了数据库操作
- **JWT**：无状态认证机制，适合分布式系统
- **bcryptjs**：提供了安全的密码哈希算法

### 3.2 后端架构模式

StoryForge的后端采用了MVC设计模式，将系统分为模型、视图和控制器三层：

- **模型层**：定义数据模型和业务规则
- **视图层**：生成响应，通常是JSON格式的数据
- **控制器层**：处理HTTP请求，调用模型层和服务层的方法，返回响应

### 3.3 后端模块划分

#### 3.3.1 核心模块

- **认证模块**：负责用户注册、登录、登出等功能
- **故事模块**：负责故事的创建、编辑、删除等功能
- **故事节点模块**：负责故事节点的管理
- **用户模块**：负责用户信息的管理
- **分类模块**：负责故事分类的管理

#### 3.3.2 辅助模块

- **中间件模块**：提供通用的中间件，如身份验证、日志记录等
- **工具函数模块**：提供通用的工具函数，如日期处理、字符串处理等
- **配置模块**：管理系统配置，如数据库连接、端口设置等

### 3.4 后端目录结构

```
backend/
├── config/           # 配置文件
├── controllers/      # 控制器
├── middleware/       # 中间件
├── models/           # 数据模型
├── routes/           # 路由
├── services/         # 业务逻辑
├── utils/            # 工具函数
├── app.js            # 应用入口
├── package.json      # 依赖管理
└── server.js         # 服务器启动文件
```

### 3.5 后端数据管理

#### 3.5.1 数据模型设计

- **用户模型**：存储用户信息，包括用户名、邮箱、密码等
- **故事模型**：存储故事基本信息，包括标题、描述、分类等
- **故事节点模型**：存储故事节点信息，包括标题、内容、类型等
- **分类模型**：存储故事分类信息，包括名称、描述等
- **评价模型**：存储故事评价信息，包括评分、评论内容等

#### 3.5.2 数据库设计

StoryForge使用MongoDB数据库，数据库名为`storyforge`，包含以下集合：

- **users**：存储用户信息
- **stories**：存储故事基本信息
- **storyNodes**：存储故事节点信息
- **categories**：存储故事分类信息
- **reviews**：存储故事评价信息

## 4. 前后端数据交互机制

### 4.1 API设计

#### 4.1.1 API设计原则

- **RESTful设计**：遵循RESTful API设计规范，使用HTTP方法表示操作类型
- **统一响应格式**：所有API返回统一的响应格式，包括状态码、消息和数据
- **版本控制**：通过URL路径或请求头实现API版本控制
- **错误处理**：统一的错误处理机制，返回清晰的错误信息
- **文档化**：提供详细的API文档，方便前端开发人员使用

#### 4.1.2 API响应格式

```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    // 响应数据
  }
}
```

```json
{
  "success": false,
  "message": "操作失败",
  "error": {
    "code": 400,
    "details": "错误详情"
  }
}
```

### 4.2 认证机制

#### 4.2.1 JWT认证流程

1. 用户登录，提供用户名和密码
2. 后端验证用户名和密码
3. 验证成功，生成JWT令牌
4. 前端存储JWT令牌
5. 前端每次请求时，在请求头中携带JWT令牌
6. 后端验证JWT令牌的有效性
7. 验证成功，处理请求；验证失败，返回401错误

#### 4.2.2 令牌存储

- **客户端存储**：使用localStorage或sessionStorage存储JWT令牌
- **令牌刷新**：实现令牌刷新机制，避免用户频繁登录
- **令牌过期**：设置合理的令牌过期时间，提高安全性

### 4.3 前后端通信流程

1. 前端发送HTTP请求，携带必要的参数和认证信息
2. 后端接收请求，验证认证信息
3. 后端处理业务逻辑，与数据库交互
4. 后端返回HTTP响应，包含状态码和响应数据
5. 前端接收响应，处理响应数据，更新界面

### 4.4 API请求示例

#### 4.4.1 用户登录

- **请求URL**：`/api/v1/auth/login`
- **HTTP方法**：POST
- **请求头**：`Content-Type: application/json`
- **请求体**：
  ```json
  {
    "email": "user@example.com",
    "password": "password123"
  }
  ```
- **响应**：
  ```json
  {
    "success": true,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "userInfo": {
        "id": "1234567890",
        "username": "user",
        "email": "user@example.com"
      }
    }
  }
  ```

#### 4.4.2 创建故事

- **请求URL**：`/api/v1/stories`
- **HTTP方法**：POST
- **请求头**：
  ```
  Content-Type: application/json
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  ```
- **请求体**：
  ```json
  {
    "title": "我的故事",
    "description": "这是一个关于冒险的故事",
    "categoryId": "1234567890"
  }
  ```
- **响应**：
  ```json
  {
    "success": true,
    "message": "故事创建成功",
    "data": {
      "id": "0987654321",
      "title": "我的故事",
      "description": "这是一个关于冒险的故事",
      "categoryId": "1234567890",
      "createdAt": "2023-05-01T12:00:00.000Z",
      "updatedAt": "2023-05-01T12:00:00.000Z"
    }
  }
  ```

## 5. 系统各模块间的依赖关系

### 5.1 模块依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                前端应用                                      │
├─────────┬─────────┬────────────┬────────────────┬──────────────────────────────┤
│ 认证模块 │ 故事创作 │ 故事管理   │ 故事分享与发现 │ 用户管理                     │
└─────┬───┴─────┬───┴──────┬─────┴────────┬───────┴──────────────────────┬────┘
      │         │          │               │                              │
      │         │          │               │                              │
┌─────▼─────────▼──────────▼───────────────▼──────────────────────────────▼────┐
│                                API层                                       │
├─────────┬─────────┬────────────┬────────────────┬──────────────────────────────┤
│ 认证API │ 故事API │ 故事节点API │ 分类API        │ 用户API                      │
└─────┬───┴─────┬───┴──────┬─────┴────────┬───────┴──────────────────────┬────┘
      │         │          │               │                              │
      │         │          │               │                              │
┌─────▼─────────▼──────────▼───────────────▼──────────────────────────────▼────┐
│                                后端服务                                      │
├─────────┬─────────┬────────────┬────────────────┬──────────────────────────────┤
│ 认证服务 │ 故事服务 │ 故事节点服务 │ 分类服务        │ 用户服务                      │
└─────┬───┴─────┬───┴──────┬─────┴────────┬───────┴──────────────────────┬────┘
      │         │          │               │                              │
      │         │          │               │                              │
┌─────▼─────────▼──────────▼───────────────▼──────────────────────────────▼────┐
│                                数据访问层                                     │
├─────────┬─────────┬────────────┬────────────────┬──────────────────────────────┤
│ 用户模型 │ 故事模型 │ 故事节点模型 │ 分类模型        │ 评价模型                      │
└─────┬───┴─────┬───┴──────┬─────┴────────┬───────┴──────────────────────┬────┘
      │         │          │               │                              │
      │         │          │               │                              │
┌─────▼─────────▼──────────▼───────────────▼──────────────────────────────▼────┐
│                                数据库                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 模块间通信方式

- **前端模块间通信**：通过函数调用和事件机制实现
- **后端模块间通信**：通过函数调用和依赖注入实现
- **前后端通信**：通过HTTP请求和响应实现

## 6. 系统部署架构

### 6.1 开发环境部署

- **前端开发环境**：
  - Node.js (16.x)
  - npm (8.x)
  - VS Code或其他IDE
  - 浏览器

- **后端开发环境**：
  - Node.js (16.x)
  - npm (8.x)
  - MongoDB (5.x)
  - VS Code或其他IDE

### 6.2 生产环境部署

#### 6.2.1 部署架构

StoryForge的生产环境部署采用了以下架构：

1. **负载均衡**：使用Nginx作为负载均衡器，分发HTTP请求
2. **前端部署**：将前端静态文件部署到CDN或Web服务器
3. **后端部署**：使用Node.js进程管理器（如PM2）管理后端服务
4. **数据库部署**：使用MongoDB Atlas或自建MongoDB集群
5. **缓存**：使用Redis缓存热点数据，提高系统性能
6. **监控**：使用监控工具（如Prometheus、Grafana）监控系统运行状态

#### 6.2.2 部署流程

1. **代码构建**：使用构建工具（如Vite、Webpack）构建前端代码
2. **容器化**：使用Docker容器化前端和后端应用
3. **部署**：使用CI/CD工具（如Jenkins、GitHub Actions）自动部署到生产环境
4. **监控**：部署监控工具，监控系统运行状态
5. **备份**：定期备份数据库和重要文件

### 6.3 安全架构

#### 6.3.1 安全机制

- **身份验证**：使用JWT令牌验证用户身份
- **授权**：实现基于角色的访问控制
- **数据加密**：使用HTTPS加密传输数据
- **输入验证**：验证用户输入，防止SQL注入、XSS攻击等
- **安全头**：设置安全相关的HTTP头，如Content-Security-Policy、X-XSS-Protection等
- **日志记录**：记录系统日志，便于安全审计和故障排查

#### 6.3.2 安全最佳实践

- **最小权限原则**：只授予用户必要的权限
- **定期更新**：定期更新依赖包和系统组件
- **安全扫描**：定期进行安全漏洞扫描
- **安全审计**：定期进行安全审计，检查系统安全配置

## 7. 性能优化

### 7.1 前端性能优化

- **代码分割**：将代码分割为多个小块，按需加载
- **懒加载**：延迟加载非关键资源，如图片、视频等
- **缓存策略**：合理设置缓存头，减少重复请求
- **减少HTTP请求**：合并CSS和JavaScript文件，使用CSS Sprites等技术
- **优化图片**：压缩图片大小，使用WebP格式等
- **使用CDN**：使用CDN分发静态资源，提高访问速度

### 7.2 后端性能优化

- **数据库优化**：优化数据库查询，添加索引，使用聚合查询等
- **缓存机制**：使用Redis缓存热点数据，减少数据库查询
- **异步处理**：使用异步IO和事件驱动，提高并发处理能力
- **负载均衡**：使用负载均衡器分发请求，提高系统吞吐量
- **水平扩展**：支持水平扩展，增加服务器数量，提高系统容量

## 8. 系统监控与日志

### 8.1 监控系统

- **前端监控**：监控页面加载时间、资源加载时间、错误率等
- **后端监控**：监控API响应时间、错误率、CPU使用率、内存使用率等
- **数据库监控**：监控数据库查询时间、连接数、慢查询等
- **系统监控**：监控服务器CPU使用率、内存使用率、磁盘空间等

### 8.2 日志系统

- **前端日志**：记录前端错误、用户行为等
- **后端日志**：记录API请求、错误信息、业务逻辑等
- **数据库日志**：记录数据库操作、慢查询等
- **系统日志**：记录系统启动、关闭、异常等

### 8.3 日志管理

- **日志收集**：使用日志收集工具（如ELK Stack、Graylog）收集日志
- **日志分析**：分析日志，发现系统问题和优化点
- **日志存储**：合理设置日志存储策略，定期清理过期日志

## 9. 系统扩展性设计

### 9.1 模块扩展性

- **模块化设计**：将系统划分为多个功能模块，便于添加新功能
- **插件机制**：支持插件扩展，允许第三方开发者开发插件
- **API扩展**：设计灵活的API，便于添加新的API端点

### 9.2 数据扩展性

- **数据库分片**：使用MongoDB分片，支持海量数据存储
- **数据分区**：根据业务需求，将数据分区存储
- **读写分离**：实现读写分离，提高系统读写性能

### 9.3 水平扩展

- **无状态设计**：后端服务设计为无状态，便于水平扩展
- **负载均衡**：使用负载均衡器分发请求，支持多实例部署
- **自动缩放**：根据系统负载自动调整实例数量

## 10. 系统依赖关系

### 10.1 前端依赖

| 依赖名称 | 版本 | 用途 |
| --- | --- | --- |
| Tailwind CSS | 3.x | 样式框架 |
| Font Awesome | 4.7.0 | 图标库 |

### 10.2 后端依赖

| 依赖名称 | 版本 | 用途 |
| --- | --- | --- |
| Express | 4.x | Web框架 |
| Mongoose | 6.x | MongoDB ODM |
| JWT | 8.x | 身份验证 |
| bcryptjs | 2.x | 密码加密 |
| body-parser | 1.x | 解析请求体 |
| cors | 2.x | 处理跨域请求 |
| dotenv | 16.x | 管理环境变量 |

## 11. 架构演进规划

### 11.1 短期规划

- **优化性能**：进一步优化系统性能，提高响应速度和并发处理能力
- **完善安全机制**：加强系统安全，防止各种安全攻击
- **提高可维护性**：优化代码结构，提高代码质量和可维护性

### 11.2 中期规划

- **微服务架构**：将系统拆分为多个微服务，提高系统的可扩展性和容错能力
- **消息队列**：引入消息队列，处理异步任务和事件驱动的业务逻辑
- **缓存系统**：完善缓存机制，提高系统性能

### 11.3 长期规划

- **Serverless架构**：探索Serverless架构，降低运维成本
- **AI集成**：进一步集成AI技术，提高故事创作的智能化水平
- **区块链技术**：探索区块链技术在内容版权保护中的应用

## 12. 附录

### 12.1 术语定义

| 术语 | 定义 |
| --- | --- |
| MVC | Model-View-Controller，一种软件架构模式 |
| RESTful | 一种API设计风格，基于HTTP协议 |
| JWT | JSON Web Token，一种用于身份验证的令牌 |
| CDN | Content Delivery Network，内容分发网络 |
| ODM | Object-Document Mapping，对象-文档映射 |
| NoSQL | 非关系型数据库，如MongoDB |
| CI/CD | Continuous Integration/Continuous Deployment，持续集成/持续部署 |

### 12.2 参考文档

- [Express官方文档](https://expressjs.com/)
- [MongoDB官方文档](https://www.mongodb.com/docs/)
- [Mongoose官方文档](https://mongoosejs.com/docs/)
- [JWT官方文档](https://jwt.io/introduction/)
- [Tailwind CSS官方文档](https://tailwindcss.com/docs/)

### 12.3 架构决策记录

| 决策ID | 决策内容 | 决策理由 | 实施时间 |
| --- | --- | --- | --- |
| AD001 | 采用前后端分离架构 | 提高系统的可维护性和可扩展性，便于团队协作 | 2023-01 |
| AD002 | 后端使用Node.js和Express | 与前端使用相同的编程语言，提高开发效率 | 2023-01 |
| AD003 | 数据库使用MongoDB | 灵活的数据模型，适合存储结构化和非结构化数据 | 2023-01 |
| AD004 | 身份验证使用JWT | 无状态认证机制，适合分布式系统 | 2023-02 |
| AD005 | 前端使用Tailwind CSS | 快速构建现代化的UI界面，提高开发效率 | 2023-02 |