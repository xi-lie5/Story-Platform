# StoryForge AI故事创作平台 - 需求分析文档

## 1. 项目概述

### 1.1 项目名称
**StoryForge** - AI交互式故事创作平台

### 1.2 项目定位
StoryForge是一个基于AI技术的交互式故事创作与阅读平台，允许用户创建、编辑、发布和阅读具有多分支结局的互动故事。平台支持用户通过可视化节点图谱编辑工具创建复杂的分支式故事，并利用AI技术辅助故事创作。

### 1.3 核心价值
- **AI辅助创作**：利用阿里云通义千问（qwen-max）模型辅助用户进行故事内容的润色和扩写
- **多分支叙事**：支持创建具有多个选择分支和结局的互动故事
- **社区分享**：用户可以发布作品供其他用户阅读和体验
- **可视化编辑**：提供直观的故事节点图谱编辑工具
- **内容审核**：管理员审核机制确保内容质量
- **用户互动**：支持收藏、评分等社交功能

### 1.4 技术架构
- **前端**：HTML5 + CSS3 (Tailwind CSS) + JavaScript (ES6+)
- **后端**：Node.js + Express.js
- **数据库**：MySQL 8.0+
- **认证**：JWT (JSON Web Token)
- **AI服务**：阿里云DashScope API (通义千问)
- **部署**：单机部署，前后端一体化

## 2. 用户角色与权限

### 2.1 普通用户（User）
**权限范围**：
- 注册账号并登录
- 创建和管理自己的故事作品
- 浏览和阅读已发布的故事
- 收藏和评分故事
- 查看个人统计信息
- 编辑个人资料

**限制**：
- 不能审核故事
- 不能管理其他用户
- 不能管理系统设置

### 2.2 管理员（Admin）
**权限范围**：
- 拥有普通用户的所有权限
- 审核用户提交的故事（通过/拒绝）
- 管理系统用户（查看、禁用/解禁、重置密码）
- 管理故事分类（增删改查）
- 查看系统统计数据
- 管理所有故事（发布、下架、删除）

**特殊权限**：
- 访问管理员控制台
- 访问个人中心的管理中心
- 访问故事审核界面

### 2.3 访客（Guest）
**权限范围**：
- 浏览首页
- 浏览已发布的故事列表
- 阅读已发布的故事
- 查看故事详情

**限制**：
- 不能创建故事
- 不能收藏和评分
- 不能访问个人中心

## 3. 功能需求详细分析

### 3.1 用户认证模块

#### 3.1.1 用户注册
**功能描述**：新用户通过填写注册表单创建账号

**页面路径**：`front/register.html`

**功能需求**：
1. **表单字段**：
   - 用户名（必填，3-30个字符，唯一）
   - 电子邮箱（必填，邮箱格式验证，唯一）
   - 密码（必填，至少8位）
   - 确认密码（必填，需与密码一致）
   - 同意服务条款复选框（必选）

2. **验证规则**：
   - 用户名：3-30个字符，不能包含特殊字符
   - 邮箱：符合邮箱格式，系统内唯一
   - 密码：至少8位，建议包含字母和数字
   - 确认密码：必须与密码完全一致

3. **业务流程**：
   - 用户填写表单
   - 前端实时验证
   - 提交到后端API (`POST /api/v1/auth/register`)
   - 后端验证并创建用户
   - 自动登录并返回Token
   - 跳转到首页或指定页面

4. **错误处理**：
   - 用户名已存在
   - 邮箱已存在
   - 密码强度不足
   - 网络错误

**API接口**：
- `POST /api/v1/auth/register`
- 请求体：`{ username, email, password, confirmPassword }`
- 响应：`{ success, message, data: { userId, username, email, avatar, token, refreshToken } }`

#### 3.1.2 用户登录
**功能描述**：已注册用户通过邮箱和密码登录系统

**页面路径**：`front/login.html`

**功能需求**：
1. **表单字段**：
   - 电子邮箱（必填）
   - 密码（必填）
   - 记住我复选框（可选）

2. **安全机制**：
   - 登录失败次数限制（防止暴力破解）
   - 账户锁定机制（连续失败5次锁定30分钟）
   - 密码加密存储（bcrypt）
   - JWT Token认证
   - Token版本控制（支持强制登出）

3. **业务流程**：
   - 用户输入邮箱和密码
   - 提交到后端API (`POST /api/v1/auth/login`)
   - 后端验证邮箱和密码
   - 检查账户状态（是否激活、是否锁定）
   - 生成Access Token和Refresh Token
   - 更新最后登录时间
   - 重置登录尝试次数
   - 返回Token和用户信息
   - 前端存储Token（localStorage或sessionStorage）
   - 跳转到首页或指定页面

4. **错误处理**：
   - 邮箱或密码错误
   - 账户已被禁用
   - 账户已被锁定（显示解锁时间）
   - 网络错误

**API接口**：
- `POST /api/v1/auth/login`
- 请求体：`{ email, password }`
- 响应：`{ success, message, data: { userId, username, email, avatar, role, token, refreshToken } }`

#### 3.1.3 忘记密码
**功能描述**：用户忘记密码时，通过邮箱联系管理员重置密码

**页面路径**：`front/forgot_password.html`

**功能需求**：
1. **表单字段**：
   - 邮箱地址（必填，邮箱格式验证）

2. **业务流程**：
   - 用户输入邮箱地址
   - 点击"联系管理员修改密码"按钮
   - 前端验证邮箱格式
   - 显示"已通知管理员"提示框
   - 管理员收到通知后手动重置密码

3. **用户体验**：
   - 清晰的提示信息
   - 成功提示模态框
   - 返回登录页面链接

**注意**：当前实现为前端提示，实际需要管理员在后台手动处理密码重置。

#### 3.1.4 Token刷新
**功能描述**：自动刷新过期的Access Token

**实现方式**：
- 前端检测到Token过期时，使用Refresh Token获取新的Access Token
- Refresh Token有效期7天
- Access Token有效期1天

**API接口**：
- `POST /api/v1/auth/refresh`
- 请求头：`Authorization: Bearer <refreshToken>`
- 响应：`{ success, message, data: { token, refreshToken } }`

#### 3.1.5 用户登出
**功能描述**：用户退出登录，清除Token

**API接口**：
- `POST /api/v1/auth/logout`
- 请求头：`Authorization: Bearer <token>`
- 功能：清除Refresh Token，使所有Token失效

### 3.2 故事创作模块

#### 3.2.1 故事创建工具
**功能描述**：用户通过可视化界面创建和编辑多分支故事

**页面路径**：`front/create.html`

**功能需求**：

1. **故事基本信息设置**：
   - 故事标题（必填，最多100字符）
   - 故事简介（必填，最多500字符）
   - 封面图片上传和预览
   - 分类选择（下拉选择）
   - 保存为草稿或提交审核

2. **角色管理**：
   - 添加角色
   - 编辑角色信息（名称、描述）
   - 删除角色
   - 角色列表显示

3. **节点管理**：
   - 创建故事节点（根节点、普通节点、分支节点、结局节点）
   - 编辑节点内容（标题、内容、类型）
   - 删除节点
   - 节点位置调整（X、Y坐标）
   - 节点类型：
     - `regular`：普通节点
     - `branch`：分支节点
     - `end`：结局节点

4. **分支管理**：
   - 创建分支连接（从源节点到目标节点）
   - 编辑分支描述（context）
   - 删除分支
   - 可视化分支图谱

5. **AI辅助功能**：
   - 文本润色和扩写
   - 调用阿里云通义千问模型
   - 实时预览润色后的内容

6. **实时预览**：
   - 预览故事内容
   - 预览分支选择
   - 预览节点内容

**数据模型**：
- **Story（故事）**：id, title, author_id, category_id, cover_image, description, status, is_public, view_count, rating, created_at, updated_at
- **StoryNode（节点）**：id, story_id, title, content, is_root, type, x, y, created_at, updated_at
- **Branch（分支）**：id, source_node_id, target_node_id, context, created_at, updated_at
- **Character（角色）**：id, story_id, name, description, created_at, updated_at

**API接口**：
- `POST /api/v1/stories` - 创建故事
- `PUT /api/v1/stories/:id` - 更新故事
- `GET /api/v1/stories/:id` - 获取故事详情
- `POST /api/v1/storyNodes` - 创建节点
- `PUT /api/v1/storyNodes/:id` - 更新节点
- `DELETE /api/v1/storyNodes/:id` - 删除节点
- `POST /api/v1/branches` - 创建分支
- `PUT /api/v1/branches/:id` - 更新分支
- `DELETE /api/v1/branches/:id` - 删除分支
- `POST /api/v1/characters` - 创建角色
- `PUT /api/v1/characters/:id` - 更新角色
- `DELETE /api/v1/characters/:id` - 删除角色
- `POST /api/v1/ai/polish` - AI文本润色

#### 3.2.2 故事状态管理
**故事状态**：
- `draft`：草稿（未提交审核）
- `pending`：待审核（已提交，等待管理员审核）
- `published`：已发布（审核通过，已发布）
- `rejected`：已拒绝（审核未通过）
- `unpublished`：已下架（曾经发布但被下架）

**状态流转**：
- 草稿 → 待审核（用户提交审核）
- 待审核 → 已发布（管理员审核通过）
- 待审核 → 已拒绝（管理员审核拒绝）
- 已发布 → 已下架（管理员下架或用户取消发布）
- 已拒绝 → 待审核（用户重新提交）
- 已下架 → 待审核（用户重新提交）

### 3.3 故事阅读模块

#### 3.3.1 故事阅读器
**功能描述**：用户阅读已发布的多分支故事，通过选择分支体验不同的故事路径

**页面路径**：`front/story-reader.html`

**功能需求**：

1. **故事加载**：
   - 根据URL参数（id和node）加载故事和节点内容
   - 显示故事标题、封面、作者信息
   - 显示当前节点内容（支持富文本）

2. **分支选择**：
   - 显示当前节点的所有分支选项
   - 点击分支跳转到下一个节点
   - 分支描述显示

3. **阅读导航**：
   - 返回上一节点（阅读历史）
   - 重新开始阅读
   - 阅读进度条
   - 阅读路径指示器

4. **阅读设置**：
   - 字体大小调整（小、中、大）
   - 主题切换（浅色/深色）
   - 阅读模式切换

5. **互动功能**：
   - 收藏故事
   - 评分故事（1-5星）
   - 分享故事
   - 查看故事统计（浏览次数、评分）

6. **浏览器支持**：
   - 浏览器前进/后退支持
   - URL参数同步
   - 阅读历史记录

**API接口**：
- `GET /api/v1/stories/:id` - 获取故事详情
- `GET /api/v1/storyNodes/:id` - 获取节点详情
- `GET /api/v1/stories/:id/nodes` - 获取故事的所有节点
- `GET /api/v1/stories/:id/branches` - 获取故事的所有分支
- `PUT /api/v1/stories/:id/view` - 增加浏览次数
- `POST /api/v1/interactions/favorite` - 收藏故事
- `DELETE /api/v1/interactions/favorite/:storyId` - 取消收藏
- `POST /api/v1/interactions/rating` - 评分故事

### 3.4 故事浏览模块

#### 3.4.1 故事列表页
**功能描述**：展示所有已发布的故事，支持搜索、筛选和排序

**页面路径**：`front/browse.html`

**功能需求**：

1. **故事列表显示**：
   - 故事卡片展示（封面、标题、描述、分类、作者、浏览次数、评分、发布日期）
   - 分页显示（每页12个故事，可调整）
   - 响应式布局（桌面端、平板端、移动端）

2. **搜索功能**：
   - 搜索框（实时搜索）
   - 按标题或描述搜索
   - 搜索结果高亮显示

3. **筛选功能**：
   - 分类筛选（下拉选择）
   - 状态筛选（仅显示已发布的故事）

4. **排序功能**：
   - 最新发布（按创建时间降序）
   - 最受欢迎（按浏览次数降序）
   - 评分最高（按评分降序）

5. **故事卡片信息**：
   - 封面图片
   - 分类标签
   - 分支数量
   - 标题
   - 描述（最多2行，超出省略）
   - 作者头像和名称
   - 浏览次数
   - 评分（星级显示）
   - 发布日期
   - "阅读"按钮

**API接口**：
- `GET /api/v1/stories?page=1&limit=12&category=&search=&sort=latest` - 获取故事列表
- `GET /api/v1/categories` - 获取分类列表

### 3.5 作品管理模块

#### 3.5.1 我的作品页
**功能描述**：用户管理自己创建的所有故事

**页面路径**：`front/my_stories.html`

**功能需求**：

1. **故事列表显示**：
   - 显示用户创建的所有故事
   - 故事卡片显示（标题、描述、分类、状态、更新时间）
   - 区分已完成和未完成作品

2. **状态筛选**：
   - 全部作品
   - 草稿
   - 待审核
   - 已发布
   - 已拒绝
   - 下架作品

3. **操作功能**：
   - **继续编辑**：跳转到故事编辑页面
   - **查看**：查看故事节点图谱
   - **提交审核**：将草稿提交审核（状态变为pending）
   - **取消发布**：取消已发布的故事（状态变为unpublished）
   - **重新提交**：重新提交被拒绝或下架的故事（状态变为pending）
   - **分享**：分享故事链接
   - **统计**：查看故事统计数据（浏览次数、评分、收藏数）

4. **状态标识**：
   - 不同状态使用不同颜色标签
   - 状态文字说明

**API接口**：
- `GET /api/v1/stories/my?status=&page=1&limit=12` - 获取我的故事列表
- `PUT /api/v1/stories/:id/status` - 更新故事状态
- `GET /api/v1/stories/:id/stats` - 获取故事统计

### 3.6 个人中心模块

#### 3.6.1 个人资料页
**功能描述**：用户查看和编辑个人资料，查看创作统计

**页面路径**：`front/profile.html`

**功能需求**：

1. **标签页切换**：
   - 个人资料
   - 创作统计
   - 管理中心（仅管理员可见）

2. **个人资料标签页**：
   - 用户头像显示和上传
   - 用户基本信息（昵称、邮箱、用户ID、登录状态）
   - 个人简介编辑
   - 快捷操作按钮：
     - 开始新的故事
     - 进入管理员控制台（仅管理员）
     - 退出登录

3. **创作统计标签页**：
   - 已发布故事数量
   - 创作中（草稿）数量
   - 待审核故事数量
   - 收藏故事数量
   - 总浏览次数
   - 总评分

4. **管理中心标签页**（仅管理员）：
   - **系统概览统计**：
     - 总作品数
     - 待审核作品数
     - 用户总数（排除管理员）
     - 分类总数
     - 今日审核数
     - 总审核数
   
   - **快速操作**：
     - 查看待审核作品
     - 查看已发布作品
     - 查看所有作品
     - 查看所有用户
     - 管理分类
     - 打开完整管理面板
   
   - **数据显示区域**：
     - 作品列表（可筛选状态）
     - 用户列表（用户名、邮箱、作品数、创建时间、最后登录时间）
     - 分类管理（增删改查）

**API接口**：
- `GET /api/v1/users/me` - 获取当前用户信息
- `PUT /api/v1/users/me` - 更新当前用户信息
- `GET /api/v1/stories/my/stats` - 获取我的故事统计
- `GET /api/v1/admin/stats` - 获取管理员统计（仅管理员）
- `GET /api/v1/admin/stories` - 获取所有故事（仅管理员）
- `GET /api/v1/admin/users` - 获取所有用户（仅管理员）

### 3.7 管理员模块

#### 3.7.1 管理员控制台
**功能描述**：管理员管理系统，包括故事审核、用户管理、分类管理等

**页面路径**：`front/admin.html`

**功能需求**：

1. **标签页导航**：
   - 数据总览
   - 作品管理
   - 用户管理

2. **数据总览标签页**：
   - **统计卡片**：
     - 故事总数
     - 待审核故事数
     - 已发布故事数
     - 用户总数（排除管理员）
     - 今日审核数
     - 总审核数
   - **系统概览信息**：
     - 系统运行状态
     - 最近活动记录

3. **作品管理标签页**：
   - **状态筛选**：
     - 全部
     - 待审核
     - 已发布
     - 草稿
     - 已拒绝
   
   - **故事列表显示**：
     - 故事标题
     - 作者信息
     - 状态
     - 创建时间
     - 更新时间
   
   - **操作功能**：
     - **审核**：通过/拒绝故事（可填写拒绝原因）
     - **发布**：直接发布故事
     - **下架**：下架已发布的故事
     - **删除**：删除故事（谨慎操作）

4. **用户管理标签页**：
   - **用户列表显示**：
     - 用户名
     - 邮箱
     - 作品数
     - 账号创建时间
     - 最后登录时间
     - 账户状态（激活/禁用）
   
   - **操作功能**：
     - **禁用/解禁**：禁用或解禁用户账户
     - **重置密码**：重置用户密码为"default123"
     - **删除用户**：删除用户账户（谨慎操作）
   
   - **筛选功能**：
     - 按角色筛选
     - 按状态筛选
     - 搜索用户

**API接口**：
- `GET /api/v1/admin/stats` - 获取统计信息
- `GET /api/v1/admin/stories?status=&page=1&limit=1000` - 获取故事列表
- `PUT /api/v1/admin/stories/:id/review` - 审核故事
- `PUT /api/v1/admin/stories/:id/publish` - 发布故事
- `PUT /api/v1/admin/stories/:id/unpublish` - 下架故事
- `DELETE /api/v1/admin/stories/:id` - 删除故事
- `GET /api/v1/admin/users?role=&status=&search=&page=1&limit=100` - 获取用户列表
- `PUT /api/v1/admin/users/:userId/status` - 禁用/解禁用户
- `PUT /api/v1/admin/users/:userId/reset-password` - 重置用户密码
- `DELETE /api/v1/admin/users/:userId` - 删除用户

#### 3.7.2 故事审核界面
**功能描述**：管理员审核待审核的故事

**页面路径**：`front/review.html`

**功能需求**：

1. **待审核故事列表**：
   - 显示所有待审核的故事
   - 故事卡片显示（标题、描述、作者、创建时间、提交时间）
   - 分页显示

2. **审核操作**：
   - **通过**：直接通过审核，无需填写原因
   - **拒绝**：拒绝审核，需要填写拒绝原因（必填）
   - 审核后故事状态自动更新

3. **统计信息**：
   - 今日审核数
   - 总审核数

4. **故事详情查看**：
   - 查看故事完整内容
   - 查看节点图谱
   - 查看分支结构

**API接口**：
- `GET /api/v1/admin/stories?status=pending` - 获取待审核故事
- `PUT /api/v1/admin/stories/:id/review` - 审核故事
  - 请求体：`{ action: 'approve' | 'reject', reason?: string }`

### 3.8 分类管理模块

#### 3.8.1 分类管理
**功能描述**：管理员管理故事分类

**功能需求**：

1. **分类列表显示**：
   - 分类名称
   - 分类描述
   - 故事数量
   - 创建日期

2. **分类操作**：
   - **添加分类**：创建新分类（名称、描述）
   - **编辑分类**：修改分类名称和描述
   - **删除分类**：删除分类（如果分类下有故事，自动移动到"默认分类"）

3. **默认分类**：
   - 系统必须存在"默认分类"
   - 删除分类时，该分类下的故事自动移动到"默认分类"

**API接口**：
- `GET /api/v1/categories` - 获取分类列表
- `POST /api/v1/categories` - 创建分类（仅管理员）
- `PUT /api/v1/categories/:id` - 更新分类（仅管理员）
- `DELETE /api/v1/categories/:id` - 删除分类（仅管理员）

### 3.9 AI辅助功能模块

#### 3.9.1 AI文本润色
**功能描述**：利用阿里云通义千问模型对故事节点内容进行润色和扩写

**功能需求**：

1. **输入参数**：
   - 故事标题
   - 故事分类（可选）
   - 节点内容

2. **处理流程**：
   - 构建提示词
   - 调用DashScope API（qwen-max模型）
   - 获取润色后的内容
   - 返回给前端显示

3. **提示词要求**：
   - 保持原有的故事情节和风格
   - 增强文字的表现力和感染力
   - 适当扩展细节，使内容更加丰富生动
   - 确保语言流畅自然
   - 保持与故事整体的连贯性

**API接口**：
- `POST /api/v1/ai/polish`
- 请求体：`{ title, category?, content }`
- 响应：`{ success, message, data: { polishedContent } }`

**环境要求**：
- 需要配置`DASHSCOPE_API_KEY`环境变量
- 需要安装`dashscope`包

### 3.10 用户交互模块

#### 3.10.1 收藏功能
**功能描述**：用户收藏喜欢的故事

**功能需求**：
- 收藏故事
- 取消收藏
- 查看我的收藏列表

**API接口**：
- `POST /api/v1/interactions/favorite` - 收藏故事
- `DELETE /api/v1/interactions/favorite/:storyId` - 取消收藏
- `GET /api/v1/interactions/favorites` - 获取我的收藏列表

#### 3.10.2 评分功能
**功能描述**：用户对故事进行评分（1-5星）

**功能需求**：
- 评分故事（1-5星）
- 修改评分
- 查看故事平均评分

**API接口**：
- `POST /api/v1/interactions/rating` - 评分故事
- `PUT /api/v1/interactions/rating/:storyId` - 修改评分
- `GET /api/v1/interactions/rating/:storyId` - 获取故事评分

**数据模型**：
- **UserStoryRating（用户故事评分）**：id, user_id, story_id, rating (1-5), comment, created_at, updated_at

## 4. 数据库设计

### 4.1 数据库表结构

#### 4.1.1 users（用户表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 用户ID | PRIMARY KEY, AUTO_INCREMENT |
| username | VARCHAR(30) | 用户名 | NOT NULL, UNIQUE |
| email | VARCHAR(255) | 邮箱 | NOT NULL, UNIQUE |
| password | VARCHAR(255) | 密码（加密） | NOT NULL |
| avatar | VARCHAR(255) | 头像路径 | DEFAULT '/avatar/default.png' |
| bio | VARCHAR(200) | 个人简介 | DEFAULT '这个人很懒，什么都没留下' |
| role | ENUM | 角色 | DEFAULT 'user' ('user', 'editor', 'admin') |
| is_active | BOOLEAN | 是否激活 | DEFAULT TRUE |
| token_version | INT | Token版本 | DEFAULT 1 |
| refresh_token | TEXT | 刷新令牌 | NULL |
| last_login | TIMESTAMP | 最后登录时间 | NULL |
| login_attempts | INT | 登录尝试次数 | DEFAULT 0 |
| lock_until | TIMESTAMP | 锁定到期时间 | NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `idx_email` (email)
- `idx_username` (username)
- `idx_is_active` (is_active)

#### 4.1.2 categories（分类表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 分类ID | PRIMARY KEY, AUTO_INCREMENT |
| name | VARCHAR(100) | 分类名称 | NOT NULL, UNIQUE |
| description | TEXT | 分类描述 | NULL |
| story_count | INT | 故事数量 | DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

#### 4.1.3 stories（故事表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 故事ID | PRIMARY KEY, AUTO_INCREMENT |
| title | VARCHAR(100) | 故事标题 | NOT NULL |
| author_id | INT | 作者ID | NOT NULL, FOREIGN KEY |
| category_id | INT | 分类ID | NULL, FOREIGN KEY |
| cover_image | VARCHAR(255) | 封面图片 | DEFAULT '/coverImage/1.png' |
| description | VARCHAR(500) | 故事简介 | NOT NULL |
| status | ENUM | 状态 | DEFAULT 'draft' |
| is_public | BOOLEAN | 是否公开 | DEFAULT FALSE |
| view_count | INT | 浏览次数 | DEFAULT 0 |
| rating | DECIMAL(3,2) | 评分 | DEFAULT 0.00 |
| rating_count | INT | 评分人数 | DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `idx_author` (author_id)
- `idx_category` (category_id)
- `idx_status` (status)
- `idx_created_at` (created_at)
- `idx_updated_at` (updated_at)
- `FULLTEXT idx_title_desc` (title, description)

**外键**：
- `FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE`
- `FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL`

#### 4.1.4 story_nodes（故事节点表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | VARCHAR(255) | 节点ID | PRIMARY KEY |
| story_id | INT | 故事ID | NOT NULL, FOREIGN KEY |
| title | VARCHAR(255) | 节点标题 | NOT NULL |
| content | TEXT | 节点内容 | NOT NULL |
| is_root | BOOLEAN | 是否根节点 | DEFAULT FALSE |
| type | ENUM | 节点类型 | DEFAULT 'regular' |
| x | INT | X坐标 | DEFAULT 0 |
| y | INT | Y坐标 | DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `idx_story_id` (story_id)
- `idx_story_root` (story_id, is_root)
- `idx_story_type` (story_id, type)

**外键**：
- `FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE`

#### 4.1.5 branches（分支表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | VARCHAR(255) | 分支ID | PRIMARY KEY |
| source_node_id | VARCHAR(255) | 源节点ID | NOT NULL, FOREIGN KEY |
| target_node_id | VARCHAR(255) | 目标节点ID | NOT NULL, FOREIGN KEY |
| context | VARCHAR(500) | 分支描述 | NOT NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `UNIQUE KEY uk_source_target` (source_node_id, target_node_id)
- `idx_source` (source_node_id)
- `idx_target` (target_node_id)

**外键**：
- `FOREIGN KEY (source_node_id) REFERENCES story_nodes(id) ON DELETE CASCADE`
- `FOREIGN KEY (target_node_id) REFERENCES story_nodes(id) ON DELETE CASCADE`

#### 4.1.6 characters（角色表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | VARCHAR(255) | 角色ID | PRIMARY KEY |
| story_id | INT | 故事ID | NOT NULL, FOREIGN KEY |
| name | VARCHAR(100) | 角色名称 | NOT NULL |
| description | VARCHAR(1000) | 角色描述 | NOT NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `UNIQUE KEY uk_story_name` (story_id, name)
- `idx_story_id` (story_id)

**外键**：
- `FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE`

#### 4.1.7 user_story_favorites（用户故事收藏表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 收藏ID | PRIMARY KEY, AUTO_INCREMENT |
| user_id | INT | 用户ID | NOT NULL, FOREIGN KEY |
| story_id | INT | 故事ID | NOT NULL, FOREIGN KEY |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `UNIQUE KEY uk_user_story` (user_id, story_id)
- `idx_user_id` (user_id)
- `idx_story_id` (story_id)

**外键**：
- `FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE`
- `FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE`

#### 4.1.8 user_story_ratings（用户故事评分表）
| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 评分ID | PRIMARY KEY, AUTO_INCREMENT |
| user_id | INT | 用户ID | NOT NULL, FOREIGN KEY |
| story_id | INT | 故事ID | NOT NULL, FOREIGN KEY |
| rating | INT | 评分(1-5) | NOT NULL, CHECK (rating >= 1 AND rating <= 5) |
| comment | VARCHAR(500) | 评论 | NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**索引**：
- `UNIQUE KEY uk_user_story` (user_id, story_id)
- `idx_user_id` (user_id)
- `idx_story_id` (story_id)
- `idx_rating` (rating)

**外键**：
- `FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE`
- `FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE`

### 4.2 数据库关系图

```
users (用户)
  ├── stories (故事) [1:N]
  │     ├── story_nodes (节点) [1:N]
  │     │     ├── branches (分支) [1:N] (source)
  │     │     └── branches (分支) [1:N] (target)
  │     ├── characters (角色) [1:N]
  │     ├── user_story_favorites (收藏) [1:N]
  │     └── user_story_ratings (评分) [1:N]
  └── categories (分类) [1:N]
        └── stories (故事) [1:N]
```

## 5. API接口设计

### 5.1 认证相关接口

#### 5.1.1 用户注册
- **接口**：`POST /api/v1/auth/register`
- **权限**：公开
- **请求体**：
```json
{
  "username": "string",
  "email": "string",
  "password": "string",
  "confirmPassword": "string"
}
```
- **响应**：
```json
{
  "success": true,
  "message": "注册成功",
  "data": {
    "userId": 1,
    "username": "string",
    "email": "string",
    "avatar": "string",
    "token": "string",
    "refreshToken": "string"
  }
}
```

#### 5.1.2 用户登录
- **接口**：`POST /api/v1/auth/login`
- **权限**：公开
- **请求体**：
```json
{
  "email": "string",
  "password": "string"
}
```
- **响应**：
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "string",
    "email": "string",
    "avatar": "string",
    "role": "user",
    "token": "string",
    "refreshToken": "string"
  }
}
```

#### 5.1.3 Token刷新
- **接口**：`POST /api/v1/auth/refresh`
- **权限**：需要Refresh Token
- **请求头**：`Authorization: Bearer <refreshToken>`
- **响应**：
```json
{
  "success": true,
  "message": "Token刷新成功",
  "data": {
    "token": "string",
    "refreshToken": "string"
  }
}
```

#### 5.1.4 用户登出
- **接口**：`POST /api/v1/auth/logout`
- **权限**：需要登录
- **请求头**：`Authorization: Bearer <token>`
- **响应**：
```json
{
  "success": true,
  "message": "登出成功"
}
```

### 5.2 故事相关接口

#### 5.2.1 获取故事列表
- **接口**：`GET /api/v1/stories`
- **权限**：公开
- **查询参数**：
  - `page`: 页码（默认1）
  - `limit`: 每页数量（默认9，最大50）
  - `category`: 分类名称
  - `search`: 搜索关键词
  - `sort`: 排序方式（latest/popular/rating）
- **响应**：
```json
{
  "success": true,
  "message": "获取故事列表成功",
  "data": {
    "stories": [...],
    "pagination": {
      "page": 1,
      "limit": 9,
      "total": 100,
      "pages": 12
    }
  }
}
```

#### 5.2.2 创建故事
- **接口**：`POST /api/v1/stories`
- **权限**：需要登录
- **请求体**：
```json
{
  "title": "string",
  "description": "string",
  "categoryId": 1,
  "coverImage": "string"
}
```
- **响应**：
```json
{
  "success": true,
  "message": "创建故事成功",
  "data": {
    "id": 1,
    "title": "string",
    ...
  }
}
```

#### 5.2.3 更新故事
- **接口**：`PUT /api/v1/stories/:id`
- **权限**：需要登录，且为故事作者
- **请求体**：同创建故事
- **响应**：同创建故事

#### 5.2.4 获取故事详情
- **接口**：`GET /api/v1/stories/:id`
- **权限**：公开（已发布）或需要登录（作者）
- **响应**：
```json
{
  "success": true,
  "message": "获取故事详情成功",
  "data": {
    "id": 1,
    "title": "string",
    "description": "string",
    "author": {...},
    "category": {...},
    "nodes": [...],
    "branches": [...],
    "characters": [...]
  }
}
```

### 5.3 管理员相关接口

#### 5.3.1 获取统计信息
- **接口**：`GET /api/v1/admin/stats`
- **权限**：需要管理员权限
- **响应**：
```json
{
  "success": true,
  "message": "获取统计信息成功",
  "data": {
    "stories": {
      "total": 100,
      "published": 80,
      "draft": 10,
      "pending": 5,
      "rejected": 5
    },
    "users": {
      "total": 50
    },
    "categories": {
      "total": 10
    },
    "reviews": {
      "today": 5,
      "total": 85
    }
  }
}
```

#### 5.3.2 审核故事
- **接口**：`PUT /api/v1/admin/stories/:id/review`
- **权限**：需要管理员权限
- **请求体**：
```json
{
  "action": "approve" | "reject",
  "reason": "string" // 拒绝时必填
}
```
- **响应**：
```json
{
  "success": true,
  "message": "审核成功"
}
```

#### 5.3.3 重置用户密码
- **接口**：`PUT /api/v1/admin/users/:userId/reset-password`
- **权限**：需要管理员权限
- **响应**：
```json
{
  "success": true,
  "message": "密码重置成功",
  "data": {
    "id": 1,
    "username": "string",
    "email": "string"
  }
}
```

### 5.4 错误响应格式

所有错误响应统一格式：
```json
{
  "success": false,
  "message": "错误描述",
  "errors": [
    {
      "field": "字段名",
      "message": "字段错误信息"
    }
  ],
  "code": 10001,
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

**错误代码**：
- `10001`: 注册失败
- `10002`: 邮箱已存在
- `10003`: 用户名已存在
- `10004`: API端点不存在
- `10005`: 未授权
- `10006`: 邮箱或密码错误
- `10007`: Token过期
- `10008`: Token无效
- `10009`: 权限不足
- `10010`: 资源不存在
- `10011`: 参数错误
- `10012`: 分类不存在
- `10013`: 用户不存在
- `10020`: 操作不允许
- `10034`: 默认分类不存在

## 6. 安全需求

### 6.1 认证安全
- **密码加密**：使用bcrypt加密，salt rounds = 10
- **JWT Token**：使用HS256算法，包含用户ID和Token版本
- **Token过期**：Access Token 1天，Refresh Token 7天
- **Token版本控制**：支持强制登出（通过增加token_version）
- **登录限制**：连续失败5次锁定30分钟
- **账户锁定**：支持管理员禁用/解禁账户

### 6.2 数据安全
- **SQL注入防护**：使用参数化查询（Prepared Statements）
- **XSS防护**：输入验证和输出转义
- **CSRF防护**：使用JWT Token，不依赖Cookie
- **敏感信息**：密码不返回给前端，Token存储在客户端
- **输入验证**：使用express-validator进行输入验证

### 6.3 权限控制
- **路由保护**：使用中间件（authGuard, adminGuard）保护路由
- **资源权限**：用户只能操作自己的资源（故事、节点等）
- **管理员权限**：管理员可以操作所有资源
- **角色验证**：基于角色的访问控制（RBAC）

## 7. 性能需求

### 7.1 响应时间
- **页面加载**：< 3秒
- **API响应**：< 1秒（正常情况）
- **数据库查询**：< 500ms

### 7.2 并发处理
- **数据库连接池**：最大10个连接
- **请求队列**：无限制
- **缓存策略**：使用node-cache缓存故事列表（TTL 5分钟）

### 7.3 优化策略
- **分页加载**：所有列表接口支持分页
- **懒加载**：图片懒加载
- **缓存机制**：故事列表、分类列表缓存
- **索引优化**：数据库表建立合适的索引

## 8. 用户体验需求

### 8.1 界面设计
- **设计风格**：现代化、渐变背景、玻璃态效果
- **色彩方案**：
  - 主色：#6366f1（靛蓝色）
  - 辅助色：#ec4899（粉红色）
  - 背景：渐变色彩
- **响应式设计**：支持桌面端（≥1024px）、平板端（768px-1023px）、移动端（<768px）
- **动画效果**：流畅的过渡动画、悬停效果

### 8.2 交互设计
- **反馈机制**：操作成功/失败提示
- **加载状态**：加载动画、骨架屏
- **错误处理**：友好的错误提示
- **表单验证**：实时验证、错误提示

### 8.3 可访问性
- **语义化HTML**：使用语义化标签
- **键盘导航**：支持键盘操作
- **屏幕阅读器**：支持屏幕阅读器
- **颜色对比度**：符合WCAG标准

## 9. 部署需求

### 9.1 环境要求
- **Node.js**：v14.0.0+
- **MySQL**：8.0+
- **操作系统**：Windows/Linux/macOS

### 9.2 环境变量配置
```env
# 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=story_platform

# JWT配置
JWT_SECRET=your_jwt_secret_min_32_chars
JWT_REFRESH_SECRET=your_refresh_secret_min_32_chars
JWT_EXPIRES_IN=1d
JWT_REFRESH_EXPIRES_IN=7d

# AI服务配置（可选）
DASHSCOPE_API_KEY=your_dashscope_api_key

# 服务器配置
PORT=5000
CLIENT_ORIGIN=http://localhost:5000
```

### 9.3 初始化步骤
1. 安装依赖：`npm install`
2. 配置环境变量：创建`.env`文件
3. 初始化数据库：运行`server.js`自动创建表结构
4. 创建管理员：运行`backend/scripts/createAdmin.js`
5. 启动服务器：`npm start`

## 10. 待实现功能（预留）

### 10.1 第三方登录
- 微信登录
- QQ登录
- 微博登录

### 10.2 高级功能
- 故事导出（PDF、EPUB等格式）
- 故事模板
- 协作编辑（多人同时编辑）
- 故事评论系统
- 用户关注和粉丝系统
- 消息通知系统
- 数据统计分析（更详细的统计图表）

### 10.3 性能优化
- Redis缓存
- CDN加速
- 图片压缩和优化
- 数据库读写分离

## 11. 总结

StoryForge是一个功能完整的AI交互式故事创作平台，涵盖了用户认证、故事创作、故事阅读、作品管理、个人中心和管理后台等核心功能模块。平台采用现代化的技术栈，提供流畅的用户体验和直观的操作界面，支持多分支互动故事的创建和阅读。

**核心特点**：
1. **多分支叙事**：支持创建复杂的分支式互动故事
2. **AI辅助**：利用AI技术辅助故事创作
3. **内容审核**：完善的内容审核机制
4. **用户互动**：收藏、评分等社交功能
5. **权限管理**：完善的用户角色和权限控制
6. **响应式设计**：支持多设备访问

**技术亮点**：
1. **前后端一体化**：Express同时提供API和静态文件服务
2. **JWT认证**：安全的Token认证机制
3. **MySQL数据库**：关系型数据库，保证数据一致性
4. **缓存机制**：提升性能
5. **错误处理**：统一的错误处理格式

该平台为故事创作者提供了一个完整的创作和分享环境，同时为读者提供了丰富的互动阅读体验。
